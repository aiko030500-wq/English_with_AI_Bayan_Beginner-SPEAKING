<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Essay Trainer ‚Äì ENGLISH WITH AI BAYAN</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root{
      /* –§–ò–û–õ–ï–¢–û–í–ê–Ø –¢–ï–ú–ê */
      --violet-main:#6a1b9a;
      --violet-soft:#9c27b0;
      --accent:#ffca28;
      --bg:#f5f3ff;
      --card:#ffffff;
      --text:#2e1342;
      --border:#d1c4e9;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      background:var(--bg);
      color:var(--text);
      min-height:100vh;
    }

    /* --------- LOGIN SCREEN --------- */
    #loginScreen{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:16px;
    }

    .login-card{
      background:var(--card);
      border-radius:20px;
      box-shadow:0 6px 18px rgba(75,0,130,0.25);
      padding:20px 20px 18px;
      max-width:380px;
      width:100%;
      text-align:center;
      border:1px solid var(--border);
    }

    .login-title{
      font-size:1.2rem;
      font-weight:700;
      margin-bottom:6px;
      color:var(--violet-main);
    }

    .login-subtitle{
      font-size:.85rem;
      color:#5e548e;
      margin-bottom:12px;
    }

    .pin-input{
      width:100%;
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 14px;
      font-size:1rem;
      margin:8px 0 10px;
      outline:none;
      text-align:center;
      background:#faf5ff;
    }

    .pin-input:focus{
      border-color:var(--violet-soft);
      box-shadow:0 0 0 2px rgba(156,39,176,0.18);
      background:#fff;
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      padding:8px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:.9rem;
      font-weight:600;
      transition:transform .1s, box-shadow .1s, background .15s;
      white-space:nowrap;
    }

    .btn-primary{
      background:var(--violet-main);
      color:#fff;
      box-shadow:0 3px 8px rgba(74,20,140,0.4);
      margin-top:4px;
      width:100%;
    }

    .btn-primary:hover{
      background:#7b1fa2;
      transform:translateY(-1px);
      box-shadow:0 5px 14px rgba(74,20,140,0.4);
    }

    .login-hint{
      font-size:.75rem;
      color:#6b6491;
      margin-top:8px;
    }

    .login-error{
      font-size:.8rem;
      color:#c62828;
      margin-top:6px;
      min-height:18px;
    }

    .login-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background:#f3e5f5;
      color:#4a148c;
      font-size:.75rem;
      margin-bottom:10px;
    }

    /* --------- APP SCREEN --------- */
    #appScreen{
      display:none;
      min-height:100vh;
      flex-direction:column;
    }

    header{
      background:linear-gradient(90deg,#6a1b9a,#9c27b0);
      color:#fff;
      padding:10px 16px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      box-shadow:0 2px 8px rgba(74,20,140,0.5);
    }

    header h1{
      font-size:1.1rem;
      font-weight:700;
    }

    header span{
      font-size:.82rem;
      opacity:.95;
      display:block;
    }

    .header-right{
      text-align:right;
      font-size:.78rem;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:3px 8px;
      border-radius:999px;
      font-size:.7rem;
      background:rgba(255,202,40,0.16);
      color:#fffde7;
      margin-top:3px;
    }

    main{
      flex:1;
      padding:14px;
      max-width:1240px;
      width:100%;
      margin:0 auto;
    }

    .layout{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
    }

    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:0 2px 8px rgba(0,0,0,0.08);
      padding:12px 14px;
      border:1px solid var(--border);
    }

    .left-panel{
      flex:1 1 250px;
      max-width:270px;
    }

    .middle-panel{
      flex:1 1 320px;
      min-width:280px;
    }

    .right-panel{
      flex:1 1 320px;
      min-width:280px;
    }

    .ai-panel{
      margin-top:14px;
    }

    h2{
      font-size:.98rem;
      margin-bottom:6px;
      display:flex;
      align-items:center;
      gap:6px;
      color:var(--violet-main);
    }

    h2 span.icon{
      font-size:1.1rem;
    }

    label{
      font-size:.8rem;
      font-weight:600;
      margin-bottom:3px;
      display:block;
    }

    select, input[type="text"], textarea{
      width:100%;
      border:1px solid var(--border);
      border-radius:10px;
      padding:7px 9px;
      font-size:.88rem;
      outline:none;
      transition:border-color .2s, box-shadow .2s;
      background:#fbf7ff;
    }

    select:focus, input[type="text"]:focus, textarea:focus{
      border-color:var(--violet-soft);
      box-shadow:0 0 0 2px rgba(156,39,176,0.16);
      background:#fff;
    }

    textarea{
      resize:vertical;
      min-height:60px;
    }

    .small-note{
      font-size:.76rem;
      color:#6b6b96;
      margin:3px 0 6px;
    }

    .btn-ghost{
      background:transparent;
      color:var(--violet-main);
      border:1px dashed var(--border);
    }

    .btn-ghost:hover{
      background:#f3e5f5;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-top:6px;
    }

    .pill-select-row{
      display:flex;
      flex-wrap:wrap;
      gap:5px;
      margin-bottom:6px;
    }

    .pill{
      padding:4px 9px;
      border-radius:999px;
      border:1px solid var(--border);
      font-size:.78rem;
      cursor:pointer;
      background:#faf5ff;
    }

    .pill.active{
      background:var(--accent);
      border-color:#ffb300;
      color:#4e342e;
      font-weight:600;
    }

    .topics-list{
      margin-top:5px;
      font-size:.78rem;
      max-height:120px;
      overflow-y:auto;
      padding-right:3px;
    }

    .topics-list div{
      padding:3px 0;
      border-bottom:1px dashed #ede7f6;
      cursor:pointer;
    }

    .topics-list div:last-child{
      border-bottom:none;
    }

    .topics-list div:hover{
      color:var(--violet-main);
    }

    .section{
      margin-bottom:8px;
    }

    .word-counter{
      display:flex;
      justify-content:space-between;
      align-items:center;
      font-size:.76rem;
      color:#5c5470;
      margin-top:3px;
    }

    .level-indicator{
      font-size:.78rem;
      color:#5c5470;
      margin-top:5px;
    }

    /* --- AI CHAT --- */
    .chat-box{
      border:1px solid var(--border);
      border-radius:12px;
      padding:8px;
      max-height:220px;
      overflow-y:auto;
      background:#faf5ff;
      font-size:.78rem;
    }

    .msg{
      padding:6px 8px;
      border-radius:10px;
      margin-bottom:5px;
      max-width:100%;
      word-wrap:break-word;
    }

    .msg.user{
      background:#e1bee7;
      align-self:flex-end;
    }

    .msg.ai{
      background:#ede7f6;
    }

    .msg.system{
      background:#fff3e0;
      font-style:italic;
      color:#6d4c41;
    }

    .chat-meta{
      font-size:.7rem;
      color:#6b6b96;
      margin-top:4px;
    }

    .limit-ok{
      color:#2e7d32;
    }

    .limit-warning{
      color:#ef6c00;
    }

    .limit-max{
      color:#c62828;
      font-weight:600;
    }

    footer{
      text-align:center;
      font-size:.72rem;
      color:#7b6d9d;
      padding:6px 8px 10px;
    }

    .logout-btn{
      font-size:.8rem;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.7);
      background:rgba(0,0,0,0.08);
      color:#fff;
      cursor:pointer;
    }

    .logout-btn:hover{
      background:rgba(0,0,0,0.18);
    }

    @media (max-width:768px){
      header{
        flex-direction:column;
        align-items:flex-start;
        gap:6px;
      }
      .header-right{
        text-align:left;
      }
    }
  </style>
</head>
<body>

<!-- ---------- LOGIN ---------- -->
<section id="loginScreen">
  <div class="login-card">
    <div class="login-badge">‚ú® ENGLISH WITH AI BAYAN ¬∑ Essay</div>
    <div class="login-title">Essay Trainer + AI Bayan</div>
    <div class="login-subtitle">
      –í–≤–µ–¥–∏—Ç–µ –≤–∞—à PIN-–∫–æ–¥ (–∫–∞–∫ –≤ Beginner).<br/>
      –£—á–∏—Ç–µ–ª—è: 9991 / 9992 / 9999.
    </div>

    <input id="pinInput" class="pin-input" type="number" placeholder="–í–≤–µ–¥–∏—Ç–µ PIN (–Ω–∞–ø—Ä–∏–º–µ—Ä, 601)" />

    <button class="btn btn-primary" id="loginBtn">–í–æ–π—Ç–∏</button>

    <div class="login-error" id="loginError"></div>

    <div class="login-hint">
      –£—á–µ–Ω–∏–∫–∏ ‚Äì PIN –∫–∞–∫ –≤ Beginner:<br/>
      3E: 101‚Äì115 ¬∑ 4G: 201‚Äì215 ¬∑ 5G: 301‚Äì315 ¬∑ 5Zh: 401‚Äì415<br/>
      6G: 501‚Äì515 ¬∑ 7B: 601‚Äì615 ¬∑ 7V: 701‚Äì715 ¬∑ 8E: 801‚Äì815 ¬∑ 9Zh: 901‚Äì915<br/>
      –£—á–∏—Ç–µ–ª—è: 9991 (7B), 9992 (7V), 9999 (Super Teacher).
    </div>
  </div>
</section>

<!-- ---------- APP ---------- -->
<section id="appScreen">
  <header>
    <div>
      <h1>Essay Trainer</h1>
      <span>ENGLISH WITH AI BAYAN ¬∑ Essay writing + AI helper</span>
    </div>
    <div class="header-right">
      <div>üë§ <span id="userInfo">Student</span></div>
      <div class="badge">
        ‚úçÔ∏è Essay + ü§ñ AI Bayan ¬∑ Limit 10 Q/day
      </div>
      <button class="logout-btn" id="logoutBtn">–í—ã–π—Ç–∏</button>
    </div>
  </header>

  <main>
    <div class="layout">
      <!-- LEFT: SETTINGS + TOPICS -->
      <section class="card left-panel">
        <h2><span class="icon">üéØ</span>Essay settings</h2>

        <div class="section">
          <label>Level</label>
          <div class="pill-select-row" id="levelRow">
            <button class="pill active" data-level="7‚Äì8 grade">7‚Äì8 grade</button>
            <button class="pill" data-level="Olympiad">Olympiad</button>
            <button class="pill" data-level="Exam">Exam</button>
          </div>
        </div>

        <div class="section">
          <label for="essayType">Essay type</label>
          <select id="essayType">
            <option value="opinion">Opinion essay (your point of view)</option>
            <option value="forAgainst">For & Against essay</option>
            <option value="argumentative">Argumentative essay</option>
            <option value="descriptive">Descriptive essay</option>
          </select>
          <p class="small-note">
            –¢–∏–ø –º–µ–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ–¥—Å–∫–∞–∑–∫–∏. –°—Ç—Ä—É–∫—Ç—É—Ä—É –º–æ–∂–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å.
          </p>
        </div>

        <div class="section">
          <label for="topicInput">Topic</label>
          <input id="topicInput" type="text"
                  placeholder="The role of sports in students‚Äô lives" />
          <div class="btn-row">
            <button class="btn btn-primary" id="newTopicBtn">üé≤ New topic</button>
            <button class="btn btn-ghost" id="clearTopicBtn">üßπ Clear</button>
          </div>
          <p class="small-note">
            –ù–∞–∂–º–∏ –Ω–∞ —Ç–µ–º—É –Ω–∏–∂–µ ‚Äî –æ–Ω–∞ –≤—Å—Ç–∞–≤–∏—Ç—Å—è –≤ –ø–æ–ª–µ.
          </p>
        </div>

        <div class="section">
          <label>Suggested topics (7‚Äì8 grade)</label>
          <div class="topics-list" id="topicsList"></div>
        </div>
      </section>

      <!-- MIDDLE: PLAN -->
      <section class="card middle-panel">
        <h2><span class="icon">üß©</span>Essay plan</h2>
        <p class="small-note">
          –ù–∞–ø–∏—à–∏ –ø–æ 1‚Äì3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —á–∞—Å—Ç–∏, –ø–æ—Ç–æ–º —Å–æ–±–µ—Ä–∏ —ç—Å—Å–µ.
        </p>

        <div class="section">
          <label for="introInput">Introduction</label>
          <textarea id="introInput"
            placeholder="Introduce the topic and give a general opinion. Example: Nowadays, sports play an important role in students‚Äô lives. In my opinion, ...">
          </textarea>
        </div>

        <div class="section">
          <label for="body1Input">Body paragraph 1 (Argument 1)</label>
          <textarea id="body1Input"
            placeholder="Main idea + explanation + example. Use: Firstly, To begin with, One important reason is that...">
          </textarea>
        </div>

        <div class="section">
          <label for="body2Input">Body paragraph 2 (Argument 2)</label>
          <textarea id="body2Input"
            placeholder="Second reason + explanation + example. Use: Secondly, Moreover, Another important point is that...">
          </textarea>
        </div>

        <div class="section">
          <label for="conclusionInput">Conclusion</label>
          <textarea id="conclusionInput"
            placeholder="Summarise your ideas and repeat opinion in other words. Use: In conclusion, To sum up, All in all...">
          </textarea>
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="buildEssayBtn">‚ú® Build draft essay</button>
          <button class="btn btn-ghost" id="clearPlanBtn">üßπ Clear plan</button>
        </div>
      </section>

      <!-- RIGHT: FINAL ESSAY -->
      <section class="card right-panel">
        <h2><span class="icon">‚úèÔ∏è</span>Final essay</h2>
        <p class="small-note">
          –ó–¥–µ—Å—å —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π –≥–æ—Ç–æ–≤–æ–µ —ç—Å—Å–µ. –°—á—ë—Ç—á–∏–∫ —Å–ª–æ–≤ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
        </p>

        <textarea id="finalEssay"
          placeholder="Your full essay will appear here after you click ‚ÄúBuild draft essay‚Äù. You can edit it, add linking words, improve vocabulary, etc.">
        </textarea>

        <div class="word-counter">
          <span id="wordCount">Words: 0</span>
          <span id="wordAdvice">Target: 120‚Äì150 words for 7‚Äì8 grade</span>
        </div>

        <div class="level-indicator" id="levelHint">
          Current level: <b>7‚Äì8 grade</b> ¬∑ Good length for school & small olympiads: <b>120‚Äì150 words</b>.
        </div>

        <div class="btn-row" style="margin-top:6px;">
          <button class="btn btn-ghost" id="clearEssayBtn">üßπ Clear essay</button>
          <button class="btn btn-ghost" id="copyEssayBtn">üìã Copy</button>
          <button class="btn btn-primary" id="printBtn">üñ®Ô∏è Print</button>
        </div>
      </section>
    </div>

    <!-- AI BAYAN PANEL -->
    <section class="card ai-panel">
      <h2><span class="icon">ü§ñ</span>AI Bayan ‚Äì Essay helper</h2>
      <p class="small-note">
        –ó–∞–¥–∞–≤–∞–π –≤–æ–ø—Ä–æ—Å—ã –ø–æ –ª–µ–∫—Å–∏–∫–µ, –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —ç—Å—Å–µ. –õ–∏–º–∏—Ç: <b>10 –≤–æ–ø—Ä–æ—Å–æ–≤ –≤ –¥–µ–Ω—å</b> –Ω–∞ –æ–¥–∏–Ω PIN.
      </p>

      <div id="chatBox" class="chat-box"></div>

      <textarea id="aiQuestion"
        placeholder="Ask AI Bayan about your essay: ‚ÄúCan you suggest a better introduction?‚Äù, ‚ÄúHow to say this in English?‚Äù">
      </textarea>

      <div class="btn-row">
        <button class="btn btn-primary" id="askBtn">Ask AI Bayan</button>
        <button class="btn btn-ghost" id="clearChatBtn">üßπ Clear chat</button>
      </div>

      <div class="chat-meta" id="aiLimitText">
        Login with your PIN to see the limit.
      </div>
    </section>

    <!-- TEACHER MODE PANEL -->
    <section id="teacherPanel" class="card" style="display:none; margin-top:14px;">
      <h2><span class="icon">üë©‚Äçüè´</span>Teacher Mode ‚Äì Student Essays Today</h2>
      <p class="small-note">–í—Å–µ —ç—Å—Å–µ, –∫–æ—Ç–æ—Ä—ã–µ —É—á–µ–Ω–∏–∫–∏ –ø–∏—Å–∞–ª–∏ —Å–µ–≥–æ–¥–Ω—è (—Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ).</p>

      <div id="teacherList" style="max-height:300px; overflow-y:auto; font-size:.85rem;"></div>
    </section>
  </main>

  <footer>
    Essay Trainer + AI Bayan ¬∑ Violet edition ¬∑ PIN system like Beginner
  </footer>
</section>

<script>
  /* ---------- PIN RANGES (–∫–∞–∫ –≤ Beginner) ---------- */
  const classRanges = [
    { cls: "3E",  from: 101, to: 115 },
    { cls: "4G",  from: 201, to: 215 },
    { cls: "5G",  from: 301, to: 315 },
    { cls: "5Zh", from: 401, to: 415 },
    { cls: "6G",  from: 501, to: 515 },
    { cls: "7B",  from: 601, to: 615 },
    { cls: "7V",  from: 701, to: 715 },
    { cls: "8E",  from: 801, to: 815 },
    { cls: "9Zh", from: 901, to: 915 }
  ];

  /* ---- TEACHER MODE PINS ---- */
  const teacherPins = {
    9991: "Teacher 7B",
    9992: "Teacher 7V",
    9999: "Super Teacher"
  };

  let currentUser = null; // {pin, cls, teacher?}

  const loginScreen = document.getElementById("loginScreen");
  const appScreen = document.getElementById("appScreen");
  const pinInput = document.getElementById("pinInput");
  const loginBtn = document.getElementById("loginBtn");
  const loginError = document.getElementById("loginError");
  const userInfo = document.getElementById("userInfo");
  const logoutBtn = document.getElementById("logoutBtn");
  const teacherPanel = document.getElementById("teacherPanel");

  function findClassByPin(pin){
    for(const range of classRanges){
      if(pin >= range.from && pin <= range.to){
        return range.cls;
      }
    }
    return null;
  }

  function showScreen(name){
    if(name === "login"){
      loginScreen.style.display = "flex";
      appScreen.style.display = "none";
    }else{
      loginScreen.style.display = "none";
      appScreen.style.display = "flex";
    }
  }

  function handleLogin(){
    const pinVal = parseInt(pinInput.value.trim(), 10);
    if(isNaN(pinVal)){
      loginError.textContent = "–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π PIN.";
      return;
    }

    // ---- TEACHER MODE ----
    if(teacherPins[pinVal]){
      currentUser = { pin: pinVal, cls: teacherPins[pinVal], teacher: true };
      userInfo.textContent = teacherPins[pinVal] + " ¬∑ PIN " + pinVal;
      loginError.textContent = "";
      pinInput.value = "";
      showScreen("app");
      initAiLimitText();
      openTeacherPanel();
      return;
    }

    const cls = findClassByPin(pinVal);
    if(!cls){
      loginError.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π PIN. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω.";
      return;
    }

    currentUser = { pin: pinVal, cls, teacher:false };
    userInfo.textContent = cls + " ¬∑ PIN " + pinVal;
    loginError.textContent = "";
    pinInput.value = "";
    teacherPanel.style.display = "none";
    showScreen("app");
    initAiLimitText();
  }

  loginBtn.addEventListener("click", handleLogin);
  pinInput.addEventListener("keydown", (e) => {
    if(e.key === "Enter"){
      handleLogin();
    }
  });

  logoutBtn.addEventListener("click", () => {
    currentUser = null;
    teacherPanel.style.display = "none";
    showScreen("login");
    initAiLimitText();
  });

  /* ---------- ESSAY TRAINER DATA & ELEMENTS ---------- */
  const topics = [
    "The role of sports in students‚Äô lives",
    "Why is reading still important for teenagers?",
    "Are phones useful or distracting at school?",
    "What makes a good friend?",
    "Should students have homework every day?",
    "Should school start later in the morning?",
    "Is it important for teenagers to learn foreign languages?",
    "The impact of social media on students",
    "What can students do to protect the environment?",
    "Why is teamwork important at school?"
  ];

  const topicsListEl = document.getElementById("topicsList");
  const topicInput = document.getElementById("topicInput");
  const newTopicBtn = document.getElementById("newTopicBtn");
  const clearTopicBtn = document.getElementById("clearTopicBtn");
  const essayTypeSelect = document.getElementById("essayType");

  const introInput = document.getElementById("introInput");
  const body1Input = document.getElementById("body1Input");
  const body2Input = document.getElementById("body2Input");
  const conclusionInput = document.getElementById("conclusionInput");

  const buildEssayBtn = document.getElementById("buildEssayBtn");
  const clearPlanBtn = document.getElementById("clearPlanBtn");

  const finalEssay = document.getElementById("finalEssay");
  const wordCountEl = document.getElementById("wordCount");
  const wordAdviceEl = document.getElementById("wordAdvice");
  const clearEssayBtn = document.getElementById("clearEssayBtn");
  const copyEssayBtn = document.getElementById("copyEssayBtn");
  const printBtn = document.getElementById("printBtn");

  const levelRow = document.getElementById("levelRow");
  const levelHint = document.getElementById("levelHint");

  function renderTopics(){
    topicsListEl.innerHTML = "";
    topics.forEach(t => {
      const div = document.createElement("div");
      div.textContent = "‚Ä¢ " + t;
      div.addEventListener("click", () => {
        topicInput.value = t;
      });
      topicsListEl.appendChild(div);
    });
  }

  function setRandomTopic(){
    const index = Math.floor(Math.random() * topics.length);
    topicInput.value = topics[index];
  }

  clearTopicBtn.addEventListener("click", () => {
    topicInput.value = "";
  });

  newTopicBtn.addEventListener("click", setRandomTopic);

  function buildDraftEssay(){
    const topicText = topicInput.value.trim();
    const type = essayTypeSelect.value;

    let intro = introInput.value.trim();
    let body1 = body1Input.value.trim();
    let body2 = body2Input.value.trim();
    let conclusion = conclusionInput.value.trim();

    if(!intro && topicText){
      if(type === "opinion"){
        intro = `Nowadays, the topic of "${topicText}" is very important for many students. In my opinion, this question plays a big role in our lives.`;
      }else if(type === "forAgainst"){
        intro = `There are different opinions about "${topicText}". Some people agree with this idea, while others are against it.`;
      }else{
        intro = `The topic "${topicText}" is often discussed by teachers and students. It is important to understand its advantages and disadvantages.`;
      }
    }

    if(!body1){
      body1 = "Firstly, there are several strong reasons that support this point of view. For example, many students say that it helps them develop important skills.";
    }

    if(!body2){
      body2 = "Secondly, this idea can also influence students' future life. It may teach them responsibility, independence and cooperation with other people.";
    }

    if(!conclusion){
      conclusion = "In conclusion, this topic has both positive and negative sides. However, I believe that its advantages are more significant for students‚Äô development.";
    }

    const parts = [intro, body1, body2, conclusion].filter(Boolean);
    finalEssay.value = parts.join("\n\n");
    updateWordCount();
  }

  buildEssayBtn.addEventListener("click", buildDraftEssay);

  clearPlanBtn.addEventListener("click", () => {
    introInput.value = "";
    body1Input.value = "";
    body2Input.value = "";
    conclusionInput.value = "";
  });

  function countWords(text){
    return text
      .trim()
      .split(/\s+/)
      .filter(w => w.length > 0).length;
  }

  function getCurrentLevel(){
    const active = levelRow.querySelector(".pill.active");
    return active ? active.dataset.level : "7‚Äì8 grade";
  }

  function updateWordCount(){
    const words = countWords(finalEssay.value);
    wordCountEl.textContent = "Words: " + words;

    const levelText = getCurrentLevel();
    let advice;
    if(levelText === "7‚Äì8 grade"){
      advice = "Target: 120‚Äì150 words for 7‚Äì8 grade";
    }else if(levelText === "Olympiad"){
      advice = "Target: 180‚Äì220 words for school/oblast olympiad";
    }else{
      advice = "Target: 200‚Äì250 words for exam practice";
    }
    wordAdviceEl.textContent = advice;
  }

  finalEssay.addEventListener("input", () => {
    updateWordCount();
    saveEssayForTeacher();
  });

  clearEssayBtn.addEventListener("click", () => {
    finalEssay.value = "";
    updateWordCount();
    saveEssayForTeacher();
  });

  copyEssayBtn.addEventListener("click", async () => {
    try{
      await navigator.clipboard.writeText(finalEssay.value);
      copyEssayBtn.textContent = "‚úÖ Copied";
      setTimeout(() => copyEssayBtn.textContent = "üìã Copy", 1500);
    }catch(e){
      alert("Cannot copy automatically. Please select text and copy manually.");
    }
  });

  /* ---------- PRINT ESSAY ---------- */
  printBtn.addEventListener("click", () => {
    const content = finalEssay.value.replace(/\n/g, "<br/>");
    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
      <html>
      <head>
        <title>Print Essay</title>
        <style>
          body{
            font-family: system-ui, sans-serif;
            padding: 20px;
            line-height: 1.6;
            font-size: 16px;
          }
        </style>
      </head>
      <body>${content}</body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  });

  levelRow.addEventListener("click", (e) => {
    const pill = e.target.closest(".pill");
    if(!pill) return;
    levelRow.querySelectorAll(".pill").forEach(p => p.classList.remove("active"));
    pill.classList.add("active");

    const level = pill.dataset.level;
    if(level === "7‚Äì8 grade"){
      levelHint.innerHTML = 'Current level: <b>7‚Äì8 grade</b> ¬∑ Good length: <b>120‚Äì150 words</b>.';
    }else if(level === "Olympiad"){
      levelHint.innerHTML = 'Current level: <b>Olympiad</b> ¬∑ Good length: <b>180‚Äì220 words</b>. Use stronger vocabulary and more complex sentences.';
    }else{
      levelHint.innerHTML = 'Current level: <b>Exam practice</b> ¬∑ Good length: <b>200‚Äì250 words</b>. Focus on clear structure and linking words.';
    }
    updateWordCount();
  });

  essayTypeSelect.addEventListener("change", () => {
    const type = essayTypeSelect.value;
    if(type === "opinion"){
      introInput.placeholder =
        "Introduce the topic + give your opinion.\nExample: Nowadays, ... In my opinion, ...";
      body1Input.placeholder =
        "Argument 1 FOR your opinion + explanation + example.\nUse: Firstly, To begin with...";
      body2Input.placeholder =
        "Argument 2 FOR your opinion + explanation + example.\nUse: Secondly, Moreover...";
      conclusionInput.placeholder =
        "Repeat your opinion in other words + final thought.\nUse: In conclusion, I strongly believe that...";
    }else if(type === "forAgainst"){
      introInput.placeholder =
        "Introduce the topic and say there are different opinions.\nExample: Some people think..., while others say...";
      body1Input.placeholder =
        "Arguments FOR the idea.\nUse: On the one hand, Firstly...";
      body2Input.placeholder =
        "Arguments AGAINST the idea.\nUse: On the other hand, However...";
      conclusionInput.placeholder =
        "Summarise both sides + your own opinion.\nUse: To sum up, In my view...";
    }else if(type === "argumentative"){
      introInput.placeholder =
        "Introduce the problem + short background.\nExample: There is a strong debate about...";
      body1Input.placeholder =
        "Strong argument 1 with example.\nUse: Firstly, The main reason is that...";
      body2Input.placeholder =
        "Strong argument 2 + maybe counter-argument.\nUse: Secondly, In addition, Some people claim that..., but...";
      conclusionInput.placeholder =
        "Summarise your arguments + final message.\nUse: Therefore, I am convinced that...";
    }else{
      introInput.placeholder =
        "Introduce the topic you describe.\nExample: My favourite place/activity/person is...";
      body1Input.placeholder =
        "Describe appearance / main features.\nUse many adjectives.";
      body2Input.placeholder =
        "Describe feelings, atmosphere or reasons why it is important.";
      conclusionInput.placeholder =
        "Short final impression.\nUse: In conclusion, That is why this is special for me.";
    }
  });

  /* ---------- AI BAYAN CHAT WITH LIMIT 10 / DAY ---------- */
  const chatBox = document.getElementById("chatBox");
  const aiQuestion = document.getElementById("aiQuestion");
  const askBtn = document.getElementById("askBtn");
  const clearChatBtn = document.getElementById("clearChatBtn");
  const aiLimitText = document.getElementById("aiLimitText");

  const AI_LIMIT_PER_DAY = 10;
  const WORKER_URL = "https://shiny-tree-f78c.aiko030500.workers.dev/";

  function getTodayStr(){
    return new Date().toISOString().slice(0,10); // YYYY-MM-DD
  }

  function getAiUsage(){
    if(!currentUser) return {count:0, key:null};
    const key = "essay_ai_usage_" + currentUser.pin + "_" + getTodayStr();
    const raw = localStorage.getItem(key);
    let val = 0;
    if(raw){
      const n = parseInt(raw,10);
      if(!isNaN(n)) val = n;
    }
    return {key, count:val};
  }

  function setAiUsage(count){
    if(!currentUser) return;
    const usage = getAiUsage();
    if(!usage.key) return;
    localStorage.setItem(usage.key, String(count));
  }

  function initAiLimitText(){
    if(!currentUser){
      aiLimitText.textContent = "Login with your PIN to use AI Bayan (10 questions per day).";
      return;
    }
    const usage = getAiUsage().count;
    const left = Math.max(0, AI_LIMIT_PER_DAY - usage);
    if(usage >= AI_LIMIT_PER_DAY){
      aiLimitText.innerHTML =
        `<span class="limit-max">You have used all ${AI_LIMIT_PER_DAY} questions for today.</span>`;
    }else if(left <= 3){
      aiLimitText.innerHTML =
        `<span class="limit-warning">Questions today: ${usage}/${AI_LIMIT_PER_DAY}. Only ${left} left.</span>`;
    }else{
      aiLimitText.innerHTML =
        `<span class="limit-ok">Questions today: ${usage}/${AI_LIMIT_PER_DAY}. Keep practising wisely.</span>`;
    }
  }

  function appendMessage(text, type){
    const div = document.createElement("div");
    div.className = "msg " + type;
    div.textContent = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  async function sendToAiBayan(){
    if(!currentUser){
      alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –ø–æ PIN.");
      return;
    }
    const question = aiQuestion.value.trim();
    if(!question){
      return;
    }

    const usageData = getAiUsage();
    if(usageData.count >= AI_LIMIT_PER_DAY){
      initAiLimitText();
      appendMessage("Daily limit reached (10 questions). Try again tomorrow.", "system");
      return;
    }

    appendMessage("You: " + question, "user");
    aiQuestion.value = "";

    const thinkingMsg = document.createElement("div");
    thinkingMsg.className = "msg system";
    thinkingMsg.textContent = "AI Bayan is thinking...";
    chatBox.appendChild(thinkingMsg);
    chatBox.scrollTop = chatBox.scrollHeight;

    try{
      const payload = {
        question,
        pin: currentUser.pin,
        cls: currentUser.cls,
        app: "EssayTrainer"
      };

      const response = await fetch(WORKER_URL, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      chatBox.removeChild(thinkingMsg);

      if(!response.ok){
        appendMessage("Error from AI Bayan. Please try again later.", "system");
        return;
      }

      let answer = "";
      // –ø—Ä–æ–±—É–µ–º –∫–∞–∫ JSON
      let data = null;
      try{
        data = await response.json();
      }catch(_){
        data = null;
      }

      if(data && (data.answer || data.reply || data.result)){
        answer = data.answer || data.reply || data.result;
      }else{
        // –µ—Å–ª–∏ –≤–æ—Ä–∫–µ—Ä –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
        const text = data ? "" : await response.text();
        answer = text || "AI Bayan sent an empty reply.";
      }

      appendMessage(answer, "ai");

      // —É—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç ‚Äî —É–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫
      const newCount = usageData.count + 1;
      setAiUsage(newCount);
      initAiLimitText();
    }catch(err){
      console.error(err);
      chatBox.removeChild(thinkingMsg);
      appendMessage("Connection error. Please check internet or try again later.", "system");
    }
  }

  askBtn.addEventListener("click", sendToAiBayan);

  aiQuestion.addEventListener("keydown", (e) => {
    if(e.key === "Enter" && !e.shiftKey){
      e.preventDefault();
      sendToAiBayan();
    }
  });

  clearChatBtn.addEventListener("click", () => {
    chatBox.innerHTML = "";
  });

  /* ---------- SAVE ESSAY FOR TEACHER MODE ---------- */
  function saveEssayForTeacher(){
    if(!currentUser || currentUser.teacher) return;

    const data = {
      pin: currentUser.pin,
      cls: currentUser.cls,
      topic: topicInput.value,
      essay: finalEssay.value,
      words: countWords(finalEssay.value),
      date: getTodayStr()
    };

    const key = "essay_saved_" + currentUser.pin + "_" + getTodayStr();
    localStorage.setItem(key, JSON.stringify(data));
  }

  /* ---------- TEACHER MODE ---------- */
  function openTeacherPanel(){
    teacherPanel.style.display = "block";
    loadTeacherData();
  }

  function loadTeacherData(){
    const container = document.getElementById("teacherList");
    container.innerHTML = "";

    const today = getTodayStr();

    for(let i=0; i<localStorage.length; i++){
      const key = localStorage.key(i);

      if(key.startsWith("essay_saved_") && key.includes(today)){
        const dataStr = localStorage.getItem(key);
        if(!dataStr) continue;
        let data;
        try{
          data = JSON.parse(dataStr);
        }catch(_){
          continue;
        }
        const div = document.createElement("div");
        div.style.padding = "8px 0";
        div.style.borderBottom = "1px dashed #d1c4e9";

        div.innerHTML = `
          <b>PIN ${data.pin}</b> ¬∑ Class: ${data.cls}<br>
          <b>Topic:</b> ${data.topic || "(no topic)"}<br>
          <b>Words:</b> ${data.words}<br>
          <b>Essay:</b><br>${(data.essay || "").replace(/\n/g,"<br>")}
        `;

        container.appendChild(div);
      }
    }

    if(container.innerHTML.trim() === ""){
      container.innerHTML = "<em>No essays today.</em>";
    }
  }

  /* ---------- INIT ---------- */
  renderTopics();
  setRandomTopic();
  updateWordCount();
  initAiLimitText();
  showScreen("login");
</script>
</body>
</html>
