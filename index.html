<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì Grade 7 Grammar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      /* –ê—Ä–±—É–∑–Ω—ã–π —Å—Ç–∏–ª—å ‚Äî –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –ø–æ–¥–ø—Ä–∞–≤–∏—Ç—å */
      --watermelon-dark:#c62828;
      --watermelon-soft:#ff8a80;
      --green-soft:#c8e6c9;
      --bg:#fff7f7;
      --card:#ffffff;
      --text:#341111;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      background:var(--bg);
      color:var(--text);
    }

    header{
      background:linear-gradient(90deg,var(--watermelon-dark),var(--watermelon-soft));
      color:#fff;
      padding:12px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
      position:sticky;
      top:0;
      z-index:10;
    }

    header .title-block{
      display:flex;
      flex-direction:column;
    }

    header h1{
      font-size:1.2rem;
      letter-spacing:0.04em;
    }

    header span{
      font-size:0.8rem;
      opacity:0.9;
    }

    #userInfo{
      font-size:0.8rem;
      text-align:right;
    }

    main{
      max-width:1200px;
      margin:16px auto 32px;
      padding:0 12px;
    }

    .screen{
      display:none;
    }

    .screen.active{
      display:block;
    }

    /* LOGIN CARD */
    .card{
      background:var(--card);
      padding:18px;
      border-radius:14px;
      box-shadow:0 2px 10px rgba(0,0,0,0.12);
      max-width:420px;
      margin:32px auto;
    }

    .card h2{
      margin-bottom:10px;
      color:var(--watermelon-dark);
    }

    .card p{
      font-size:0.9rem;
      margin-bottom:10px;
    }

    label{
      display:block;
      font-size:0.85rem;
      margin:8px 0 4px;
    }

    input[type="text"],
    input[type="number"]{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #e0b3b3;
      outline:none;
    }

    input:focus{
      border-color:var(--watermelon-dark);
      box-shadow:0 0 0 1px rgba(198,40,40,0.25);
    }

    .btn{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:8px 18px;
      font-size:0.9rem;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }

    .btn-primary{
      background:var(--watermelon-dark);
      color:#fff;
    }

    .btn-ghost{
      background:transparent;
      color:var(--watermelon-dark);
    }

    .btn:active{
      transform:scale(0.97);
    }

    .btn-row{
      margin-top:14px;
      display:flex;
      gap:8px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    .hint{
      font-size:0.78rem;
      opacity:0.8;
      margin-top:4px;
    }

    /* LAYOUT: STUDENT VIEW */
    .layout{
      display:grid;
      grid-template-columns:minmax(0,1.1fr) minmax(0,1.2fr);
      gap:16px;
    }

    @media(max-width:900px){
      .layout{
        grid-template-columns:1fr;
      }
    }

    .panel{
      background:var(--card);
      border-radius:14px;
      padding:14px;
      box-shadow:0 2px 10px rgba(0,0,0,0.12);
    }

    .panel h2{
      font-size:1.05rem;
      margin-bottom:8px;
      color:var(--watermelon-dark);
    }

    .module-badge{
      display:inline-block;
      background:var(--green-soft);
      padding:3px 9px;
      border-radius:999px;
      font-size:0.75rem;
      margin-bottom:8px;
    }

    .topic-list{
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:420px;
      overflow:auto;
      padding-right:6px;
    }

    .topic-card{
      border-radius:12px;
      padding:10px 11px;
      background:#ffecec;
      cursor:pointer;
      border:1px solid transparent;
    }

    .topic-card:hover{
      border-color:var(--watermelon-soft);
      background:#ffe1e1;
    }

    .topic-card.active{
      border-color:var(--watermelon-dark);
      box-shadow:0 0 0 1px rgba(198,40,40,0.3);
    }

    .topic-title{
      font-size:0.92rem;
      font-weight:600;
    }

    .topic-sub{
      font-size:0.78rem;
      opacity:0.9;
    }

    /* TOPIC DETAILS */
    .topic-details h3{
      margin-bottom:6px;
    }

    .rule-block{
      margin-top:8px;
      background:#fff7f2;
      border-left:4px solid var(--watermelon-soft);
      padding:8px 10px;
      font-size:0.86rem;
    }

    .rule-block b{
      color:#b71c1c;
    }

    .formula-block{
      margin-top:8px;
      background:#f4ffe8;
      border-left:4px solid #8bc34a;
      padding:8px 10px;
      font-size:0.86rem;
    }

    .ex-block{
      margin-top:10px;
      background:#eef7ff;
      border-left:4px solid #42a5f5;
      padding:8px 10px;
      font-size:0.86rem;
    }

    .star-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:10px;
      font-size:0.86rem;
    }

    .star-count{
      font-weight:600;
      color:#b71c1c;
    }

    /* AI PANEL */
    #aiPanel{
      margin-top:10px;
      border-radius:12px;
      border:1px dashed #ffcdd2;
      padding:10px;
      background:#fffafa;
      font-size:0.86rem;
    }

    #chatBox{
      border-radius:8px;
      border:1px solid #ffcdd2;
      padding:6px;
      height:150px;
      overflow-y:auto;
      background:#fff;
      margin-bottom:6px;
      font-size:0.82rem;
    }

    .chat-msg{
      margin-bottom:4px;
    }

    .chat-msg.me{
      text-align:right;
      font-weight:500;
    }

    #aiQuestion{
      width:100%;
      min-height:50px;
      max-height:100px;
      resize:vertical;
      border-radius:8px;
      border:1px solid #ffcdd2;
      padding:6px 8px;
      font-size:0.86rem;
      outline:none;
    }

    #aiQuestion:focus{
      border-color:var(--watermelon-dark);
      box-shadow:0 0 0 1px rgba(198,40,40,0.25);
    }

    .small{
      font-size:0.78rem;
      opacity:0.85;
    }

    /* TEACHER VIEW */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:0.82rem;
      margin-top:8px;
    }

    th,td{
      padding:6px 4px;
      border-bottom:1px solid #f2bdbd;
      text-align:left;
    }

    th{
      background:#ffe5e5;
    }

    .pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#fce4ec;
      font-size:0.7rem;
    }
  </style>
</head>
<body>

<header>
  <div class="title-block">
    <h1>ENGLISH WITH AI BAYAN ‚Äì Grade 7 Grammar</h1>
    <span>Modules 1‚Äì3 ‚Ä¢ Grammar B ‚Ä¢ Watermelon Edition üçâ</span>
  </div>
  <div id="userInfo">
    <div id="userRole">Not logged in</div>
    <div id="userName"></div>
  </div>
</header>

<main>
  <!-- LOGIN SCREEN -->
  <section id="loginScreen" class="screen active">
    <div class="card">
      <h2>Login</h2>
      <p>Enter your <b>name</b> and <b>PIN</b> to start learning grammar with AI Bayan.</p>

      <label for="loginName">Name</label>
      <input id="loginName" type="text" placeholder="Example: –°—ã—Ä—ã–º7–ë" />

      <label for="loginPin">PIN</label>
      <input id="loginPin" type="number" placeholder="4-digit PIN" />

      <div class="hint">
        ‚Ä¢ Students: class PIN<br>
        ‚Ä¢ Teacher: teacher PIN
      </div>

      <div class="btn-row">
        <button class="btn btn-ghost" type="button" onclick="clearLogin()">Clear</button>
        <button class="btn btn-primary" type="button" onclick="handleLogin()">Enter</button>
      </div>
    </div>
  </section>

  <!-- STUDENT SCREEN -->
  <section id="studentScreen" class="screen">
    <div class="layout">
      <div class="panel">
        <h2>Topics ‚Äì Modules 1‚Äì3</h2>
        <div class="small">Tap a topic to see full rules and exercises.</div>
        <div class="topic-list" id="topicList"></div>
      </div>

      <div class="panel">
        <div id="topicDetails" class="topic-details">
          <div class="small">Choose a topic on the left to see the explanation.</div>
        </div>

        <div id="aiPanel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
            <b>AI Bayan ‚Äì Grammar Chat</b>
            <span class="pill">beta</span>
          </div>
          <div class="small">
            Ask 1‚Äì2 short grammar questions per day (English or Russian).
          </div>

          <div id="chatBox"></div>

          <textarea id="aiQuestion"
                    placeholder="Write your question for AI Bayan (for example: ‚ÄúExplain Past Simple vs Past Continuous‚Äù)."></textarea>
          <div class="btn-row" style="justify-content:flex-end;margin-top:6px;">
            <button class="btn btn-primary" type="button" onclick="sendToAi()">Ask AI Bayan</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TEACHER SCREEN -->
  <section id="teacherScreen" class="screen">
    <div class="panel">
      <h2>Teacher Journal ‚Äì Overview</h2>
      <p class="small">
        This simple journal shows <b>students</b> who logged in and their <b>star progress</b> for topics.
        Data is stored in this browser (localStorage).
      </p>

      <table id="teacherTable">
        <thead>
          <tr>
            <th>Student</th>
            <th>Stars</th>
            <th>Last topic</th>
            <th>Last login</th>
          </tr>
        </thead>
        <tbody>
          <!-- filled by JS -->
        </tbody>
      </table>
    </div>
  </section>
</main>

<script>
/* ----------- CONFIG ----------- */

// Teacher and student PINs
const TEACHER_PIN = "3244";
const STUDENT_PIN = "2844";

// Allowed student names from your journal
const allowedStudents = [
  "–°—ã—Ä—ã–º7–ë","–°–∞–º–∏—Ä7–ë","–û—Ä–¥–∞7–û","–†—É—Å–ª–∞–Ω7–í","–†—É—Å–ª–∞–Ω7–ò",
  "–ú–∞–∫—Å—É—Ç7–°","–ê–¥–µ–ª–∏–Ω–∞7–ú","–≠–ª—å–Ω–æ—Ä–∞7–ê","–õ—É–Ω–∞—Ä–∞7–ê",
  "–ú–∞–∫—Å–∏–º7–ú","–†–∏–Ω–∞—Ç7–¶","–ê—Ä—Ç–µ–º7–ê","–ë7–ê"
];

// Topic data: Modules 1‚Äì3, Grammar B
const topics = [
  /* MODULE 1 */
  {
    id:1,
    module:"Module 1",
    short:"Present Simple",
    title:"Present Simple ‚Äì habits, facts, timetables",
    ruleEn:`
      <b>Use Present Simple to talk about:</b><br>
      ‚Ä¢ habits and routines: <i>I get up at 7 a.m.</i><br>
      ‚Ä¢ permanent situations: <i>She lives in Astana.</i><br>
      ‚Ä¢ general facts: <i>Water boils at 100¬∞C.</i><br>
      ‚Ä¢ timetables and schedules: <i>The lesson starts at 8 o‚Äôclock.</i>
    `,
    ruleRu:`
      <b>–ò—Å–ø–æ–ª—å–∑—É–µ–º Present Simple, –∫–æ–≥–¥–∞ –≥–æ–≤–æ—Ä–∏–º:</b><br>
      ‚Ä¢ –æ –ø—Ä–∏–≤—ã—á–∫–∞—Ö –∏ —Ä–µ–∂–∏–º–µ: <i>–Ø –≤—Å—Ç–∞—é –≤ 7 —É—Ç—Ä–∞.</i><br>
      ‚Ä¢ –æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö: <i>–û–Ω–∞ –∂–∏–≤—ë—Ç –≤ –ê—Å—Ç–∞–Ω–µ.</i><br>
      ‚Ä¢ –æ —Ñ–∞–∫—Ç–∞—Ö: <i>–í–æ–¥–∞ –∫–∏–ø–∏—Ç –ø—Ä–∏ 100¬∞C.</i><br>
      ‚Ä¢ –æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è—Ö: <i>–£—Ä–æ–∫ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –≤ 8.</i>
    `,
    formula:`
      (+) I/You/We/They + V1<br>
      (+) He/She/It + V1+s/es<br><br>
      (-) I/You/We/They + don‚Äôt + V1<br>
      (-) He/She/It + doesn‚Äôt + V1<br><br>
      (?) Do + I/you/we/they + V1?<br>
      (?) Does + he/she/it + V1?
    `,
    ex1:`
      <b>SB-style Exercise 1 ‚Äì Complete the sentences (Present Simple)</b><br>
      1) She ___ (go) to school at 8.<br>
      2) We ___ (not/watch) TV on weekdays.<br>
      3) Does your sister ___ (like) English?<br>
      4) They ___ (walk) to school every day.
    `,
    ex2:`
      <b>SB-style Exercise 2 ‚Äì Choose the correct option</b><br>
      1) He <b>go / goes</b> to bed early.<br>
      2) Do they <b>watch / watches</b> TV every day?<br>
      3) My friend <b>doesn‚Äôt / don‚Äôt</b> eat breakfast.<br>
      4) I <b>study / studies</b> English at school.
    `
  },
  {
    id:2,
    module:"Module 1",
    short:"Adverbs of Frequency",
    title:"Adverbs of Frequency ‚Äì always, usually, often, sometimes, never",
    ruleEn:`
      <b>Adverbs of frequency tell how often something happens.</b><br>
      ‚Ä¢ before the main verb: <i>I often read in the evening.</i><br>
      ‚Ä¢ after the verb ‚Äúto be‚Äù: <i>She is never late.</i><br>
      Common adverbs: always, usually, often, sometimes, rarely, never.
    `,
    ruleRu:`
      <b>–ù–∞—Ä–µ—á–∏—è —á–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç, –∫–∞–∫ —á–∞—Å—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –¥–µ–π—Å—Ç–≤–∏–µ.</b><br>
      ‚Ä¢ –ø–µ—Ä–µ–¥ –æ–±—ã—á–Ω—ã–º –≥–ª–∞–≥–æ–ª–æ–º: <i>I often read.</i><br>
      ‚Ä¢ –ø–æ—Å–ª–µ –≥–ª–∞–≥–æ–ª–∞ to be: <i>She is never late.</i><br>
      –ß–∞—Å—Ç–æ—Ç–Ω—ã–µ –Ω–∞—Ä–µ—á–∏—è: always, usually, often, sometimes, rarely, never.
    `,
    formula:`
      subject + adverb + main verb<br>
      subject + to be + adverb
    `,
    ex1:`
      <b>SB-style Exercise 1 ‚Äì Put the adverb in the correct place</b><br>
      1) I am tired. (often)<br>
      2) They go swimming. (usually)<br>
      3) She is late. (never)<br>
      4) We watch films. (sometimes)
    `,
    ex2:`
      <b>SB-style Exercise 2 ‚Äì Complete the sentences (choose: always / usually / often / sometimes / never)</b><br>
      1) I ___ eat breakfast at school.<br>
      2) My brother is ___ late for class.<br>
      3) We ___ go to the cinema at weekends.<br>
      4) She ___ drinks coffee in the morning.
    `
  },
  {
    id:3,
    module:"Module 1",
    short:"PS vs PC",
    title:"Present Simple vs Present Continuous ‚Äì basic contrast",
    ruleEn:`
      <b>Present Simple:</b> habits, facts, routines, timetables.<br>
      <b>Present Continuous:</b> actions happening now, temporary situations.<br><br>
      <b>Signal words:</b><br>
      ‚Ä¢ PS: always, usually, often, sometimes, every day<br>
      ‚Ä¢ PC: now, at the moment, right now
    `,
    ruleRu:`
      <b>Present Simple:</b> –ø—Ä–∏–≤—ã—á–∫–∏, —Ñ–∞–∫—Ç—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.<br>
      <b>Present Continuous:</b> –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å, –≤—Ä–µ–º–µ–Ω–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è.<br><br>
      <b>–°–∏–≥–Ω–∞–ª—å–Ω—ã–µ —Å–ª–æ–≤–∞:</b><br>
      ‚Ä¢ PS: always, usually, often, sometimes, every day<br>
      ‚Ä¢ PC: now, at the moment, right now
    `,
    formula:`
      Present Simple: subject + V1 / V1+s<br>
      Present Continuous: subject + am/is/are + V-ing
    `,
    ex1:`
      <b>SB-style Exercise 1 ‚Äì Choose Present Simple or Present Continuous</b><br>
      1) She ___ (is cooking / cooks) dinner now.<br>
      2) They ___ (play / are playing) football every Saturday.<br>
      3) I ___ (am not watching / don‚Äôt watch) TV on weekdays.<br>
      4) What ___ you ___ (do / doing) at the moment?
    `,
    ex2:`
      <b>SB-style Exercise 2 ‚Äì Complete with the correct tense</b><br>
      1) I ___ (study) English every day.<br>
      2) He ___ (sit) in the kitchen at the moment.<br>
      3) My parents ___ (not/work) on Sundays.<br>
      4) Look! The cat ___ (sleep) on your bag.
    `
  },

  /* MODULE 2 */
  {
    id:4,
    module:"Module 2",
    short:"Past Simple ‚Äì regular/irregular",
    title:"Past Simple ‚Äì regular and irregular verbs",
    ruleEn:`
      <b>Use Past Simple to talk about finished actions in the past.</b><br>
      Regular verbs: +ed (play ‚Üí played, open ‚Üí opened).<br>
      Irregular verbs: 2nd form (go ‚Üí went, see ‚Üí saw).
    `,
    ruleRu:`
      <b>Past Simple –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤ –ø—Ä–æ—à–ª–æ–º.</b><br>
      –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã: +ed (play ‚Üí played).<br>
      –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã: –≤—Ç–æ—Ä–∞—è —Ñ–æ—Ä–º–∞ (go ‚Üí went).
    `,
    formula:`
      (+) subject + V2<br>
      (-) subject + didn‚Äôt + V1<br>
      (?) Did + subject + V1?
    `,
    ex1:`
      <b>SB-style Exercise 1 ‚Äì Complete the table (base ‚Üí Past Simple)</b><br>
      go ‚Üí _______<br>
      make ‚Üí _______<br>
      walk ‚Üí _______<br>
      buy ‚Üí _______<br>
      help ‚Üí _______
    `,
    ex2:`
      <b>SB-style Exercise 2 ‚Äì Complete the sentences</b><br>
      1) We ___ (visit) the museum yesterday.<br>
      2) My brother ___ (not eat) breakfast this morning.<br>
      3) ___ you ___ (see) the new film?<br>
      4) She ___ (take) her bike to school.
    `
  },
  {
    id:5,
    module:"Module 2",
    short:"Past Continuous",
    title:"Past Continuous ‚Äì actions in progress in the past",
    ruleEn:`
      <b>Use Past Continuous for actions in progress at a specific moment in the past.</b><br>
      Example: At 6 p.m. yesterday, I was doing my homework.
    `,
    ruleRu:`
      <b>Past Continuous –æ–ø–∏—Å—ã–≤–∞–µ—Ç –¥–µ–π—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –≤ –ø—Ä–æ—à–ª–æ–º.</b><br>
      –ü—Ä–∏–º–µ—Ä: –í—á–µ—Ä–∞ –≤ 6 –≤–µ—á–µ—Ä–∞ —è –¥–µ–ª–∞–ª –¥–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ.
    `,
    formula:`
      subject + was/were + V-ing
    `,
    ex1:`
      <b>SB-style Exercise 1 ‚Äì Complete the sentences</b><br>
      1) I ___ (cook) dinner at 6 p.m.<br>
      2) They ___ (play) football at that moment.<br>
      3) My parents ___ (drive) to work at 8 a.m.<br>
      4) We ___ (not sleep) when the phone rang.
    `,
    ex2:`
      <b>SB-style Exercise 2 ‚Äì Choose the correct option</b><br>
      1) They <b>were walking / walked</b> home.<br>
      2) I <b>wasn‚Äôt listening / didn‚Äôt listen</b> when the teacher asked me.<br>
      3) What <b>were you doing / did you do</b> at that time?<br>
      4) She <b>was watching / watched</b> a film when I arrived.
    `
  },
  {
    id:6,
    module:"Module 2",
    short:"PS vs PC",
    title:"Past Simple vs Past Continuous",
    ruleEn:`
      <b>Past Continuous:</b> long action (background).<br>
      <b>Past Simple:</b> short action that interrupts.<br><br>
      Pattern: Past Continuous + when + Past Simple<br>
      Pattern: Past Simple + while + Past Continuous
    `,
    ruleRu:`
      <b>Past Continuous:</b> –¥–ª–∏—Ç–µ–ª—å–Ω–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ (—Ñ–æ–Ω).<br>
      <b>Past Simple:</b> –∫–æ—Ä–æ—Ç–∫–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –ø—Ä–µ—Ä—ã–≤–∞–µ—Ç.<br><br>
      –°—Ö–µ–º—ã: PC + when + PS; PS + while + PC.
    `,
    formula:`
      PC + when + PS<br>
      PS + while + PC
    `,
    ex1:`
      <b>SB-style Exercise 1 ‚Äì Complete with correct tense</b><br>
      1) I ___ (walk) home when I ___ (see) my friend.<br>
      2) She ___ (watch) TV when the lights ___ (go) off.<br>
      3) They ___ (play) football while their parents ___ (cook).<br>
      4) My phone ___ (ring) while I ___ (wash) the dishes.
    `,
    ex2:`
      <b>SB-style Exercise 2 ‚Äì Match the halves</b><br>
      1) I was doing my homework ‚Äî a) when the bell rang.<br>
      2) They were running ‚Äî b) when it suddenly started to rain.<br>
      3) She was reading ‚Äî c) when her friend arrived.
    `
  },

  /* MODULE 3 */
  {
    id:7,
    module:"Module 3",
    short:"be going to",
    title:"be going to ‚Äì plans and intentions",
    ruleEn:`
      <b>Use be going to for plans and intentions.</b><br>
      Example: I am going to visit my cousin next week.
    `,
    ruleRu:`
      <b>be going to –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è –ø–ª–∞–Ω–æ–≤ –∏ –Ω–∞–º–µ—Ä–µ–Ω–∏–π.</b><br>
      –ü—Ä–∏–º–µ—Ä: –Ø —Å–æ–±–∏—Ä–∞—é—Å—å –Ω–∞–≤–µ—Å—Ç–∏—Ç—å –∫—É–∑–µ–Ω–∞ –Ω–∞ —Å–ª–µ–¥—É—é—â–µ–π –Ω–µ–¥–µ–ª–µ.
    `,
    formula:`
      subject + am/is/are + going to + V1
    `,
    ex1:`
      <b>SB-style Exercise 1 ‚Äì Complete the sentences (be going to)</b><br>
      1) I am going to ___ (visit) my cousin.<br>
      2) They are going to ___ (play) tennis.<br>
      3) She isn‚Äôt going to ___ (buy) a new phone.<br>
      4) We are going to ___ (travel) this summer.
    `,
    ex2:`
      <b>SB-style Exercise 2 ‚Äì Choose the correct answer</b><br>
      1) We <b>are going to go / go</b> on holiday.<br>
      2) He <b>isn‚Äôt going to eat / doesn‚Äôt eat</b> pizza tonight.<br>
      3) I <b>am going to study / study</b> for the test after school.
    `
  },
  {
    id:8,
    module:"Module 3",
    short:"Will / won‚Äôt",
    title:"Will / won‚Äôt ‚Äì predictions and promises",
    ruleEn:`
      <b>Use will / won‚Äôt for:</b><br>
      ‚Ä¢ predictions: <i>I think it will rain.</i><br>
      ‚Ä¢ promises: <i>I will help you.</i><br>
      ‚Ä¢ decisions made now: <i>I‚Äôm tired, I‚Äôll go to bed.</i>
    `,
    ruleRu:`
      <b>Will / won‚Äôt –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è:</b><br>
      ‚Ä¢ –ø—Ä–µ–¥—Å–∫–∞–∑–∞–Ω–∏–π: <i>–Ø –¥—É–º–∞—é, –ø–æ–π–¥—ë—Ç –¥–æ–∂–¥—å.</i><br>
      ‚Ä¢ –æ–±–µ—â–∞–Ω–∏–π: <i>–Ø –ø–æ–º–æ–≥—É —Ç–µ–±–µ.</i><br>
      ‚Ä¢ —Ä–µ—à–µ–Ω–∏–π ¬´–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å¬ª: <i>–Ø —É—Å—Ç–∞–ª, –ø–æ–π–¥—É —Å–ø–∞—Ç—å.</i>
    `,
    formula:`
      (+) subject + will + V1<br>
      (-) subject + won‚Äôt + V1
    `,
    ex1:`
      <b>SB-style Exercise 1 ‚Äì Complete the sentences (will / won‚Äôt)</b><br>
      1) I think it ___ (rain) tomorrow.<br>
      2) She ___ (help) you with your homework.<br>
      3) They ___ (not come) today.<br>
      4) We ___ (finish) the project soon.
    `,
    ex2:`
      <b>SB-style Exercise 2 ‚Äì Choose the correct option</b><br>
      1) I think he <b>will win / wins</b> the race.<br>
      2) Don‚Äôt worry, I <b>will help / am helping</b> you.<br>
      3) I‚Äôm cold, I <b>will close / am closing</b> the window.<br>
    `
  },
  {
    id:9,
    module:"Module 3",
    short:"PC as Future",
    title:"Present Continuous for future arrangements",
    ruleEn:`
      <b>Use Present Continuous for fixed future plans/arrangements.</b><br>
      Example: We are meeting our friends on Friday.
    `,
    ruleRu:`
      <b>Present Continuous –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–ª—è —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á / –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç–µ–π –≤ –±—É–¥—É—â–µ–º.</b><br>
      –ü—Ä–∏–º–µ—Ä: –ú—ã –≤—Å—Ç—Ä–µ—á–∞–µ–º—Å—è —Å –¥—Ä—É–∑—å—è–º–∏ –≤ –ø—è—Ç–Ω–∏—Ü—É.
    `,
    formula:`
      subject + am/is/are + V-ing (future time word)
    `,
    ex1:`
      <b>SB-style Exercise 1 ‚Äì Complete the sentences (PC for future)</b><br>
      1) We are ___ (meet) our friends tonight.<br>
      2) She is ___ (travel) to London next Monday.<br>
      3) I am ___ (have) lunch with my cousin tomorrow.
    `,
    ex2:`
      <b>SB-style Exercise 2 ‚Äì Rewrite the sentences</b><br>
      1) We meet Sam on Friday. ‚Üí We are meeting Sam on Friday.<br>
      2) They leave tomorrow. ‚Üí They are leaving tomorrow.<br>
      3) I go to the dentist on Tuesday. ‚Üí I am going to the dentist on Tuesday.
    `
  }
];

let currentUser = null; // {name, role}
let currentTopicId = null;

/* ----------- UI HELPERS ----------- */
function showScreen(id){
  document.querySelectorAll(".screen").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

function clearLogin(){
  document.getElementById("loginName").value = "";
  document.getElementById("loginPin").value = "";
}

function updateHeader(){
  const roleDiv = document.getElementById("userRole");
  const nameDiv = document.getElementById("userName");
  if(!currentUser){
    roleDiv.textContent = "Not logged in";
    nameDiv.textContent = "";
  }else{
    roleDiv.textContent = currentUser.role === "teacher" ? "Teacher mode" : "Student mode";
    nameDiv.textContent = currentUser.name;
  }
}

/* ----------- LOGIN LOGIC ----------- */
function handleLogin(){
  const name = document.getElementById("loginName").value.trim();
  const pin = document.getElementById("loginPin").value.trim();

  if(!pin){
    alert("Enter PIN, please.");
    return;
  }

  if(pin === TEACHER_PIN){
    currentUser = {name: name || "Teacher", role:"teacher"};
    updateHeader();
    buildTeacherTable();
    showScreen("teacherScreen");
    saveLoginEvent();
    return;
  }

  if(pin === STUDENT_PIN){
    if(!name){
      alert("Enter your name, please.");
      return;
    }
    if(!allowedStudents.includes(name)){
      alert("This name is not on the student list. Ask your teacher.");
      return;
    }
    currentUser = {name, role:"student"};
    updateHeader();
    renderTopicList();
    showScreen("studentScreen");
    saveLoginEvent();
    return;
  }

  alert("Wrong PIN.");
}

/* ----------- TOPICS RENDERING ----------- */
function renderTopicList(){
  const list = document.getElementById("topicList");
  list.innerHTML = "";

  topics.forEach(t=>{
    const div = document.createElement("div");
    div.className = "topic-card";
    div.dataset.id = t.id;

    const mod = document.createElement("div");
    mod.className = "topic-sub";
    mod.textContent = t.module;

    const title = document.createElement("div");
    title.className = "topic-title";
    title.textContent = t.short + " ‚Äì " + t.title;

    div.appendChild(mod);
    div.appendChild(title);

    div.addEventListener("click", ()=>selectTopic(t.id));
    list.appendChild(div);
  });
}

function selectTopic(id){
  currentTopicId = id;
  document.querySelectorAll(".topic-card").forEach(c=>{
    c.classList.toggle("active", Number(c.dataset.id) === id);
  });

  const t = topics.find(x => x.id === id);
  const box = document.getElementById("topicDetails");
  if(!t) return;

  const stars = getStarsForStudentTopic(currentUser?.name, id);

  box.innerHTML = `
    <span class="module-badge">${t.module} ‚Ä¢ Grammar B</span>
    <h3>${t.title}</h3>
    <div class="rule-block">
      ${t.ruleEn}
    </div>
    <div class="rule-block">
      ${t.ruleRu}
    </div>
    <div class="formula-block">
      ${t.formula}
    </div>
    <div class="ex-block">
      ${t.ex1}
    </div>
    <div class="ex-block">
      ${t.ex2}
    </div>
    <div class="star-row">
      <span>Mark this topic as completed to get a ‚≠ê</span>
      <span>
        <input type="checkbox" id="doneChk" ${stars ? "checked" : ""} onchange="toggleStar(${id}, this.checked)" />
        <label for="doneChk">Completed</label>
        <span class="star-count">Stars: ${stars ? 1 : 0}</span>
      </span>
    </div>
  `;
}

/* ----------- STARS & JOURNAL (localStorage) ----------- */
function getStudentKey(name){
  return "aiBayan7_" + name;
}

function getStudentData(name){
  if(!name) return null;
  const raw = localStorage.getItem(getStudentKey(name));
  if(!raw) return {stars:[], lastTopic:null, lastLogin:null};
  try{
    return JSON.parse(raw);
  }catch(e){
    return {stars:[], lastTopic:null, lastLogin:null};
  }
}

function saveStudentData(name,data){
  if(!name) return;
  localStorage.setItem(getStudentKey(name), JSON.stringify(data));
}

function getStarsForStudentTopic(name,topicId){
  if(!name) return 0;
  const data = getStudentData(name);
  return data.stars.includes(topicId) ? 1 : 0;
}

function toggleStar(topicId,checked){
  if(!currentUser || currentUser.role!=="student") return;
  const data = getStudentData(currentUser.name);
  if(checked){
    if(!data.stars.includes(topicId)) data.stars.push(topicId);
    data.lastTopic = topicId;
  }else{
    data.stars = data.stars.filter(id => id !== topicId);
    data.lastTopic = topicId;
  }
  saveStudentData(currentUser.name,data);
  selectTopic(topicId); // –ø–µ—Ä–µ—Ä–∏—Å—É–µ–º, —á—Ç–æ–±—ã –æ–±–Ω–æ–≤–∏—Ç—å —Å—á—ë—Ç—á–∏–∫
  buildTeacherTable();  // –æ–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —É—á–∏—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω–∞ –æ—Ç–∫—Ä—ã—Ç–∞
}

function saveLoginEvent(){
  if(!currentUser || currentUser.role!=="student") return;
  const data = getStudentData(currentUser.name);
  data.lastLogin = new Date().toISOString();
  saveStudentData(currentUser.name,data);
  buildTeacherTable();
}

function buildTeacherTable(){
  const tbody = document.querySelector("#teacherTable tbody");
  if(!tbody) return;
  tbody.innerHTML = "";

  allowedStudents.forEach(name=>{
    const data = getStudentData(name);
    const tr = document.createElement("tr");

    const tdName = document.createElement("td");
    tdName.textContent = name;

    const tdStars = document.createElement("td");
    tdStars.textContent = data ? (data.stars?.length || 0) : 0;

    const tdTopic = document.createElement("td");
    if(data && data.lastTopic){
      const t = topics.find(x=>x.id === data.lastTopic);
      tdTopic.textContent = t ? t.module + ": " + t.short : "";
    }else{
      tdTopic.textContent = "";
    }

    const tdLogin = document.createElement("td");
    if(data && data.lastLogin){
      tdLogin.textContent = new Date(data.lastLogin).toLocaleString();
    }else{
      tdLogin.textContent = "";
    }

    tr.appendChild(tdName);
    tr.appendChild(tdStars);
    tr.appendChild(tdTopic);
    tr.appendChild(tdLogin);
    tbody.appendChild(tr);
  });
}

/* ----------- AI CHAT (stub) ----------- */
function sendToAi(){
  const box = document.getElementById("chatBox");
  const text = document.getElementById("aiQuestion").value.trim();
  if(!text) return;

  // student message
  const m1 = document.createElement("div");
  m1.className = "chat-msg me";
  m1.textContent = "You: " + text;
  box.appendChild(m1);

  // simple local stub answer
  const m2 = document.createElement("div");
  m2.className = "chat-msg";
  m2.textContent = "AI Bayan (stub): Your teacher will later connect a real AI Worker here. For now, use the rules and examples on the right.";
  box.appendChild(m2);

  box.scrollTop = box.scrollHeight;
  document.getElementById("aiQuestion").value = "";
}

/* ----------- INIT ----------- */
updateHeader();
</script>
</body>
</html>
