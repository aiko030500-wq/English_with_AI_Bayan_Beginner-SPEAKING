<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì 7 grade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --watermelon-dark: #0a8f39;
      --watermelon-light: #60d394;
      --watermelon-pink: #ff5470;
      --watermelon-soft: #ffa5b0;
      --seed-dark: #222222;
      --gold: #ffd54f;
      --bg: #fdf7f5;
      --card: #ffffff;
      --danger: #ff8da1;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      background: radial-gradient(circle at top left, #ffe7ed 0, #fdf7f5 40%, #f5fff7 100%);
      color: #143321;
      min-height: 100vh;
    }

    header {
      background: linear-gradient(90deg, var(--watermelon-dark), var(--watermelon-pink));
      color: #fff;
      padding: 10px 18px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.25);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo-circle {
      width: 46px;
      height: 46px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff 0, var(--watermelon-soft) 38%, var(--watermelon-pink) 70%);
      border: 3px solid var(--gold);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 22px;
      color: var(--seed-dark);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.6);
    }

    .logo-circle span { transform: translateY(-1px); }

    .title-block h1 {
      font-size: 18px;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    .title-block p {
      font-size: 13px;
      opacity: 0.9;
    }

    .header-right {
      display: flex;
      flex-direction: column;
      gap: 4px;
      text-align: right;
      font-size: 12px;
    }

    .tag-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 2px 10px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.18);
      font-size: 11px;
    }

    .tag-pill span { font-weight: 600; }

    .top-nav-links {
      display: flex;
      gap: 6px;
      margin-top: 3px;
    }

    .user-label { font-size: 12px; }

    main {
      padding: 16px;
      max-width: 1000px;
      margin: 0 auto 40px;
    }

    .hidden { display: none !important; }

    .card {
      background: var(--card);
      border-radius: 16px;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.08);
      padding: 18px 18px 20px;
      border: 1px solid rgba(0, 0, 0, 0.03);
    }

    .card--login {
      max-width: 420px;
      margin: 40px auto;
      border-top: 5px solid var(--watermelon-pink);
      position: relative;
      overflow: hidden;
    }

    .card--login::before {
      content: "";
      position: absolute;
      inset: -60px;
      background-image:
        radial-gradient(circle at 20% 0, rgba(255, 255, 255, 0.4) 0, transparent 50%),
        radial-gradient(circle at 80% 110%, rgba(255, 84, 112, 0.18) 0, transparent 55%);
      opacity: 0.8;
      pointer-events: none;
    }

    .card--login-inner { position: relative; z-index: 1; }

    h2.section-title {
      font-size: 20px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--watermelon-dark);
    }

    h2.section-title span.emoji { font-size: 22px; }

    p.muted {
      font-size: 13px;
      color: #607273;
      margin-bottom: 14px;
    }

    .form-group { margin-bottom: 12px; }

    label {
      display: block;
      font-size: 13px;
      margin-bottom: 4px;
      color: #234233;
    }

    input[type="text"],
    input[type="password"] {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0, 0, 0, 0.14);
      font-size: 14px;
      outline: none;
      background: #fffdfd;
      transition: border 0.15s, box-shadow 0.15s, background 0.15s;
    }

    input[type="text"]:focus,
    input[type="password"]:focus {
      border-color: var(--watermelon-pink);
      box-shadow: 0 0 0 2px rgba(255, 84, 112, 0.2);
      background: #ffffff;
    }

    .btn-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }

    .btn {
      border-radius: 999px;
      padding: 8px 16px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.15s, color 0.15s;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--watermelon-pink), #ff7a8c);
      color: #fff;
      box-shadow: 0 3px 8px rgba(255, 84, 112, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(255, 84, 112, 0.55);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(0, 0, 0, 0.18);
      color: #254332;
    }

    .btn-outline:hover { background: rgba(255, 255, 255, 0.8); }

    .login-note {
      font-size: 11px;
      color: #566b60;
      margin-top: 8px;
    }

    /* STUDENT SCREENS */
    #studentScreen {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .topics-card { border-top: 4px solid var(--watermelon-dark); }

    .topics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .topic-pill {
      border-radius: 14px;
      padding: 10px 10px 11px;
      background: linear-gradient(135deg, #ffffff, #ffeef2);
      border: 1px solid rgba(0, 0, 0, 0.06);
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: transform 0.06s ease-out, box-shadow 0.06s ease-out, border 0.1s;
      position: relative;
      overflow: hidden;
    }

    .topic-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(255, 84, 112, 0.25);
      border-color: rgba(255, 84, 112, 0.6);
    }

    .topic-title {
      font-size: 14px;
      font-weight: 600;
      color: #203429;
    }

    .topic-meta {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #587168;
    }

    .stars { font-size: 13px; }

    .badge-soft {
      padding: 2px 7px;
      border-radius: 999px;
      background: rgba(10, 143, 57, 0.1);
      color: var(--watermelon-dark);
      font-size: 11px;
    }

    /* Topic screen */

    #studentTopic { display: flex; flex-direction: column; gap: 12px; }

    #topicContent.card { border-top: 4px solid var(--watermelon-pink); }

    .topic-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #617774;
      margin-bottom: 4px;
    }

    .topic-header-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .topic-header-line h3 {
      font-size: 18px;
      color: var(--watermelon-dark);
    }

    .grammar-box {
      background: #fff8fb;
      border-radius: 12px;
      padding: 10px 11px;
      border: 1px solid rgba(255, 84, 112, 0.25);
      margin-bottom: 10px;
      font-size: 13px;
    }

    .grammar-box strong { color: #b2374f; }

    .examples-list {
      margin-left: 18px;
      font-size: 13px;
      margin-bottom: 8px;
    }

    .examples-list li { margin-bottom: 4px; }

    .exercise-title {
      margin-top: 6px;
      margin-bottom: 4px;
      font-weight: 600;
      font-size: 14px;
    }

    .exercise-list {
      margin-left: 18px;
      font-size: 13px;
      display: grid;
      gap: 6px;
      margin-bottom: 10px;
    }

    .exercise-list input[type="text"] {
      width: 170px;
      padding: 4px 6px;
      border-radius: 8px;
      font-size: 13px;
    }

    .input-correct {
      border-color: var(--watermelon-dark) !important;
      background: #e8f8ed !important;
    }

    .input-wrong {
      border-color: var(--danger) !important;
      background: #ffe6ec !important;
    }

    .topic-result {
      font-size: 13px;
      margin-top: 4px;
      font-weight: 600;
    }

    .topic-result.good { color: var(--watermelon-dark); }
    .topic-result.bad { color: #b52b40; }

    .topic-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .note-small {
      font-size: 11px;
      color: #6f7e7b;
      margin-top: 4px;
    }

    /* AI panel */

    #aiPanel { border-top: 4px solid var(--gold); }

    #aiPanel h3 { font-size: 16px; margin-bottom: 4px; }

    #aiLimit { font-size: 11px; font-weight: 500; }

    .chat-note {
      font-size: 11px;
      color: #5c6f69;
      margin-bottom: 6px;
    }

    .chat-box {
      border-radius: 12px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: #fffefb;
      padding: 8px;
      height: 220px;
      overflow-y: auto;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .msg {
      margin-bottom: 6px;
      padding: 6px 8px;
      border-radius: 10px;
      word-wrap: break-word;
    }

    .msg-user { background: #ffe7ed; }
    .msg-ai   { background: #f2fbf5; }

    #aiQuestion {
      width: 100%;
      min-height: 60px;
      resize: vertical;
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid rgba(0, 0, 0, 0.14);
      font-size: 13px;
      outline: none;
    }

    #aiQuestion:focus {
      border-color: var(--watermelon-dark);
      box-shadow: 0 0 0 2px rgba(10, 143, 57, 0.18);
    }

    .chat-actions {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
    }

    .limit-warning {
      font-size: 11px;
      color: #b52b40;
    }

    /* Teacher screen */

    .teacher-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .teacher-header h2 {
      font-size: 20px;
      color: var(--watermelon-dark);
    }

    .teacher-meta {
      font-size: 12px;
      color: #536560;
    }

    .table-wrapper { overflow-x: auto; }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 6px;
    }

    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      text-align: left;
      white-space: nowrap;
    }

    th {
      background: #fdf2f5;
      font-weight: 600;
    }

    tr:nth-child(even) td { background: rgba(255, 255, 255, 0.7); }

    .td-center { text-align: center; }

    .pill-role {
      padding: 2px 7px;
      border-radius: 999px;
      font-size: 11px;
    }

    .pill-role--teacher {
      background: rgba(255, 213, 79, 0.18);
      color: #735800;
    }

    /* PRINT */
    @media print {
      header,
      #loginScreen,
      .btn-print-hide {
        display: none !important;
      }
      body { background: #ffffff; }
      main { padding: 0; margin: 0; max-width: 100%; }
      .card { box-shadow: none; border-radius: 0; border: none; }
    }

    @media (max-width: 540px) {
      main { padding: 10px; }
      .card--login { margin: 20px auto; }
    }
  </style>
</head>
<body>
<header>
  <div class="header-left">
    <div class="logo-circle"><span>B</span></div>
    <div class="title-block">
      <h1>ENGLISH WITH AI BAYAN</h1>
      <p>7 grade ¬∑ Grammar &amp; Workbook ¬∑ Watermelon Edition üçâ</p>
    </div>
  </div>
  <div class="header-right">
    <div class="tag-pill">
      <span>AI Bayan</span> ¬∑ teacher journal ¬∑ 1 question/day
    </div>
    <div class="top-nav-links">
      <button class="btn btn-outline btn-print-hide" id="toStudentBtn">–≠–∫—Ä–∞–Ω —É—á–µ–Ω–∏–∫–∞</button>
      <button class="btn btn-outline btn-print-hide" id="toTeacherBtn">–ñ—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è</button>
    </div>
    <div class="user-label" id="currentUserLabel">–ù–µ –≤–æ—à–ª–∏</div>
  </div>
</header>

<main>
  <!-- LOGIN -->
  <section id="loginScreen">
    <div class="card card--login">
      <div class="card--login-inner">
        <h2 class="section-title"><span class="emoji">üçâ</span> ENGLISH WITH AI BAYAN ‚Äì 7 grade</h2>
        <p class="muted">
          –í–≤–µ–¥–∏—Ç–µ —Å–≤–æ—ë –∏–º—è –∏ PIN-–∫–æ–¥. –ù–∏–∫–∞–∫–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫ PIN –∏ –∏–º—ë–Ω –Ω–∞ —ç–∫—Ä–∞–Ω–µ –Ω–µ—Ç ‚Äì –≤—ã –¥–∞—ë—Ç–µ –∏—Ö –¥–µ—Ç—è–º —Å–∞–º–∏.
        </p>

        <div class="form-group">
          <label for="nameInput">–ò–º—è</label>
          <input type="text" id="nameInput" autocomplete="off" />
        </div>

        <div class="form-group">
          <label for="pinInput">PIN-–∫–æ–¥</label>
          <input type="password" id="pinInput" maxlength="4" inputmode="numeric" />
        </div>

        <div class="btn-row">
          <button class="btn btn-primary" id="loginBtn">–í–æ–π—Ç–∏ –≤ –≥—Ä–∞–º–º–∞—Ç–∏–∫—É</button>
          <button class="btn btn-outline" id="clearStorageBtn">–°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</button>
        </div>

        <p class="login-note">
          –û—Ç–¥–µ–ª—å–Ω—ã–µ PIN –¥–ª—è —É—á–∏—Ç–µ–ª—è –∏ —É—á–µ–Ω–∏–∫–æ–≤ –∑–∞–¥–∞—ë—Ç–µ –≤—ã. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏—Ö –Ω–∏–≥–¥–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç.
        </p>
      </div>
    </div>
  </section>

  <!-- STUDENT -->
  <section id="studentScreen" class="hidden">
    <!-- —Å–ø–∏—Å–æ–∫ —Ç–µ–º -->
    <div id="studentList">
      <div class="card topics-card">
        <h2 class="section-title"><span class="emoji">üìö</span> Grammar topics ‚Äì 7 grade</h2>
        <p class="muted">
          –ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–µ–º—É, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω —Å –≥—Ä–∞–º–º–∞—Ç–∏–∫–æ–π, —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º–∏ –∏ —á–∞—Ç–æ–º —Å AI Bayan.
        </p>
        <div class="topics-grid" id="topicsGrid"></div>
      </div>
    </div>

    <!-- —ç–∫—Ä–∞–Ω –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Ç–µ–º—ã -->
    <div id="studentTopic" class="hidden">
      <button class="btn btn-outline btn-print-hide" style="margin-bottom:10px;" onclick="backToTopicsList()">
        ‚Üê –ö —Å–ø–∏—Å–∫—É —Ç–µ–º
      </button>

      <section id="topicContent" class="card"></section>

      <aside id="aiPanel" class="card">
        <div>
          <h3>AI Bayan Chat</h3>
          <div id="aiLimit"></div>
        </div>
        <p class="chat-note">
          –í–æ–ø—Ä–æ—Å—ã –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ, –ª–µ–∫—Å–∏–∫–µ –∏ –ø–µ—Ä–µ–≤–æ–¥—É. –õ–∏–º–∏—Ç ‚Äì <strong>1 –≤–æ–ø—Ä–æ—Å –≤ —Å—É—Ç–∫–∏</strong> –Ω–∞ —É—á–µ–Ω–∏–∫–∞.
        </p>
        <div id="chatBox" class="chat-box"></div>
        <textarea id="aiQuestion"
                  placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –¥–ª—è AI Bayan –∏ –Ω–∞–∂–º–∏—Ç–µ Enter –∏–ª–∏ –∫–Ω–æ–ø–∫—É ¬´–°–ø—Ä–æ—Å–∏—Ç—å¬ª..."></textarea>
        <div class="chat-actions">
          <button class="btn btn-primary" id="askBtn">–°–ø—Ä–æ—Å–∏—Ç—å AI Bayan</button>
          <span class="limit-warning" id="limitWarning"></span>
        </div>
        <p class="chat-note">
          –í –±—É–¥—É—â–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—Ç—å –≤ —É—á–∏—Ç–µ–ª—å—Å–∫–∏–π –∂—É—Ä–Ω–∞–ª.
        </p>
      </aside>
    </div>
  </section>

  <!-- TEACHER -->
  <section id="teacherScreen" class="hidden">
    <div class="card">
      <div class="teacher-header">
        <div>
          <h2>–ñ—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è ¬∑ 7 grade</h2>
          <p class="teacher-meta">
            –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å —É—á–µ–Ω–∏–∫–æ–≤ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –î–ª—è –ø–µ—á–∞—Ç–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.
          </p>
        </div>
        <div>
          <div class="pill-role pill-role--teacher">Teacher mode</div>
          <div class="topic-actions" style="margin-top:6px;">
            <button class="btn btn-outline btn-print-hide" id="printJournalBtn">–ü–µ—á–∞—Ç—å –∂—É—Ä–Ω–∞–ª–∞</button>
            <button class="btn btn-outline btn-print-hide" id="backToStudentFromTeacher">–≠–∫—Ä–∞–Ω —É—á–µ–Ω–∏–∫–∞</button>
          </div>
        </div>
      </div>

      <div class="table-wrapper">
        <table>
          <thead>
          <tr>
            <th>–£—á–µ–Ω–∏–∫</th>
            <th>–ö–ª–∞—Å—Å</th>
            <th>–¢–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–æ</th>
            <th>–ó–≤—ë–∑–¥—ã</th>
            <th>–í—Å–µ–≥–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –∫ AI</th>
            <th>–í–æ–ø—Ä–æ—Å —Å–µ–≥–æ–¥–Ω—è</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
          </tr>
          </thead>
          <tbody id="teacherTableBody"></tbody>
        </table>
      </div>
      <p class="note-small">
        –ó–≤—ë–∑–¥—ã —Å—á–∏—Ç–∞—é—Ç—Å—è —É—Å–ª–æ–≤–Ω–æ: —á–µ–º –±–æ–ª—å—à–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤ –ø–æ —Ç–µ–º–∞–º, —Ç–µ–º –≤—ã—à–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥.
      </p>
    </div>
  </section>
</main>

<script>
  /* -------- DATA -------- */

  const TEACHER_PIN = "2844";

  const allowedStudents = [
    "–°—ã—Ä—ã–º7–°",
    "–°–∞–º–∏—Ä7–ë",
    "–û—Ä–¥–∞7–û",
    "–†—É—Å–ª–∞–Ω7–í",
    "–†—É—Å–ª–∞–Ω7–ò",
    "–ú–∞–∫—Å—É—Ç7–°",
    "–ê–¥–µ–ª–∏–Ω–∞7–ú",
    "–≠–ª—å–Ω–æ—Ä–∞7–ê",
    "–õ—É–Ω–∞—Ä–∞7–ê",
    "–ú–∞–∫—Å–∏–º7–ú",
    "–†–∏–Ω–∞—Ç7–¶",
    "–ê—Ä—Ç–µ–º7–ê",
    "–ë7–ê"
  ];

  const topics = [
    {
      id: "t1",
      short: "Present Continuous",
      title: "Present Continuous ‚Äì –¥–µ–π—Å—Ç–≤–∏—è ¬´—Å–µ–π—á–∞—Å¬ª",
      module: "Module 1",
      html: `
        <div class="topic-label">Topic 1 ¬∑ Module 1</div>
        <div class="topic-header-line">
          <h3>Present Continuous ‚Äì —Ç–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–µ–π—á–∞—Å</h3>
          <span class="badge-soft">Workbook: Module 1b</span>
        </div>
        <div class="grammar-box">
          <strong>–§–æ—Ä–º–∞:</strong> am / is / are + verb + <strong>-ing</strong><br/>
          <strong>–ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º:</strong>
          <ul class="examples-list">
            <li>–î–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å: <em>She is reading now.</em></li>
            <li>–î–µ–π—Å—Ç–≤–∏–µ –≤–æ–∫—Ä—É–≥ –Ω–∞—Å—Ç–æ—è—â–µ–≥–æ –º–æ–º–µ–Ω—Ç–∞: <em>They are studying this week.</em></li>
            <li>–í–æ–ø—Ä–æ—Å—ã: <em>Are you doing your homework?</em></li>
          </ul>
        </div>
        <div class="exercise-title">–£–ø—Ä. 1. –í—Å—Ç–∞–≤—å—Ç–µ –≥–ª–∞–≥–æ–ª –≤ Present Continuous.</div>
        <ol class="exercise-list">
          <li>My teacher <input data-answer="is talking" type="text" /> to the class now.</li>
          <li>They <input data-answer="are doing" type="text" /> their project at the moment.</li>
          <li>I <input data-answer="am wearing" type="text" /> a green T-shirt today.</li>
          <li>Look! The children <input data-answer="are playing" type="text" /> in the yard.</li>
        </ol>
        <div class="exercise-title">–£–ø—Ä. 2. –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã.</div>
        <ol class="exercise-list">
          <li>Is she studying now? ‚Äì Yes, <input data-answer="she is" type="text" />.</li>
          <li>Are they sleeping? ‚Äì No, <input data-answer="they aren't" type="text" />.</li>
        </ol>
        <div class="topic-actions">
          <button class="btn btn-primary" onclick="checkCurrentTopic()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          <button class="btn btn-outline btn-print-hide" onclick="window.print()">–ü–µ—á–∞—Ç—å —Ç–µ–º—ã</button>
        </div>
        <p class="topic-result" id="topicResult"></p>
      `
    },
    {
      id: "t2",
      short: "Present Simple vs Continuous",
      title: "Present Simple vs Present Continuous",
      module: "Module 1",
      html: `
        <div class="topic-label">Topic 2 ¬∑ Module 1</div>
        <div class="topic-header-line">
          <h3>Present Simple –∏–ª–∏ Present Continuous?</h3>
          <span class="badge-soft">–æ–±—ã—á–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ ¬´—Å–µ–π—á–∞—Å¬ª</span>
        </div>
        <div class="grammar-box">
          <strong>Present Simple</strong> ‚Äì —Ñ–∞–∫—Ç—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è, –ø—Ä–∏–≤—ã—á–∫–∏.<br/>
          <strong>Present Continuous</strong> ‚Äì —Ç–æ, —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –∏–ª–∏ –≤—Ä–µ–º–µ–Ω–Ω–æ.
          <ul class="examples-list">
            <li><em>I go to school every day.</em> ‚Äì –ø—Ä–∏–≤—ã—á–∫–∞.</li>
            <li><em>I am going to school now.</em> ‚Äì —Å–µ–π—á–∞—Å.</li>
          </ul>
        </div>
        <div class="exercise-title">–£–ø—Ä. 1. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è.</div>
        <ol class="exercise-list">
          <li>My mum <input data-answer="works" type="text" /> in a bank every day.</li>
          <li>Listen! The birds <input data-answer="are singing" type="text" /> in the garden.</li>
          <li>We usually <input data-answer="start" type="text" /> lessons at 8 a.m.</li>
          <li>Be quiet, please. The baby <input data-answer="is sleeping" type="text" />.</li>
        </ol>
        <div class="exercise-title">–£–ø—Ä. 2. –ò—Å–ø—Ä–∞–≤—å—Ç–µ –æ—à–∏–±–∫—É.</div>
        <ol class="exercise-list">
          <li>He <input data-answer="doesn't watch" type="text" /> TV every evening. (not watching)</li>
          <li>They <input data-answer="are having" type="text" /> dinner now. (have)</li>
        </ol>
        <div class="topic-actions">
          <button class="btn btn-primary" onclick="checkCurrentTopic()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          <button class="btn btn-outline btn-print-hide" onclick="window.print()">–ü–µ—á–∞—Ç—å —Ç–µ–º—ã</button>
        </div>
        <p class="topic-result" id="topicResult"></p>
      `
    },
    {
      id: "t3",
      short: "Comparatives & Superlatives",
      title: "–°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏ –ø—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è —Å—Ç–µ–ø–µ–Ω–∏",
      module: "Module 1",
      html: `
        <div class="topic-label">Topic 3 ¬∑ Module 1</div>
        <div class="topic-header-line">
          <h3>Comparatives &amp; Superlatives</h3>
          <span class="badge-soft">—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ª—é–¥–µ–π –∏ –≤–µ—â–µ–π</span>
        </div>
        <div class="grammar-box">
          <strong>Comparative</strong>: tall ‚Üí taller, big ‚Üí bigger, modern ‚Üí more modern.<br/>
          <strong>Superlative</strong>: the tallest, the most modern.
          <ul class="examples-list">
            <li><em>Aidar is taller than Madi.</em></li>
            <li><em>This is the most interesting book.</em></li>
          </ul>
        </div>
        <div class="exercise-title">–£–ø—Ä. 1. –°—Ä–∞–≤–Ω–∏—Ç–µ (than).</div>
        <ol class="exercise-list">
          <li>Brazil / big / Italy ‚Äì Brazil is <input data-answer="bigger than italy" type="text" />.</li>
          <li>My bag / heavy / your bag ‚Äì My bag is <input data-answer="heavier than your bag" type="text" />.</li>
        </ol>
        <div class="exercise-title">–£–ø—Ä. 2. –ü—Ä–µ–≤–æ—Å—Ö–æ–¥–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å.</div>
        <ol class="exercise-list">
          <li>fast ‚Üí <input data-answer="the fastest" type="text" /></li>
          <li>beautiful ‚Üí <input data-answer="the most beautiful" type="text" /></li>
          <li>good ‚Üí <input data-answer="the best" type="text" /></li>
        </ol>
        <div class="topic-actions">
          <button class="btn btn-primary" onclick="checkCurrentTopic()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          <button class="btn btn-outline btn-print-hide" onclick="window.print()">–ü–µ—á–∞—Ç—å —Ç–µ–º—ã</button>
        </div>
        <p class="topic-result" id="topicResult"></p>
      `
    },
    {
      id: "t4",
      short: "Too / Enough",
      title: "Too / Enough",
      module: "Module 1",
      html: `
        <div class="topic-label">Topic 4 ¬∑ Module 1</div>
        <div class="topic-header-line">
          <h3>Too / Enough ‚Äì ¬´—Å–ª–∏—à–∫–æ–º¬ª –∏ ¬´–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ¬ª</h3>
          <span class="badge-soft">adjectives with too / enough</span>
        </div>
        <div class="grammar-box">
          <ul class="examples-list">
            <li><strong>too + adj</strong>: The bag is <em>too heavy</em>.</li>
            <li><strong>adj + enough</strong>: He is <em>old enough</em> to drive.</li>
          </ul>
        </div>
        <div class="exercise-title">–£–ø—Ä. 1. –í—Å—Ç–∞–≤—å—Ç–µ too –∏–ª–∏ enough.</div>
        <ol class="exercise-list">
          <li>She is <input data-answer="too" type="text" /> tired to do her homework.</li>
          <li>My brother isn‚Äôt tall <input data-answer="enough" type="text" /> to play in this team.</li>
          <li>Is this room big <input data-answer="enough" type="text" /> for all the students?</li>
          <li>The test was <input data-answer="too" type="text" /> difficult for me.</li>
        </ol>
        <div class="topic-actions">
          <button class="btn btn-primary" onclick="checkCurrentTopic()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          <button class="btn btn-outline btn-print-hide" onclick="window.print()">–ü–µ—á–∞—Ç—å —Ç–µ–º—ã</button>
        </div>
        <p class="topic-result" id="topicResult"></p>
      `
    },
    {
      id: "t5",
      short: "Can / Could / Be able to",
      title: "Can / Could / Be able to",
      module: "Module 2",
      html: `
        <div class="topic-label">Topic 5 ¬∑ Module 2</div>
        <div class="topic-header-line">
          <h3>Can, Could –∏ Be able to ‚Äì —É–º–µ–Ω–∏–µ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å</h3>
          <span class="badge-soft">abilities now / past / future</span>
        </div>
        <div class="grammar-box">
          <ul class="examples-list">
            <li><strong>can</strong> ‚Äì —É–º–µ—é —Å–µ–π—á–∞—Å: <em>I can swim.</em></li>
            <li><strong>could</strong> ‚Äì —É–º–µ–ª –≤ –ø—Ä–æ—à–ª–æ–º: <em>She could read at six.</em></li>
            <li><strong>be able to</strong> ‚Äì –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Å–∏—Ç—É–∞—Ü–∏—è –∏–ª–∏ –±—É–¥—É—â–µ–µ:
              <em>He was able to fix the PC.</em>, <em>We will be able to travel in space.</em>
            </li>
          </ul>
        </div>
        <div class="exercise-title">–£–ø—Ä. 1. –í—Å—Ç–∞–≤—å—Ç–µ: can, could –∏–ª–∏ was/were able to / will be able to.</div>
        <ol class="exercise-list">
          <li>My grandpa <input data-answer="could" type="text" /> play the dombra when he was five.</li>
          <li>We <input data-answer="can" type="text" /> use the computer lab now.</li>
          <li>After an hour the engineer <input data-answer="was able to" type="text" /> fix the problem.</li>
          <li>In the future people <input data-answer="will be able to" type="text" /> live on Mars.</li>
        </ol>
        <div class="topic-actions">
          <button class="btn btn-primary" onclick="checkCurrentTopic()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          <button class="btn btn-outline btn-print-hide" onclick="window.print()">–ü–µ—á–∞—Ç—å —Ç–µ–º—ã</button>
        </div>
        <p class="topic-result" id="topicResult"></p>
      `
    },
    {
      id: "t6",
      short: "Used to",
      title: "Used to ‚Äì –ø—Ä–æ—à–ª—ã–µ –ø—Ä–∏–≤—ã—á–∫–∏",
      module: "Module 2",
      html: `
        <div class="topic-label">Topic 6 ¬∑ Module 2</div>
        <div class="topic-header-line">
          <h3>Used to ‚Äì —Ç–æ, —á—Ç–æ –¥–µ–ª–∞–ª–∏ —Ä–∞–Ω—å—à–µ, –Ω–æ —Å–µ–π—á–∞—Å –Ω–µ—Ç</h3>
          <span class="badge-soft">past habits</span>
        </div>
        <div class="grammar-box">
          <ul class="examples-list">
            <li><em>I used to play video games every day.</em> ‚Äì —Ä–∞–Ω—å—à–µ –∏–≥—Ä–∞–ª, —Å–µ–π—á–∞—Å –Ω–µ—Ç.</li>
            <li>–û—Ç—Ä–∏—Ü–∞–Ω–∏–µ: <em>didn't use to</em>. –í–æ–ø—Ä–æ—Å: <em>Did you use to ...?</em></li>
          </ul>
        </div>
        <div class="exercise-title">–£–ø—Ä. 1. –ü–µ—Ä–µ–ø–∏—à–∏—Ç–µ —Å used to.</div>
        <ol class="exercise-list">
          <li>When he was ten, he played with toy cars every day. ‚Üí He
            <input data-answer="used to play with toy cars" type="text" />.</li>
          <li>She didn‚Äôt eat vegetables when she was a child. ‚Üí She
            <input data-answer="didn't use to eat vegetables" type="text" />.</li>
        </ol>
        <div class="topic-actions">
          <button class="btn btn-primary" onclick="checkCurrentTopic()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          <button class="btn btn-outline btn-print-hide" onclick="window.print()">–ü–µ—á–∞—Ç—å —Ç–µ–º—ã</button>
        </div>
        <p class="topic-result" id="topicResult"></p>
      `
    },
    {
      id: "t7",
      short: "-ing / -ed adjectives",
      title: "-ing / -ed adjectives",
      module: "Module 2",
      html: `
        <div class="topic-label">Topic 7 ¬∑ Module 2</div>
        <div class="topic-header-line">
          <h3>-ing / -ed adjectives ‚Äì –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π / –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω–Ω—ã–π</h3>
          <span class="badge-soft">feelings & descriptions</span>
        </div>
        <div class="grammar-box">
          <ul class="examples-list">
            <li><strong>-ing</strong> ‚Äì –∫–∞–∫–æ–µ —á—Ç–æ-—Ç–æ: <em>The film is boring.</em></li>
            <li><strong>-ed</strong> ‚Äì –∫–∞–∫ –º—ã —Å–µ–±—è —á—É–≤—Å—Ç–≤—É–µ–º: <em>I am bored.</em></li>
          </ul>
        </div>
        <div class="exercise-title">–£–ø—Ä. 1. –í—ã–±–µ—Ä–∏—Ç–µ: -ing –∏–ª–∏ -ed.</div>
        <ol class="exercise-list">
          <li>The book is very <input data-answer="interesting" type="text" />.</li>
          <li>We were <input data-answer="tired" type="text" /> after the long trip.</li>
          <li>This game is <input data-answer="exciting" type="text" /> for teenagers.</li>
          <li>She felt <input data-answer="surprised" type="text" /> by the news.</li>
        </ol>
        <div class="topic-actions">
          <button class="btn btn-primary" onclick="checkCurrentTopic()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          <button class="btn btn-outline btn-print-hide" onclick="window.print()">–ü–µ—á–∞—Ç—å —Ç–µ–º—ã</button>
        </div>
        <p class="topic-result" id="topicResult"></p>
      `
    },
    {
      id: "t8",
      short: "Present Perfect vs Past Simple",
      title: "Present Perfect vs Past Simple",
      module: "Module 3",
      html: `
        <div class="topic-label">Topic 8 ¬∑ Module 3</div>
        <div class="topic-header-line">
          <h3>Present Perfect –∏ Past Simple</h3>
          <span class="badge-soft">–æ–ø—ã—Ç –∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤—Ä–µ–º—è</span>
        </div>
        <div class="grammar-box">
          <ul class="examples-list">
            <li><strong>Past Simple</strong> ‚Äì –∑–∞–∫–æ–Ω—á–µ–Ω–Ω–æ–µ –ø—Ä–æ—à–ª–æ–µ —Å –≤—Ä–µ–º–µ–Ω–µ–º: <em>We visited London last year.</em></li>
            <li><strong>Present Perfect</strong> ‚Äì —Ä–µ–∑—É–ª—å—Ç–∞—Ç/–æ–ø—ã—Ç, –≤–∞–∂–µ–Ω —Ñ–∞–∫—Ç: <em>We have visited London.</em></li>
            <li><strong>–°–∏–≥–Ω–∞–ª—ã:</strong> yesterday, last year ‚Üí Past Simple; ever, never, just, already, yet ‚Üí Present Perfect.</li>
          </ul>
        </div>
        <div class="exercise-title">–£–ø—Ä. 1. Present Perfect.</div>
        <ol class="exercise-list">
          <li>We <input data-answer="have visited" type="text" /> many countries.</li>
          <li>She <input data-answer="has just come" type="text" /> home.</li>
          <li>They <input data-answer="have never seen" type="text" /> the sea.</li>
        </ol>
        <div class="exercise-title">–£–ø—Ä. 2. –í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è.</div>
        <ol class="exercise-list">
          <li>I <input data-answer="visited" type="text" /> Astana last summer.</li>
          <li>I <input data-answer="have visited" type="text" /> Astana three times.</li>
          <li>He <input data-answer="has already done" type="text" /> his homework.</li>
          <li>We <input data-answer="watched" type="text" /> this film yesterday.</li>
        </ol>
        <div class="topic-actions">
          <button class="btn btn-primary" onclick="checkCurrentTopic()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç–≤–µ—Ç—ã</button>
          <button class="btn btn-outline btn-print-hide" onclick="window.print()">–ü–µ—á–∞—Ç—å —Ç–µ–º—ã</button>
        </div>
        <p class="topic-result" id="topicResult"></p>
      `
    }
  ];

  /* -------- STATE / STORAGE -------- */

  let currentUser = null; // {name, role}
  let currentTopicId = null;

  function getTodayKey() {
    return new Date().toISOString().slice(0, 10);
  }

  function loadAppState() {
    try {
      const raw = localStorage.getItem("aiBayan7_state");
      if (!raw) return { users: {} };
      return JSON.parse(raw);
    } catch {
      return { users: {} };
    }
  }

  function saveAppState(state) {
    localStorage.setItem("aiBayan7_state", JSON.stringify(state));
  }

  function updateUserState(name, fn) {
    const state = loadAppState();
    if (!state.users[name]) {
      state.users[name] = {
        role: "student",
        topics: {},
        totalStars: 0,
        totalAiQuestions: 0,
        aiUsage: {},
        lastLogin: null
      };
    }
    fn(state.users[name]);
    saveAppState(state);
  }

  /* -------- UI HELPERS -------- */

  const loginScreen = document.getElementById("loginScreen");
  const studentScreen = document.getElementById("studentScreen");
  const teacherScreen = document.getElementById("teacherScreen");
  const studentList = document.getElementById("studentList");
  const studentTopic = document.getElementById("studentTopic");
  const currentUserLabel = document.getElementById("currentUserLabel");

  function showScreen(name) {
    loginScreen.classList.add("hidden");
    studentScreen.classList.add("hidden");
    teacherScreen.classList.add("hidden");

    if (name === "login") loginScreen.classList.remove("hidden");
    if (name === "student") studentScreen.classList.remove("hidden");
    if (name === "teacher") teacherScreen.classList.remove("hidden");
  }

  function setCurrentUser(user) {
    currentUser = user;
    currentUserLabel.textContent = user
      ? (user.role === "teacher" ? "–£—á–∏—Ç–µ–ª—å: " : "–£—á–µ–Ω–∏–∫: ") + user.name
      : "–ù–µ –≤–æ—à–ª–∏";
  }

  /* -------- LOGIN -------- */

  document.getElementById("loginBtn").addEventListener("click", () => {
    const name = document.getElementById("nameInput").value.trim();
    const pin = document.getElementById("pinInput").value.trim();

    if (!name || !pin) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∏–º—è –∏ PIN.");
      return;
    }

    if (pin === TEACHER_PIN) {
      // teacher
      setCurrentUser({ name, role: "teacher" });
      updateUserState(name, u => {
        u.role = "teacher";
        u.lastLogin = new Date().toISOString();
      });
      renderTeacherTable();
      showScreen("teacher");
      return;
    }

    // student
    const allowed = allowedStudents.some(
      s => s.toLowerCase() === name.toLowerCase()
    );
    if (!allowed) {
      alert("–≠—Ç–æ –∏–º—è –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∏–º—è –∫–∞–∫ –≤ –∂—É—Ä–Ω–∞–ª–µ.");
      return;
    }

    setCurrentUser({ name, role: "student" });
    updateUserState(name, u => {
      u.role = "student";
      u.lastLogin = new Date().toISOString();
    });

    renderTopicsGrid();
    openTopic(topics[0].id); // —Å—Ä–∞–∑—É –æ—Ç–∫—Ä—ã—Ç—å –ø–µ—Ä–≤—É—é —Ç–µ–º—É
    updateAiLimitView();
    showScreen("student");
  });

  document.getElementById("clearStorageBtn").addEventListener("click", () => {
    if (confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–∑–≤—ë–∑–¥—ã, –∂—É—Ä–Ω–∞–ª, –ª–∏–º–∏—Ç AI) –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?")) {
      localStorage.removeItem("aiBayan7_state");
      alert("–ì–æ—Ç–æ–≤–æ. –õ–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å –æ—á–∏—â–µ–Ω.");
    }
  });

  /* -------- TOPICS LIST / STARS -------- */

  function calcStarsForTopic(correct, total) {
    if (!total) return 0;
    const pct = (correct / total) * 100;
    if (pct >= 85) return 3;
    if (pct >= 60) return 2;
    if (pct > 0) return 1;
    return 0;
  }

  function renderTopicsGrid() {
    const grid = document.getElementById("topicsGrid");
    grid.innerHTML = "";
    const state = loadAppState();
    const userData = currentUser ? state.users[currentUser.name] : null;

    topics.forEach(t => {
      let stars = "‚òÜ‚òÜ‚òÜ";
      if (userData && userData.topics && userData.topics[t.id]) {
        const s = userData.topics[t.id].stars || 0;
        stars = "‚òÖ".repeat(s) + "‚òÜ".repeat(3 - s);
      }

      const div = document.createElement("div");
      div.className = "topic-pill";
      div.innerHTML = `
        <div class="topic-title">${t.short}</div>
        <div class="topic-meta">
          <span>${t.module}</span>
          <span class="stars">${stars}</span>
        </div>
      `;
      div.addEventListener("click", () => openTopic(t.id));
      grid.appendChild(div);
    });

    // –ø—Ä–∏ –≤—Ö–æ–¥–µ ‚Äì –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫, –∞ –Ω–µ —Å—Ç–∞—Ä—ã–π —ç–∫—Ä–∞–Ω
    studentList.classList.remove("hidden");
    studentTopic.classList.add("hidden");
  }

  function openTopic(id) {
    if (!currentUser || currentUser.role !== "student") {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ —É—á–µ–Ω–∏–∫.");
      return;
    }
    currentTopicId = id;
    const topic = topics.find(t => t.id === id);
    const container = document.getElementById("topicContent");
    container.innerHTML = topic.html;

    studentList.classList.add("hidden");
    studentTopic.classList.remove("hidden");
    updateAiLimitView();
  }

  function backToTopicsList() {
    studentTopic.classList.add("hidden");
    studentList.classList.remove("hidden");
  }

  function checkCurrentTopic() {
    if (!currentUser || currentUser.role !== "student") {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ —É—á–µ–Ω–∏–∫.");
      return;
    }
    const container = document.getElementById("topicContent");
    const inputs = container.querySelectorAll("input[data-answer]");
    let total = 0;
    let correct = 0;

    inputs.forEach(input => {
      const expected = (input.dataset.answer || "").trim().toLowerCase();
      const value = (input.value || "").trim().toLowerCase();
      if (!expected) return;
      total++;
      if (value === expected) {
        correct++;
        input.classList.add("input-correct");
        input.classList.remove("input-wrong");
      } else {
        input.classList.add("input-wrong");
        input.classList.remove("input-correct");
      }
    });

    const resultEl =
      container.querySelector("#topicResult") ||
      container.querySelector(".topic-result");
    if (resultEl) {
      if (!total) {
        resultEl.textContent = "–í —ç—Ç–æ–π —Ç–µ–º–µ –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–æ–≤–µ—Ä—è–µ–º—ã—Ö –∑–∞–¥–∞–Ω–∏–π.";
        resultEl.classList.remove("good", "bad");
      } else {
        resultEl.textContent = `–ü—Ä–∞–≤–∏–ª—å–Ω–æ: ${correct} –∏–∑ ${total}`;
        const good = correct / total >= 0.6;
        resultEl.classList.toggle("good", good);
        resultEl.classList.toggle("bad", !good);
      }
    }

    updateUserState(currentUser.name, u => {
      if (!u.topics) u.topics = {};
      const stars = calcStarsForTopic(correct, total);
      u.topics[currentTopicId] = { correct, total, stars };
      let sum = 0;
      Object.values(u.topics).forEach(info => (sum += info.stars || 0));
      u.totalStars = sum;
    });

    renderTopicsGrid();
  }

  /* -------- AI CHAT -------- */

  const chatBox = document.getElementById("chatBox");
  const aiLimitEl = document.getElementById("aiLimit");
  const limitWarningEl = document.getElementById("limitWarning");

  function appendMessage(text, from) {
    const div = document.createElement("div");
    div.className = "msg " + (from === "user" ? "msg-user" : "msg-ai");
    div.textContent = text;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  function canAskAiToday() {
    if (!currentUser || currentUser.role !== "student") return false;
    const state = loadAppState();
    const u = state.users[currentUser.name] || {};
    const today = getTodayKey();
    const count = (u.aiUsage && u.aiUsage[today]) || 0;
    return count < 1;
  }

  function updateAiLimitView() {
    if (!currentUser || currentUser.role !== "student") {
      aiLimitEl.textContent = "(–¥–æ—Å—Ç—É–ø–Ω–æ —Ç–æ–ª—å–∫–æ —É—á–µ–Ω–∏–∫–∞–º)";
      limitWarningEl.textContent = "";
      return;
    }
    const state = loadAppState();
    const u = state.users[currentUser.name] || {};
    const today = getTodayKey();
    const count = (u.aiUsage && u.aiUsage[today]) || 0;
    const left = Math.max(0, 1 - count);
    aiLimitEl.textContent = `¬∑ —Å–µ–≥–æ–¥–Ω—è –æ—Å—Ç–∞–ª–æ—Å—å –≤–æ–ø—Ä–æ—Å–æ–≤: ${left}/1`;
    limitWarningEl.textContent = left === 0 ? "–õ–∏–º–∏—Ç –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏—Å—á–µ—Ä–ø–∞–Ω." : "";
  }

  async function sendToAiBayan() {
    if (!currentUser || currentUser.role !== "student") {
      alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ —É—á–µ–Ω–∏–∫.");
      return;
    }
    if (!canAskAiToday()) {
      limitWarningEl.textContent = "–õ–∏–º–∏—Ç 1 –≤–æ–ø—Ä–æ—Å –≤ –¥–µ–Ω—å —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω.";
      return;
    }

    const textarea = document.getElementById("aiQuestion");
    const question = textarea.value.trim();
    if (!question) return;

    appendMessage(question, "user");
    textarea.value = "";
    limitWarningEl.textContent = "";

    updateUserState(currentUser.name, u => {
      if (!u.aiUsage) u.aiUsage = {};
      const today = getTodayKey();
      if (!u.aiUsage[today]) u.aiUsage[today] = 0;
      u.aiUsage[today] += 1;
      u.totalAiQuestions = (u.totalAiQuestions || 0) + 1;
    });
    updateAiLimitView();

    appendMessage("AI Bayan –¥—É–º–∞–µ—Ç –Ω–∞–¥ –æ—Ç–≤–µ—Ç–æ–º... (–ø–æ–¥–∫–ª—é—á–∏—Ç–µ Cloudflare Worker)", "ai");

    // —Å—é–¥–∞ –ø–æ—Ç–æ–º –ø–æ–¥–∫–ª—é—á–∏—à—å –Ω–∞—Å—Ç–æ—è—â–∏–π Worker
  }

  document.getElementById("askBtn").addEventListener("click", sendToAiBayan);
  document.getElementById("aiQuestion").addEventListener("keydown", e => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendToAiBayan();
    }
  });

  /* -------- TEACHER JOURNAL -------- */

  function parseClassFromName(name) {
    if (!name) return "";
    const t = name.trim();
    return t.length >= 2 ? t.slice(-2) : "";
  }

  function renderTeacherTable() {
    const tbody = document.getElementById("teacherTableBody");
    tbody.innerHTML = "";
    const state = loadAppState();
    const today = getTodayKey();

    allowedStudents.forEach(stName => {
      const u = state.users[stName] || {};
      const completed = Object.keys(u.topics || {}).length;
      const stars = u.totalStars || 0;
      const aiTotal = u.totalAiQuestions || 0;
      const aiToday = (u.aiUsage && u.aiUsage[today]) || 0;
      const lastLogin = u.lastLogin
        ? new Date(u.lastLogin).toLocaleString()
        : "-";

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${stName}</td>
        <td>${parseClassFromName(stName)}</td>
        <td class="td-center">${completed}</td>
        <td class="td-center">${stars}</td>
        <td class="td-center">${aiTotal}</td>
        <td class="td-center">${aiToday}</td>
        <td>${lastLogin}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  /* -------- NAV BUTTONS -------- */

  document.getElementById("toStudentBtn").addEventListener("click", () => {
    if (!currentUser || currentUser.role !== "student") {
      showScreen("login");
    } else {
      renderTopicsGrid();
      showScreen("student");
    }
  });

  document.getElementById("toTeacherBtn").addEventListener("click", () => {
    if (!currentUser || currentUser.role !== "teacher") {
      alert("–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –∂—É—Ä–Ω–∞–ª—É –≤–æ–π–¥–∏—Ç–µ –∫–∞–∫ —É—á–∏—Ç–µ–ª—å —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º PIN.");
      showScreen("login");
    } else {
      renderTeacherTable();
      showScreen("teacher");
    }
  });

  document.getElementById("backToStudentFromTeacher").addEventListener("click", () => {
    if (currentUser && currentUser.role === "student") {
      renderTopicsGrid();
      showScreen("student");
    } else {
      showScreen("login");
    }
  });

  document.getElementById("printJournalBtn").addEventListener("click", () => {
    window.print();
  });

  /* -------- INIT -------- */
  showScreen("login");
</script>
</body>
</html>
