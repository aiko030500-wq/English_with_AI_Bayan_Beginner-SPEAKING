<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì Beginner READING</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --blue-main:#008b8b;   /* –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –±–∏—Ä—é–∑–æ–≤—ã–π */
      --blue-soft:#00b8b8;
      --gold:#ffd54f;
      --bg:#f1fbfd;
      --danger:#c62828;
      --correct:#1b5e20;
      --wrong:#b71c1c;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      background:var(--bg);
      color:#033244;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    button{
      border:none;
      border-radius:999px;
      padding:7px 15px;
      font-size:.85rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.15s;
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .btn-primary{
      background:var(--blue-main);
      color:#fff;
    }
    .btn-primary:hover:not(:disabled){
      background:#006d6d;
    }
    .btn-ghost{
      background:#ffffff;
      border:1px solid rgba(0,0,0,.1);
    }
    .btn-ghost:hover:not(:disabled){
      background:#f1f5f9;
    }

    /* ===== LOGIN ===== */

    #loginScreen{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 12px;
    }

    .login-card{
      background:#fff;
      border-radius:18px;
      box-shadow:0 3px 10px rgba(0,0,0,.15);
      max-width:420px;
      width:100%;
      padding:18px 18px 20px;
    }

    .login-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }

    .logo-circle{
      width:54px;
      height:54px;
      border-radius:50%;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex-shrink:0;
      box-shadow:0 0 0 3px rgba(0,139,139,.25);
    }
    .logo-circle img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .login-title-main{
      font-size:1rem;
      font-weight:700;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#005b5b;
    }
    .login-title-sub{
      font-size:.85rem;
      color:#007070;
    }

    .login-body{
      margin-top:10px;
      font-size:.88rem;
    }

    .login-body label{
      display:block;
      margin-bottom:6px;
      color:#004545;
      font-weight:600;
    }

    .login-body input{
      width:100%;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.2);
      font-size:.9rem;
      margin-bottom:8px;
      outline:none;
    }
    .login-body input:focus{
      border-color:var(--blue-main);
      box-shadow:0 0 0 2px rgba(0,139,139,.18);
    }

    .login-footer{
      margin-top:8px;
      font-size:.78rem;
      color:#607d8b;
      line-height:1.4;
    }

    .login-error{
      margin-top:6px;
      font-size:.8rem;
      color:#b71c1c;
    }

    .login-class-info{
      margin-top:4px;
      font-size:.8rem;
      color:#00695c;
    }

    /* ===== APP HEADER ===== */

    header{
      display:none;
      background:linear-gradient(90deg,#008b8b,#00b8b8);
      color:#fff;
      padding:10px 18px;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
      gap:12px;
    }

    .header-left{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .header-text-main{
      font-weight:700;
      font-size:.98rem;
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .header-text-sub{
      font-size:.8rem;
      opacity:.95;
    }

    .header-badge{
      background:rgba(255,255,255,.15);
      color:#e0ffff;
      padding:6px 10px;
      border-radius:999px;
      font-size:.78rem;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }

    .header-badge span.icon{
      font-size:1rem;
    }

    .user-chip{
      margin-top:2px;
      font-size:.76rem;
      background:rgba(0,0,0,.15);
      padding:3px 9px;
      border-radius:999px;
      display:inline-block;
    }

    /* ===== APP LAYOUT ===== */

    #appScreen{
      display:none;
      flex:1;
      flex-direction:column;
    }

    main{
      flex:1;
      max-width:1180px;
      width:100%;
      margin:0 auto;
      padding:14px 12px 26px;
      display:grid;
      gap:14px;
    }

    @media(min-width:900px){
      main{
        grid-template-columns:1.9fr 1.1fr;
        align-items:flex-start;
      }
    }

    .panel{
      background:#fff;
      border-radius:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      padding:14px 16px 18px;
    }

    .panel h2{
      font-size:1.02rem;
      margin-bottom:8px;
      color:#004545;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .panel h2 span.icon{
      width:22px;
      height:22px;
      border-radius:999px;
      background:var(--blue-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:.9rem;
    }

    .small-label{
      font-size:.8rem;
      color:#607d8b;
      margin-top:4px;
      margin-bottom:4px;
    }

    /* topic chips */

    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
      max-height:140px;
      overflow:auto;
      padding-right:2px;
    }

    .chip{
      border-radius:999px;
      padding:6px 11px;
      border:1px solid rgba(0,0,0,.08);
      font-size:.78rem;
      background:#f7ffff;
      cursor:pointer;
      transition:.15s;
      white-space:nowrap;
    }
    .chip:hover{
      background:#e0fbff;
    }
    .chip.active{
      background:var(--blue-main);
      color:#fff;
      border-color:var(--blue-main);
    }

    /* reading card */

    .reading-card{
      margin-top:8px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.05);
      padding:14px 14px 16px;
      background:linear-gradient(135deg,#ffffff,#e1f8ff);
    }

    .reading-topic-head{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:#006064;
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }

    .badge-level{
      padding:2px 9px;
      border-radius:999px;
      font-size:.7rem;
      background:#fff7e0;
      color:#8d5b00;
    }

    .reading-title{
      font-size:1rem;
      font-weight:600;
      margin-bottom:4px;
      color:#004d40;
    }

    .reading-text{
      font-size:.9rem;
      line-height:1.5;
      margin-bottom:6px;
    }

    .reading-vocab{
      font-size:.78rem;
      color:#455a64;
      background:#f8feff;
      border-radius:10px;
      padding:6px 8px;
      margin-bottom:8px;
    }

    .questions{
      margin-top:4px;
      font-size:.86rem;
    }

    .question{
      margin-bottom:8px;
      padding:6px 8px;
      border-radius:10px;
      background:#ffffff;
      border:1px solid rgba(0,0,0,.05);
    }

    .question.correct{
      border-color:var(--correct);
      background:#e8f5e9;
    }

    .question.wrong{
      border-color:var(--wrong);
      background:#ffebee;
    }

    .question-text{
      margin-bottom:4px;
      font-weight:500;
      color:#004055;
    }

    .option{
      display:block;
      margin-bottom:3px;
      cursor:pointer;
    }

    .question small{
      font-size:.75rem;
      color:#607d8b;
    }

    .reading-actions{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .reading-result{
      font-size:.8rem;
      color:#455a64;
      margin-top:4px;
    }

    .reading-result.good{
      color:var(--correct);
    }
    .reading-result.bad{
      color:var(--wrong);
    }

    .progress-info{
      margin-top:6px;
      font-size:.78rem;
      color:#455a64;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .progress-bar{
      flex:1;
      height:6px;
      border-radius:999px;
      background:#e0f2f1;
      overflow:hidden;
      min-width:80px;
    }

    .progress-bar-inner{
      height:100%;
      width:0%;
      background:var(--blue-main);
      transition:width .2s;
    }

    .done-badge{
      font-size:.75rem;
      padding:3px 9px;
      border-radius:999px;
      background:#e8f5e9;
      color:#1b5e20;
    }
    .done-badge.off{
      background:#ffebee;
      color:#b71c1c;
    }

    /* ===== RIGHT PANEL (AI + journal) ===== */

    .chat-note{
      font-size:.78rem;
      color:#607d8b;
      margin-bottom:6px;
    }

    .chat-note b{
      color:#004d40;
    }

    #aiLimit{
      font-weight:600;
      color:#004d40;
    }

    .chat-box{
      border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      padding:8px 10px;
      background:#f8feff;
      max-height:210px;
      overflow:auto;
      font-size:.8rem;
      margin-bottom:8px;
    }

    .chat-msg{
      margin-bottom:6px;
      padding:6px 8px;
      border-radius:10px;
    }

    .chat-msg.user{
      background:#e0f7fa;
    }

    .chat-msg.ai{
      background:#e8f5e9;
    }

    .chat-msg small{
      display:block;
      font-size:.7rem;
      color:#546e7a;
      margin-bottom:2px;
    }

    #aiQuestion{
      width:100%;
      min-height:60px;
      max-height:100px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.18);
      resize:vertical;
      font-size:.84rem;
      outline:none;
    }
    #aiQuestion:focus{
      border-color:var(--blue-main);
      box-shadow:0 0 0 2px rgba(0,139,139,.14);
    }

    .chat-actions{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      font-size:.78rem;
      color:#607d8b;
    }

    .danger-text{
      color:var(--danger);
      font-size:.78rem;
      margin-top:4px;
    }

    .journal-header{
      margin-top:10px;
      font-size:.84rem;
      font-weight:600;
      color:#004545;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }

    .journal-box{
      margin-top:6px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.08);
      padding:6px 8px;
      max-height:160px;
      overflow:auto;
      font-size:.78rem;
      background:#fafafa;
    }

    .journal-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:3px 0;
      border-bottom:1px dashed rgba(0,0,0,.07);
    }
    .journal-row:last-child{
      border-bottom:none;
    }
    .journal-row span.pin{
      font-weight:600;
      color:#004d40;
    }
    .journal-row span.info{
      color:#455a64;
    }

    @media(max-width:700px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      .header-badge{
        align-self:flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="loginScreen">
    <div class="login-card">
      <div class="login-header">
        <div class="logo-circle">
          <img src="logo.png" alt="AI Bayan logo" onerror="this.style.display='none';">
        </div>
        <div>
          <div class="login-title-main">ENGLISH WITH AI BAYAN</div>
          <div class="login-title-sub">BEGINNER ‚Äì READING with AI Bayan</div>
        </div>
      </div>

      <div class="login-body">
        <label for="pinInput">Enter your PIN code</label>
        <input id="pinInput" type="number" placeholder="Ask your teacher for PIN" />
        <button id="loginBtn" class="btn-primary">Login</button>
        <div id="loginError" class="login-error"></div>
        <div id="loginClassInfo" class="login-class-info"></div>
      </div>

      <div class="login-footer">
        PIN codes are the same as in ENGLISH WITH AI BAYAN ‚Äì Beginner.<br>
        If you don‚Äôt know your PIN, ask your teacher.
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appScreen">
    <header>
      <div class="header-left">
        <div class="logo-circle">
          <img src="logo.png" alt="AI Bayan logo" onerror="this.style.display='none';">
        </div>
        <div>
          <div class="header-text-main">ENGLISH WITH AI BAYAN</div>
          <div class="header-text-sub">
            Beginner ‚Äì READING ‚Ä¢ AI Bayan help (1 question per day)
          </div>
          <div id="userChip" class="user-chip"></div>
        </div>
      </div>
      <div class="header-badge">
        <span class="icon">üìñ</span>
        <span>Read the text and answer 4 questions</span>
      </div>
    </header>

    <main>
      <!-- LEFT: READING -->
      <section class="panel">
        <h2><span class="icon">üìö</span> Reading practice ‚Äì Beginner</h2>

        <p class="small-label">Choose a reading text:</p>
        <div id="topicChips" class="chips"></div>

        <div id="readingCard" class="reading-card">
          <div class="reading-topic-head">
            <span id="topicName">Choose a text above</span>
            <span id="topicLevel" class="badge-level"></span>
          </div>
          <div class="reading-title" id="readingTitle"></div>
          <div class="reading-text" id="readingText">
            Select one of the topics above to start reading.
          </div>
          <div class="reading-vocab" id="readingVocab" style="display:none;"></div>

          <div class="questions" id="questionsBox"></div>

          <div class="reading-actions">
            <button id="prevBtn" class="btn-ghost">‚Üê Previous</button>
            <button id="nextBtn" class="btn-primary">Next ‚Üí</button>
            <button id="randomBtn" class="btn-ghost">üé≤ Random</button>
            <button id="checkBtn" class="btn-primary">Check answers</button>
            <button id="resetBtn" class="btn-ghost">Reset</button>
          </div>
          <div id="readingResult" class="reading-result"></div>

          <div class="progress-info">
            <div id="doneStatus" class="done-badge off">Not completed</div>
            <div class="progress-bar">
              <div id="progressInner" class="progress-bar-inner"></div>
            </div>
            <div id="progressText">0 / 0 texts completed</div>
          </div>
        </div>

        <p class="small-label">
          Teacher idea: Students read silently, then work in pairs and compare answers before they click ‚ÄúCheck answers‚Äù.
        </p>
      </section>

      <!-- RIGHT: AI + JOURNAL -->
      <aside class="panel">
        <h2><span class="icon">ü§ñ</span> AI Bayan ‚Äì help for reading</h2>
        <p class="chat-note">
          Ask AI Bayan about <b>words, grammar or translation</b> from the text.<br>
          Limit: <b>1 question per day</b> for each PIN.<br>
          <span id="aiLimit"></span>
        </p>

        <div id="chatBox" class="chat-box"></div>

        <textarea id="aiQuestion"
          placeholder="Write your question for AI Bayan (English or Russian)..."></textarea>

        <div class="chat-actions">
          <button id="askBtn" class="btn-primary">Ask AI Bayan</button>
          <span>AI answers are saved only on this device.</span>
        </div>
        <div id="aiError" class="danger-text"></div>

        <div class="journal-header">
          <span>Teacher journal (this device)</span>
          <button id="refreshJournalBtn" class="btn-ghost">Refresh</button>
        </div>
        <div id="journalBox" class="journal-box">
          <div style="font-size:.78rem;color:#78909c;">
            Journal shows how many reading texts are completed by each PIN on this device.
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    /* ----- PIN ranges (–∫–∞–∫ –≤ Beginner, –±–µ–∑ –≤—ã–≤–æ–¥–∞ –ø–æ–¥—Å–∫–∞–∑–æ–∫ –Ω–∞ —ç–∫—Ä–∞–Ω) ----- */
    const classRanges = [
      { cls: "3E",  from: 101, to: 115 },
      { cls: "4G",  from: 201, to: 215 },
      { cls: "5G",  from: 301, to: 315 },
      { cls: "5Zh", from: 401, to: 415 },
      { cls: "6G",  from: 501, to: 515 },
      { cls: "7B",  from: 601, to: 615 },
      { cls: "7V",  from: 701, to: 715 },
      { cls: "8E",  from: 801, to: 815 },
      { cls: "9Zh", from: 901, to: 915 }
    ];
    function getClassByPin(pin){
      for(const r of classRanges){
        if(pin>=r.from && pin<=r.to) return r.cls;
      }
      return null;
    }

    /* ----- READING DATA (10 texts √ó 4 questions) ----- */
    const topics = [
      {
        id:1,
        name:"My School Day",
        level:"Beginner",
        title:"A Busy School Day",
        text:"My name is Aigerim and I am eleven years old. I usually get up at seven o‚Äôclock. I have a quick breakfast with my family and then I walk to school with my friend Dana. Our lessons start at eight. We have Maths, English and PE in the morning. I like English best because we play games and speak a lot. We usually finish school at one o‚Äôclock. In the afternoon I do my homework, help my mum and then I watch a little TV or play on my phone. I always go to bed before ten.",
        vocab:"quick breakfast ‚Äì –±—ã—Å—Ç—Ä—ã–π –∑–∞–≤—Ç—Ä–∞–∫; finish ‚Äì –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å; before ‚Äì –ø–µ—Ä–µ–¥.",
        questions:[
          {
            q:"What time does Aigerim usually get up?",
            options:["At six o‚Äôclock.","At seven o‚Äôclock.","At eight o‚Äôclock."],
            correct:1
          },
          {
            q:"How does she go to school?",
            options:["By bus.","By car.","On foot with her friend."],
            correct:2
          },
          {
            q:"Which subject does she like best?",
            options:["Maths.","English.","PE."],
            correct:1
          },
          {
            q:"What does she do in the afternoon?",
            options:["She sleeps all day.","She does homework and helps her mum.","She goes back to school."],
            correct:1
          }
        ]
      },
      {
        id:2,
        name:"My Best Friend",
        level:"Beginner",
        title:"My Best Friend Timur",
        text:"My best friend‚Äôs name is Timur. He is in my class. Timur is tall and slim. He has short dark hair and big brown eyes. He is very friendly and always helps other students. We usually sit together in English lessons. After school we sometimes play football in the yard or go to the park. Timur loves computer games, but he never forgets to do his homework. When I have a problem, I can always talk to him.",
        vocab:"slim ‚Äì —Å—Ç—Ä–æ–π–Ω—ã–π; friendly ‚Äì –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π; yard ‚Äì –¥–≤–æ—Ä.",
        questions:[
          {
            q:"Where is Timur?",
            options:["He is in another school.","He is in the writer‚Äôs class.","He is the writer‚Äôs teacher."],
            correct:1
          },
          {
            q:"What does Timur look like?",
            options:["He is tall and slim.","He is short and fat.","He has long blond hair."],
            correct:0
          },
          {
            q:"What do they do after school?",
            options:["They always study in the library.","They sometimes play football or go to the park.","They go shopping every day."],
            correct:1
          },
          {
            q:"What does Timur never forget?",
            options:["To feed his cat.","To play computer games.","To do his homework."],
            correct:2
          }
        ]
      },
      {
        id:3,
        name:"At the Zoo",
        level:"Beginner",
        title:"A Day at the Zoo",
        text:"Last Saturday my family visited the city zoo. It was sunny and warm. We saw many animals: lions, tigers, monkeys and giraffes. I liked the monkeys best because they were very funny. They jumped, played and ate bananas. My little brother was afraid of the lions because they were big and loud. At one o‚Äôclock we had lunch near the lake. After lunch we bought some souvenirs and went home by bus. It was a great day.",
        vocab:"afraid ‚Äì –±–æ—è—Ç—å—Å—è; loud ‚Äì –≥—Ä–æ–º–∫–∏–π; souvenirs ‚Äì —Å—É–≤–µ–Ω–∏—Ä—ã.",
        questions:[
          {
            q:"When did the family visit the zoo?",
            options:["Last Sunday.","Last Saturday.","Last Monday."],
            correct:1
          },
          {
            q:"Which animals did they see?",
            options:["Only monkeys.","Only lions and tigers.","Many animals, for example lions and giraffes."],
            correct:2
          },
          {
            q:"Why was the brother afraid?",
            options:["Because the lions were big and loud.","Because it was raining.","Because he was hungry."],
            correct:0
          },
          {
            q:"How did they go home?",
            options:["On foot.","By bus.","By car."],
            correct:1
          }
        ]
      },
      {
        id:4,
        name:"Rainy Sunday",
        level:"Beginner",
        title:"A Rainy Sunday at Home",
        text:"On Sunday the weather was terrible. It was cold, rainy and windy, so my family stayed at home. In the morning my mum baked apple pies in the kitchen. They smelled wonderful. My dad read a book in the living room. My sister and I did our homework and then played board games. After lunch we watched a funny film together. In the evening we drank hot tea with pie and talked. It was a quiet but very cosy day.",
        vocab:"terrible ‚Äì —É–∂–∞—Å–Ω—ã–π; smelled ‚Äì –ø–∞—Ö–ª–∏; cosy ‚Äì —É—é—Ç–Ω—ã–π.",
        questions:[
          {
            q:"Why did the family stay at home?",
            options:["Because it was very hot.","Because the weather was bad.","Because the TV was broken."],
            correct:1
          },
          {
            q:"What did the mum do?",
            options:["She baked apple pies.","She went shopping.","She watched a film all day."],
            correct:0
          },
          {
            q:"What did they do after lunch?",
            options:["They watched a film.","They went to the park.","They cleaned the house."],
            correct:0
          },
          {
            q:"How was the day?",
            options:["Quiet and cosy.","Very boring and lonely.","Very noisy and dangerous."],
            correct:0
          }
        ]
      },
      {
        id:5,
        name:"My Favourite Sport",
        level:"Beginner",
        title:"Playing Volleyball",
        text:"My favourite sport is volleyball. I play it twice a week in the school gym. Our PE teacher is strict but kind. First we warm up, run and stretch. Then we play in teams. I usually play in the same team with my friends Arman and Bek. I am not very tall, but I can jump well. Sometimes we take part in school competitions. When we win, we feel proud and happy.",
        vocab:"warm up ‚Äì —Ä–∞–∑–º–∏–Ω–∞—Ç—å—Å—è; stretch ‚Äì —Ç—è–Ω—É—Ç—å—Å—è; proud ‚Äì –≥–æ—Ä–¥—ã–π.",
        questions:[
          {
            q:"How often does the writer play volleyball?",
            options:["Every day.","Once a week.","Twice a week."],
            correct:2
          },
          {
            q:"Where do they play?",
            options:["In the school gym.","In the street.","On the beach."],
            correct:0
          },
          {
            q:"What is the teacher like?",
            options:["Strict but kind.","Very angry.","Very lazy."],
            correct:0
          },
          {
            q:"How do they feel when they win?",
            options:["Sad and tired.","Proud and happy.","Hungry and angry."],
            correct:1
          }
        ]
      },
      {
        id:6,
        name:"Visit to Granny",
        level:"Beginner",
        title:"Weekend at Granny‚Äôs House",
        text:"Every month I visit my granny in the village. She lives in a small but beautiful house with a big garden. In the morning we feed the chickens and water the flowers. Sometimes we pick apples and berries. My granny cooks very tasty soup and homemade bread. In the evening we sit on the bench in front of the house and watch the stars. I love these quiet weekends.",
        vocab:"pick ‚Äì —Å–æ–±–∏—Ä–∞—Ç—å; homemade ‚Äì –¥–æ–º–∞—à–Ω–∏–π; bench ‚Äì —Å–∫–∞–º–µ–π–∫–∞.",
        questions:[
          {
            q:"Where does granny live?",
            options:["In a big city.","In a village.","Near the sea."],
            correct:1
          },
          {
            q:"What do they do in the morning?",
            options:["They watch TV.","They feed chickens and water flowers.","They go to school."],
            correct:1
          },
          {
            q:"What does granny cook?",
            options:["Soup and homemade bread.","Only pizza.","Only sweets."],
            correct:0
          },
          {
            q:"What do they watch in the evening?",
            options:["Cars.","The sea.","The stars."],
            correct:2
          }
        ]
      },
      {
        id:7,
        name:"Day in the City",
        level:"Beginner",
        title:"A Day in Almaty",
        text:"Last month my class went on a trip to Almaty. We left early in the morning and arrived at ten o‚Äôclock. First we visited a museum and learned many interesting facts about the city. Then we had lunch in a small caf√©. After lunch we walked around the centre and took a lot of photos. In the evening we went to a shopping mall where we bought ice cream and small gifts for our families. We came home tired but excited.",
        vocab:"trip ‚Äì –ø–æ–µ–∑–¥–∫–∞; arrived ‚Äì –ø—Ä–∏–µ—Ö–∞–ª–∏; mall ‚Äì —Ç–æ—Ä–≥–æ–≤—ã–π —Ü–µ–Ω—Ç—Ä.",
        questions:[
          {
            q:"Where did the class go?",
            options:["To Astana.","To Almaty.","To the village."],
            correct:1
          },
          {
            q:"What did they do first?",
            options:["They went to the mall.","They visited a museum.","They had lunch."],
            correct:1
          },
          {
            q:"What did they buy in the mall?",
            options:["Books and pens.","Ice cream and gifts.","Shoes."],
            correct:1
          },
          {
            q:"How did they feel when they came home?",
            options:["Tired but excited.","Hungry and angry.","Sad."],
            correct:0
          }
        ]
      },
      {
        id:8,
        name:"Our Classroom",
        level:"Beginner",
        title:"My Bright Classroom",
        text:"Our classroom is on the second floor of the school. It is bright and clean. There are twenty desks for students and one big desk for the teacher. On the walls you can see colourful posters and our project work. At the back of the classroom there is a small library with English books and magazines. We often work in pairs or groups and sometimes we go to the board to present our projects. I feel comfortable in this classroom.",
        vocab:"bright ‚Äì —Å–≤–µ—Ç–ª—ã–π; project ‚Äì –ø—Ä–æ–µ–∫—Ç; present ‚Äì –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å.",
        questions:[
          {
            q:"Where is the classroom?",
            options:["On the first floor.","On the second floor.","In another building."],
            correct:1
          },
          {
            q:"What is on the walls?",
            options:["Only clocks.","Colourful posters and project work.","Nothing."],
            correct:1
          },
          {
            q:"What is at the back of the classroom?",
            options:["A small library.","A big TV.","A kitchen."],
            correct:0
          },
          {
            q:"How does the writer feel in this classroom?",
            options:["Uncomfortable.","Bored.","Comfortable."],
            correct:2
          }
        ]
      },
      {
        id:9,
        name:"Four Seasons",
        level:"Beginner",
        title:"The Four Seasons",
        text:"There are four seasons in a year: spring, summer, autumn and winter. In spring the weather gets warmer and trees become green. Many people feel happy after a long winter. In summer it is usually hot. Children have holidays and often go to camps, the sea or the village. Autumn is a colourful season with yellow and red leaves. It is time to go back to school. In winter it is cold and snowy. We can play snowballs, skate and drink hot tea at home.",
        vocab:"become ‚Äì —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è; leaves ‚Äì –ª–∏—Å—Ç—å—è; snowballs ‚Äì —Å–Ω–µ–∂–∫–∏.",
        questions:[
          {
            q:"What happens in spring?",
            options:["It gets colder.","Trees become green.","It snows a lot."],
            correct:1
          },
          {
            q:"What do children often do in summer?",
            options:["They go to camps or the sea.","They stay at school.","They sleep all day."],
            correct:0
          },
          {
            q:"What colour are the leaves in autumn?",
            options:["Blue and purple.","Yellow and red.","Black."],
            correct:1
          },
          {
            q:"What can we do in winter?",
            options:["Swim in the sea.","Plant flowers.","Play snowballs and skate."],
            correct:2
          }
        ]
      },
      {
        id:10,
        name:"New Student",
        level:"Beginner",
        title:"A New Student in Our Class",
        text:"This year we have a new student in our class. His name is Daniel and he comes from another city. On the first day he was very quiet and a little nervous. Our teacher asked everybody to introduce themselves. After the lesson I showed Daniel the canteen and the gym. Now he has many friends and he often laughs in class. He says our class is friendly and he is happy here.",
        vocab:"quiet ‚Äì —Ç–∏—Ö–∏–π; nervous ‚Äì –Ω–µ—Ä–≤–Ω—ã–π; introduce ‚Äì –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è.",
        questions:[
          {
            q:"Where does Daniel come from?",
            options:["From another city.","From another country.","From the same street."],
            correct:0
          },
          {
            q:"How did he feel on the first day?",
            options:["Very angry.","Quiet and nervous.","Very noisy."],
            correct:1
          },
          {
            q:"What did the writer do after the lesson?",
            options:["Went home.","Showed Daniel the canteen and the gym.","Gave Daniel homework."],
            correct:1
          },
          {
            q:"How does Daniel feel now?",
            options:["Unhappy and lonely.","Still nervous.","Happy in this class."],
            correct:2
          }
        ]
      }
    ];

    /* ----- STATE & STORAGE ----- */
    let currentUser=null;   // {pin,cls}
    let currentTopic=null;
    let currentIndex=0;

    const PROGRESS_KEY="aiBayanReadingProgress";
    const AI_USAGE_KEY="aiBayanReadingAiUsage";

    // progress[pin][topicId] = true/false (completed)
    let progress=loadJson(PROGRESS_KEY) || {};
    // aiUsage[pin]={date,count}
    let aiUsage=loadJson(AI_USAGE_KEY) || {};

    function loadJson(key){
      try{
        const raw=localStorage.getItem(key);
        return raw?JSON.parse(raw):null;
      }catch(e){return null;}
    }
    function saveJson(key,obj){
      try{localStorage.setItem(key,JSON.stringify(obj));}catch(e){}
    }

    function todayStr(){return new Date().toISOString().slice(0,10);}

    /* ----- DOM ----- */
    const loginScreen=document.getElementById("loginScreen");
    const appScreen=document.getElementById("appScreen");
    const loginBtn=document.getElementById("loginBtn");
    const pinInput=document.getElementById("pinInput");
    const loginError=document.getElementById("loginError");
    const loginClassInfo=document.getElementById("loginClassInfo");
    const userChip=document.getElementById("userChip");

    const topicChips=document.getElementById("topicChips");
    const topicNameEl=document.getElementById("topicName");
    const topicLevelEl=document.getElementById("topicLevel");
    const readingTitleEl=document.getElementById("readingTitle");
    const readingTextEl=document.getElementById("readingText");
    const readingVocabEl=document.getElementById("readingVocab");
    const questionsBox=document.getElementById("questionsBox");

    const prevBtn=document.getElementById("prevBtn");
    const nextBtn=document.getElementById("nextBtn");
    const randomBtn=document.getElementById("randomBtn");
    const checkBtn=document.getElementById("checkBtn");
    const resetBtn=document.getElementById("resetBtn");
    const readingResult=document.getElementById("readingResult");
    const doneStatus=document.getElementById("doneStatus");
    const progressInner=document.getElementById("progressInner");
    const progressText=document.getElementById("progressText");

    const chatBox=document.getElementById("chatBox");
    const aiQuestion=document.getElementById("aiQuestion");
    const askBtn=document.getElementById("askBtn");
    const aiLimitEl=document.getElementById("aiLimit");
    const aiError=document.getElementById("aiError");

    const journalBox=document.getElementById("journalBox");
    const refreshJournalBtn=document.getElementById("refreshJournalBtn");

    /* ----- LOGIN LOGIC ----- */
    loginBtn.addEventListener("click",handleLogin);
    pinInput.addEventListener("keydown",e=>{
      if(e.key==="Enter") handleLogin();
    });

    function handleLogin(){
      const pin=Number(pinInput.value.trim());
      loginError.textContent="";
      loginClassInfo.textContent="";

      if(!pin || isNaN(pin)){
        loginError.textContent="Please enter your PIN code.";
        return;
      }
      const cls=getClassByPin(pin);
      if(!cls){
        loginError.textContent="PIN not found. Ask your teacher.";
        return;
      }
      currentUser={pin,cls};
      userChip.textContent="Class "+cls+" ‚Ä¢ PIN "+pin;
      loginClassInfo.textContent="Welcome! Class "+cls+". You can start reading practice.";

      loginScreen.style.display="none";
      appScreen.style.display="flex";
      document.querySelector("header").style.display="flex";

      renderTopics();
      renderTopic();
      updateAiLimitInfo();
      renderJournal();
    }

    /* ----- TOPICS UI ----- */
    function renderTopics(){
      topicChips.innerHTML="";
      topics.forEach(t=>{
        const chip=document.createElement("button");
        chip.className="chip";
        chip.textContent=t.id+". "+t.name;
        chip.dataset.id=t.id;
        chip.addEventListener("click",()=>selectTopic(t.id));
        topicChips.appendChild(chip);
      });
      updateActiveChip();
      updateProgressBar();
    }

    function updateActiveChip(){
      const chips=document.querySelectorAll(".chip");
      chips.forEach(ch=>{
        const id=Number(ch.dataset.id);
        ch.classList.toggle("active",currentTopic && currentTopic.id===id);
      });
    }

    function selectTopic(id){
      const t=topics.find(x=>x.id===id);
      if(!t) return;
      currentTopic=t;
      currentIndex=topics.indexOf(t); // –¥–ª—è next/prev
      renderTopic();
    }

    function renderTopic(){
      if(!currentTopic){
        topicNameEl.textContent="Choose a text above";
        topicLevelEl.textContent="";
        readingTitleEl.textContent="";
        readingTextEl.textContent="Select one of the topics above to start reading.";
        readingVocabEl.style.display="none";
        questionsBox.innerHTML="";
        updateProgressBar();
        return;
      }
      updateActiveChip();

      topicNameEl.textContent=currentTopic.name;
      topicLevelEl.textContent=currentTopic.level;
      readingTitleEl.textContent=currentTopic.title;
      readingTextEl.textContent=currentTopic.text;
      if(currentTopic.vocab){
        readingVocabEl.style.display="block";
        readingVocabEl.textContent="Vocabulary: "+currentTopic.vocab;
      }else{
        readingVocabEl.style.display="none";
      }
      renderQuestions();
      readingResult.textContent="";
      readingResult.classList.remove("good","bad");
      updateProgressBar();
    }

    function renderQuestions(){
      questionsBox.innerHTML="";
      currentTopic.questions.forEach((qObj,qIndex)=>{
        const qDiv=document.createElement("div");
        qDiv.className="question";
        qDiv.dataset.index=qIndex;

        const qText=document.createElement("div");
        qText.className="question-text";
        qText.textContent=(qIndex+1)+". "+qObj.q;
        qDiv.appendChild(qText);

        qObj.options.forEach((opt,optIndex)=>{
          const label=document.createElement("label");
          label.className="option";
          const radio=document.createElement("input");
          radio.type="radio";
          radio.name="q"+qIndex;
          radio.value=optIndex;
          label.appendChild(radio);
          label.appendChild(document.createTextNode(" "+opt));
          qDiv.appendChild(label);
        });

        const note=document.createElement("small");
        note.textContent="";
        qDiv.appendChild(note);

        questionsBox.appendChild(qDiv);
      });
    }

    /* ----- CHECK ANSWERS ----- */
    checkBtn.addEventListener("click",()=>{
      if(!currentTopic) return;
      const qDivs=[...questionsBox.querySelectorAll(".question")];
      let correctCount=0;
      qDivs.forEach((div,idx)=>{
        div.classList.remove("correct","wrong");
        const radios=[...div.querySelectorAll("input[type=radio]")];
        const chosen=radios.find(r=>r.checked);
        const small=div.querySelector("small");
        const correctIndex=currentTopic.questions[idx].correct;
        if(!chosen){
          small.textContent="Choose an answer.";
          return;
        }
        const value=Number(chosen.value);
        if(value===correctIndex){
          correctCount++;
          div.classList.add("correct");
          small.textContent="Correct!";
        }else{
          div.classList.add("wrong");
          small.textContent="Wrong. Try again.";
        }
      });

      const total=currentTopic.questions.length;
      if(correctCount===total){
        readingResult.textContent="Perfect! You answered all questions correctly.";
        readingResult.classList.add("good");
        readingResult.classList.remove("bad");
        markTopicCompleted();
      }else{
        readingResult.textContent="You got "+correctCount+" of "+total+". Check the red questions.";
        readingResult.classList.add("bad");
        readingResult.classList.remove("good");
      }
      updateProgressBar();
      renderJournal();
    });

    resetBtn.addEventListener("click",()=>{
      if(!currentTopic) return;
      renderQuestions();
      readingResult.textContent="";
      readingResult.classList.remove("good","bad");
      const qDivs=[...questionsBox.querySelectorAll(".question")];
      qDivs.forEach(div=>{
        div.classList.remove("correct","wrong");
      });
    });

    /* prev/next/random */
    prevBtn.addEventListener("click",()=>{
      if(!currentTopic) return;
      currentIndex=(currentIndex-1+topics.length)%topics.length;
      currentTopic=topics[currentIndex];
      renderTopic();
    });
    nextBtn.addEventListener("click",()=>{
      if(!currentTopic) return;
      currentIndex=(currentIndex+1)%topics.length;
      currentTopic=topics[currentIndex];
      renderTopic();
    });
    randomBtn.addEventListener("click",()=>{
      let newIndex=currentIndex;
      while(newIndex===currentIndex){
        newIndex=Math.floor(Math.random()*topics.length);
      }
      currentIndex=newIndex;
      currentTopic=topics[currentIndex];
      renderTopic();
    });

    /* ----- PROGRESS / JOURNAL ----- */
    function getUserProgress(){
      if(!currentUser) return null;
      if(!progress[currentUser.pin]) progress[currentUser.pin]={};
      return progress[currentUser.pin];
    }

    function markTopicCompleted(){
      if(!currentUser || !currentTopic) return;
      const userProg=getUserProgress();
      userProg[currentTopic.id]=true;
      saveJson(PROGRESS_KEY,progress);
    }

    function isTopicCompletedForUser(topicId){
      if(!currentUser) return false;
      const userProg=getUserProgress();
      return !!userProg[topicId];
    }

    function updateProgressBar(){
      if(!currentUser){
        doneStatus.textContent="Not completed";
        doneStatus.classList.add("off");
        progressInner.style.width="0%";
        progressText.textContent="0 / 0 texts completed";
        return;
      }
      const userProg=getUserProgress();
      const total=topics.length;
      let done=0;
      topics.forEach(t=>{
        if(userProg[t.id]) done++;
      });

      if(currentTopic && userProg[currentTopic.id]){
        doneStatus.textContent="Completed ‚úî";
        doneStatus.classList.remove("off");
      }else{
        doneStatus.textContent="Not completed";
        doneStatus.classList.add("off");
      }

      const percent=total?(done/total)*100:0;
      progressInner.style.width=percent+"%";
      progressText.textContent=done+" / "+total+" texts completed";
    }

    function renderJournal(){
      journalBox.innerHTML="";
      const info=document.createElement("div");
      info.style.fontSize=".78rem";
      info.style.color="#78909c";
      info.textContent="Journal shows how many reading texts are fully correct for each PIN on this device.";
      journalBox.appendChild(info);

      const pins=Object.keys(progress).map(p=>Number(p)).sort((a,b)=>a-b);
      if(pins.length===0){
        const empty=document.createElement("div");
        empty.style.fontSize=".8rem";
        empty.style.marginTop="6px";
        empty.textContent="No data yet. When students complete texts, you will see it here.";
        journalBox.appendChild(empty);
        return;
      }

      pins.forEach(pin=>{
        const cls=getClassByPin(pin) || "?";
        const userProg=progress[pin] || {};
        let done=0;
        for(const topicId in userProg){
          if(userProg[topicId]) done++;
        }
        const row=document.createElement("div");
        row.className="journal-row";

        const left=document.createElement("span");
        left.className="pin";
        left.textContent="PIN "+pin+" (class "+cls+")";

        const right=document.createElement("span");
        right.className="info";
        right.textContent=done+" / "+topics.length+" texts completed";

        row.appendChild(left);
        row.appendChild(right);
        journalBox.appendChild(row);
      });
    }
    refreshJournalBtn.addEventListener("click",renderJournal);

    /* ----- AI BAYAN ----- */
    const AI_ENDPOINT="https://shiny-tree-f78c.aiko030500.workers.dev/";

    function getRemainingQuestionsToday(){
      if(!currentUser) return 0;
      const pin=currentUser.pin;
      const today=todayStr();
      const rec=aiUsage[pin];
      if(!rec || rec.date!==today) return 1; // –ª–∏–º–∏—Ç 1 / –¥–µ–Ω—å
      const used=rec.count||0;
      return Math.max(0,1-used);
    }

    function updateAiLimitInfo(){
      if(!currentUser){
        aiLimitEl.textContent="";
        askBtn.disabled=true;
        return;
      }
      const left=getRemainingQuestionsToday();
      if(left<=0){
        aiLimitEl.textContent="Today you have used your 1 question. Come back tomorrow.";
        askBtn.disabled=true;
      }else{
        aiLimitEl.textContent="You can ask "+left+" question today.";
        askBtn.disabled=false;
      }
    }

    function appendChatMessage(role,text){
      const div=document.createElement("div");
      div.className="chat-msg "+(role==="user"?"user":"ai");
      const small=document.createElement("small");
      small.textContent=role==="user"?"You":"AI Bayan";
      const p=document.createElement("div");
      p.textContent=text;
      div.appendChild(small);
      div.appendChild(p);
      chatBox.appendChild(div);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    askBtn.addEventListener("click",sendToAiBayan);
    aiQuestion.addEventListener("keydown",e=>{
      if(e.key==="Enter" && (e.ctrlKey || e.metaKey)){
        e.preventDefault();
        sendToAiBayan();
      }
    });

    function sendToAiBayan(){
      aiError.textContent="";
      if(!currentUser){
        aiError.textContent="Please login with your PIN.";
        return;
      }
      const left=getRemainingQuestionsToday();
      if(left<=0){
        aiError.textContent="Limit reached: 1 AI question per day for this PIN.";
        updateAiLimitInfo();
        return;
      }
      const q=aiQuestion.value.trim();
      if(!q){
        aiError.textContent="Write a question for AI Bayan.";
        return;
      }

      appendChatMessage("user",q);
      aiQuestion.value="";
      askBtn.disabled=true;
      askBtn.textContent="Asking...";

      const payload={
        question:q,
        pin:currentUser.pin,
        cls:currentUser.cls,
        section:"reading_beginner",
        topic: currentTopic ? currentTopic.name : null,
        ts:new Date().toISOString()
      };

      fetch(AI_ENDPOINT,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      })
      .then(res=>res.text())
      .then(text=>{
        let answer=text;
        try{
          const obj=JSON.parse(text);
          answer=obj.answer || obj.response || obj.result || text;
        }catch(e){}
        appendChatMessage("ai",answer || "AI Bayan sent an empty answer.");
        const pin=currentUser.pin;
        const today=todayStr();
        const rec=aiUsage[pin];
        if(!rec || rec.date!==today){
          aiUsage[pin]={date:today,count:1};
        }else{
          aiUsage[pin].count=(aiUsage[pin].count||0)+1;
        }
        saveJson(AI_USAGE_KEY,aiUsage);
        updateAiLimitInfo();
      })
      .catch(err=>{
        console.error(err);
        aiError.textContent="Error: cannot connect to AI Bayan now.";
      })
      .finally(()=>{
        askBtn.disabled=getRemainingQuestionsToday()<=0;
        askBtn.textContent="Ask AI Bayan";
      });
    }

    /* ----- INIT ----- */
    renderTopics();
    renderTopic();
  </script>
</body>
</html>
