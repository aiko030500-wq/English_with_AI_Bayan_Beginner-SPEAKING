<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì 7 Grade Grammar</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --watermelon-red:#ff5c7a;
      --watermelon-dark:#c62828;
      --watermelon-green:#2e7d32;
      --watermelon-light:#a5d6a7;
      --bg:#fffdf7;
      --card:#ffffff;
      --text-main:#263238;
      --border-soft:#ffe0e6;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      background:var(--bg);
      color:var(--text-main);
    }

    header{
      background:linear-gradient(90deg,var(--watermelon-green),var(--watermelon-red));
      color:#fff;
      padding:12px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,0.15);
    }

    header .brand{
      font-weight:700;
      letter-spacing:0.05em;
      text-transform:uppercase;
      font-size:14px;
    }

    header .brand span{
      display:block;
      font-size:11px;
      font-weight:500;
      opacity:0.9;
    }

    header .logo-dot{
      width:32px;
      height:32px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#fff8e1 0,var(--watermelon-red) 60%,var(--watermelon-dark) 100%);
      box-shadow:0 0 0 3px rgba(255,255,255,0.6);
      position:relative;
      margin-right:10px;
    }

    header .logo-dot::before,
    header .logo-dot::after{
      content:"";
      position:absolute;
      background:#00000066;
      border-radius:50%;
    }

    header .logo-dot::before{
      width:4px;
      height:4px;
      top:7px;
      left:11px;
    }

    header .logo-dot::after{
      width:4px;
      height:4px;
      top:14px;
      left:18px;
    }

    header .right-info{
      font-size:11px;
      text-align:right;
    }

    main{
      max-width:1100px;
      margin:18px auto;
      padding:0 12px 40px;
    }

    .screen{
      display:none;
    }

    .card{
      background:var(--card);
      border-radius:14px;
      padding:18px 16px;
      box-shadow:0 2px 8px rgba(0,0,0,0.06);
      border:1px solid var(--border-soft);
    }

    .card + .card{
      margin-top:14px;
    }

    .login-layout{
      display:grid;
      grid-template-columns:minmax(0,1.2fr) minmax(0,1fr);
      gap:18px;
    }

    @media(max-width:768px){
      .login-layout{
        grid-template-columns:1fr;
      }
    }

    h1,h2,h3{
      font-weight:700;
      margin-bottom:10px;
    }

    h1{
      font-size:20px;
    }

    h2{
      font-size:18px;
    }

    h3{
      font-size:16px;
    }

    .field{
      margin-bottom:12px;
    }

    .field label{
      display:block;
      font-size:13px;
      margin-bottom:4px;
      font-weight:600;
    }

    .field input,
    .field textarea,
    .field select{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid #cfd8dc;
      font-size:14px;
      outline:none;
      transition:border-color .15s, box-shadow .15s;
      background:#fafafa;
    }

    .field input:focus,
    .field textarea:focus,
    .field select:focus{
      border-color:var(--watermelon-green);
      box-shadow:0 0 0 2px rgba(46,125,50,0.18);
      background:#ffffff;
    }

    .btn-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    .btn{
      border:none;
      cursor:pointer;
      border-radius:999px;
      padding:8px 14px;
      font-size:13px;
      font-weight:600;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:transform .1s, box-shadow .1s, background .15s;
      white-space:nowrap;
    }

    .btn-primary{
      background:var(--watermelon-green);
      color:#fff;
      box-shadow:0 2px 6px rgba(46,125,50,0.4);
    }

    .btn-primary:hover{
      transform:translateY(-1px);
      box-shadow:0 3px 8px rgba(46,125,50,0.5);
    }

    .btn-ghost{
      background:#ffffff;
      color:var(--watermelon-green);
      border:1px solid rgba(46,125,50,0.4);
    }

    .btn-ghost:hover{
      background:#f1f8e9;
    }

    .btn-danger{
      background:var(--watermelon-red);
      color:#fff;
      box-shadow:0 2px 6px rgba(255,92,122,0.4);
    }

    .hint{
      font-size:12px;
      color:#546e7a;
      margin-top:4px;
    }

    .error{
      color:#c62828;
      font-size:12px;
      margin-top:6px;
    }

    .success{
      color:var(--watermelon-green);
      font-size:12px;
      margin-top:6px;
    }

    .login-hero-title{
      font-size:18px;
      margin-bottom:6px;
      font-weight:700;
    }

    .login-hero-list{
      margin:6px 0 0 18px;
      font-size:13px;
    }

    .login-hero-list li{
      margin-bottom:3px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:4px;
      border-radius:999px;
      padding:3px 8px;
      font-size:11px;
      background:var(--watermelon-light);
      color:#1b5e20;
      font-weight:600;
    }

    .badge span.seed{
      width:6px;
      height:6px;
      border-radius:50%;
      background:#00000080;
    }

    .top-bar{
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:14px;
    }

    .top-bar .info{
      font-size:13px;
    }

    .top-bar strong{
      font-weight:700;
    }

    .top-bar .stats{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      font-size:12px;
    }

    .pill{
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      background:#fce4ec;
      color:#ad1457;
      display:inline-flex;
      align-items:center;
      gap:4px;
    }

    .pill.green{
      background:#e8f5e9;
      color:#2e7d32;
    }

    .pill.yellow{
      background:#fff8e1;
      color:#f9a825;
    }

    .layout-main{
      display:grid;
      grid-template-columns:minmax(0,2fr) minmax(0,1.2fr);
      gap:16px;
      align-items:flex-start;
    }

    @media(max-width:960px){
      .layout-main{
        grid-template-columns:1fr;
      }
    }

    .topics-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
      gap:10px;
    }

    .topic-card{
      border-radius:12px;
      border:1px solid #ffe0e6;
      padding:10px 10px 12px;
      background:linear-gradient(135deg,#fff,#fff7f9);
      position:relative;
      overflow:hidden;
    }

    .topic-tag{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.05em;
      color:#c2185b;
      margin-bottom:4px;
    }

    .topic-title{
      font-weight:700;
      font-size:14px;
      margin-bottom:4px;
    }

    .topic-meta{
      font-size:11px;
      color:#607d8b;
      margin-bottom:6px;
    }

    .topic-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:6px;
      font-size:11px;
    }

    .topic-progress-bar{
      position:relative;
      flex:1;
      height:6px;
      border-radius:999px;
      background:#ffe4ec;
      overflow:hidden;
      margin-right:8px;
    }

    .topic-progress-fill{
      position:absolute;
      left:0;
      top:0;
      bottom:0;
      width:0;
      background:linear-gradient(90deg,var(--watermelon-green),var(--watermelon-red));
      transition:width .2s;
    }

    .topic-card small{
      font-size:10px;
      color:#546e7a;
    }

    .topic-card::after{
      content:"";
      position:absolute;
      width:120px;
      height:120px;
      background:radial-gradient(circle at 30% 30%,rgba(255,255,255,0.6),rgba(255,92,122,0.45));
      right:-40px;
      top:-50px;
      opacity:0.7;
    }

    .topic-card button{
      position:relative;
      z-index:1;
    }

    .topic-detail{
      margin-top:14px;
      border-radius:14px;
      border:1px dashed #ffcdd2;
      padding:12px 10px 10px;
      background:#fffdfd;
    }

    .topic-detail h3{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }

    .topic-detail h3 span.circle{
      width:20px;
      height:20px;
      border-radius:50%;
      background:var(--watermelon-red);
      color:#fff;
      font-size:11px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
    }

    .topic-detail .theory{
      font-size:13px;
      margin-bottom:8px;
    }

    .topic-detail .theory p{
      margin-bottom:4px;
    }

    .topic-detail ul{
      margin:4px 0 6px 18px;
      font-size:13px;
    }

    .tasks-list{
      margin-top:6px;
      border-top:1px dashed #ffe0e6;
      padding-top:6px;
    }

    .tasks-list h4{
      font-size:13px;
      margin-bottom:4px;
    }

    .task-item{
      display:flex;
      align-items:flex-start;
      gap:6px;
      font-size:13px;
      margin-bottom:3px;
    }

    .task-item input[type="checkbox"]{
      margin-top:3px;
      cursor:pointer;
    }

    .task-item label{
      cursor:pointer;
    }

    #aiPanel{
      border-radius:14px;
      padding:12px 10px;
      background:#fce4ec;
      border:1px solid #f8bbd0;
      display:flex;
      flex-direction:column;
      gap:8px;
      max-height:520px;
    }

    #aiPanel h3{
      font-size:15px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    #aiLimitInfo{
      font-size:11px;
      color:#ad1457;
      background:#fff;
      border-radius:999px;
      padding:2px 8px;
    }

    .chat-box{
      flex:1;
      border-radius:10px;
      background:#ffffff;
      padding:8px;
      border:1px solid #f8bbd0;
      overflow-y:auto;
      font-size:12px;
    }

    .chat-message{
      margin-bottom:6px;
      line-height:1.3;
    }

    .chat-message.me{
      text-align:right;
    }

    .chat-message.me span.bubble{
      background:#c8e6c9;
    }

    .chat-message.ai span.bubble{
      background:#f3e5f5;
    }

    .chat-message span.bubble{
      display:inline-block;
      padding:5px 8px;
      border-radius:10px;
    }

    .chat-message small{
      display:block;
      font-size:10px;
      color:#78909c;
      margin-top:1px;
    }

    #aiQuestion{
      resize:vertical;
      min-height:60px;
      max-height:100px;
    }

    .chat-actions{
      display:flex;
      justify-content:flex-end;
      margin-top:4px;
    }

    .chat-note{
      font-size:11px;
      color:#6a1b9a;
    }

    .teacher-table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
      margin-top:8px;
    }

    .teacher-table th,
    .teacher-table td{
      padding:6px 5px;
      border-bottom:1px solid #eceff1;
      text-align:left;
      vertical-align:top;
    }

    .teacher-table th{
      background:#f1f8e9;
      font-weight:700;
      font-size:11px;
    }

    .teacher-table tbody tr:nth-child(even){
      background:#fafafa;
    }

    .teacher-table .name-col{
      font-weight:600;
      font-size:12px;
    }

    .teacher-table small{
      font-size:10px;
      color:#607d8b;
    }

    /* --- –ü–µ—á–∞—Ç—å: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —É—á–µ–Ω–∏–∫–∞ + –æ—Ç–∫—Ä—ã—Ç—É—é —Ç–µ–º—É --- */
    @media print{
      header,
      #loginScreen,
      #teacherScreen,
      #aiPanel,
      .btn,
      #topicsList{
        display:none !important;
      }
      body{
        background:#ffffff;
      }
      main{
        margin:0;
        padding:0 10px;
      }
      .topic-detail{
        border:1px solid #00000033;
        background:#ffffff;
      }
      .top-bar{
        margin-top:5px;
      }
    }
  </style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:10px;">
    <div class="logo-dot"></div>
    <div class="brand">
      ENGLISH WITH AI BAYAN
      <span>7 GRADE ‚Äì GRAMMAR &amp; WORKBOOK</span>
    </div>
  </div>
  <div class="right-info">
    <div>AI Bayan ‚Ä¢ Grammar + Workbook</div>
    <div style="font-size:10px;opacity:0.9;">Watermelon edition üçâ</div>
  </div>
</header>

<main>

  <!-- LOGIN -->
  <section id="loginScreen" class="screen">
    <div class="login-layout">
      <div class="card">
        <h1>–í—Ö–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h1>
        <p class="hint">–í–≤–µ–¥–∏—Ç–µ <b>—Å–≤–æ—ë –∏–º—è</b> –∏ <b>–ü–ò–ù-–∫–æ–¥</b>, –∫–æ—Ç–æ—Ä—ã–π –≤–∞–º –¥–∞–ª–∞ —É—á–∏—Ç–µ–ª—å.</p>

        <div class="field" style="margin-top:10px;">
          <label for="studentName">–ò–º—è —É—á–µ–Ω–∏–∫–∞ (–±–µ–∑ –ø–æ–¥—Å–∫–∞–∑–æ–∫)</label>
          <input id="studentName" type="text" autocomplete="off" />
        </div>

        <div class="field">
          <label for="pinInput">–ü–ò–ù-–∫–æ–¥</label>
          <input id="pinInput" type="password" autocomplete="off" />
        </div>

        <div id="loginMessage" class="error" style="display:none;"></div>

        <div class="btn-row">
          <button class="btn btn-primary" id="loginBtn">–í–æ–π—Ç–∏</button>
          <button class="btn btn-ghost" id="printAllBtn">–ü–µ—á–∞—Ç—å –≤—Å–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã</button>
        </div>

        <p class="hint">
          ‚Ä¢ <b>–£—á–∏—Ç–µ–ª—å</b> –≤—Ö–æ–¥–∏—Ç —Ç–æ–ª—å–∫–æ –ø–æ —É—á–∏—Ç–µ–ª—å—Å–∫–æ–º—É –ü–ò–ù-–∫–æ–¥—É.<br>
          ‚Ä¢ <b>–£—á–µ–Ω–∏–∫–∏</b> –≤—Ö–æ–¥—è—Ç —Ç–æ–ª—å–∫–æ –ø–æ —Å–≤–æ–µ–º—É –ü–ò–ù-–∫–æ–¥—É –∏ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω–æ–º—É –∏–º–µ–Ω–∏.<br>
          ‚Ä¢ –ü–æ–¥—Å–∫–∞–∑–∫–∏ –ø–æ –∏–º–µ–Ω–∞–º –∏ –ü–ò–ù-–∫–æ–¥–∞–º —É—á–∏—Ç–µ–ª—å –æ–±—ä—è—Å–Ω—è–µ—Ç –æ—Ç–¥–µ–ª—å–Ω–æ.
        </p>
      </div>

      <div class="card">
        <div class="login-hero-title">–ß—Ç–æ –≤–Ω—É—Ç—Ä–∏ ‚ÄúGrammar 7‚Äù?</div>
        <ul class="login-hero-list">
          <li>–ì—Ä–∞–º–º–∞—Ç–∏–∫–∞ –ø–æ Student‚Äôs Book, —Ç–µ–º—ã –æ—Ç–¥–µ–ª—å–Ω–æ.</li>
          <li>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ Workbook —Å –≥–∞–ª–æ—á–∫–∞–º–∏ –∏ –ø–æ–¥—Å—á—ë—Ç–æ–º.</li>
          <li>AI Bayan Chat: 1 –≤–æ–ø—Ä–æ—Å –≤ –¥–µ–Ω—å –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ / –ª–µ–∫—Å–∏–∫–µ.</li>
          <li>–ñ—É—Ä–Ω–∞–ª —É—á–∏—Ç–µ–ª—è: –ø—Ä–æ–≥—Ä–µ—Å—Å, –∑–≤—ë–∑–¥—ã, –≤–æ–ø—Ä–æ—Å—ã –∫ –ò–ò.</li>
        </ul>

        <div style="margin-top:10px;">
          <span class="badge">
            <span class="seed"></span>
            <span class="seed"></span>
            Watermelon style
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- STUDENT SCREEN -->
  <section id="studentScreen" class="screen">
    <div class="top-bar">
      <div class="info">
        –£—á–µ–Ω–∏–∫: <strong id="currentStudentName"></strong>
      </div>
      <div class="stats">
        <div class="pill green">‚≠ê –ó–≤—ë–∑–¥—ã: <span id="studentStars">0</span></div>
        <div class="pill yellow">‚úî –£–ø—Ä. –≤—ã–ø–æ–ª–Ω–µ–Ω–æ: <span id="studentTasksDone">0</span></div>
        <button class="btn btn-ghost" id="logoutFromStudent">–í—ã–π—Ç–∏</button>
      </div>
    </div>

    <div class="layout-main">
      <div>
        <div class="card">
          <h2>–¢–µ–º—ã –≥—Ä–∞–º–º–∞—Ç–∏–∫–∏ 7 –∫–ª–∞—Å—Å–∞</h2>
          <p class="hint">
            –ù–∞–∂–º–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å —Ç–µ–º—É¬ª, –∏–∑—É—á–∏ –ø—Ä–∞–≤–∏–ª–æ, –∑–∞—Ç–µ–º –æ—Ç–º–µ—á–∞–π –≥–∞–ª–æ—á–∫–∞–º–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ Workbook.
          </p>

          <div id="topicsList" class="topics-grid" style="margin-top:10px;"></div>

          <div id="topicDetail" class="topic-detail" style="display:none;">
            <h3>
              <span class="circle" id="topicNumberCircle">1</span>
              <span id="topicDetailTitle">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–µ–º—ã</span>
            </h3>

            <div class="btn-row" style="margin-bottom:4px;">
              <button class="btn btn-ghost" id="printTopicBtn">–ü–µ—á–∞—Ç—å —ç—Ç–æ–π —Ç–µ–º—ã</button>
            </div>

            <div class="theory" id="topicDetailTheory"></div>
            <div class="tasks-list">
              <h4>–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –∏–∑ Workbook:</h4>
              <div id="tasksContainer"></div>
            </div>
          </div>
        </div>
      </div>

      <aside id="aiPanel">
        <div>
          <h3>
            AI Bayan Chat
            <span id="aiLimitInfo"></span>
          </h3>
          <p class="chat-note">
            –ó–∞–¥–∞–π –≤–æ–ø—Ä–æ—Å –ø–æ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ, –ª–µ–∫—Å–∏–∫–µ –∏–ª–∏ –ø–µ—Ä–µ–≤–æ–¥—É. –õ–∏–º–∏—Ç ‚Äî <b>1 –≤–æ–ø—Ä–æ—Å –≤ –¥–µ–Ω—å</b>.
          </p>
        </div>

        <div id="chatBox" class="chat-box"></div>

        <div>
          <div class="field" style="margin-bottom:4px;">
            <label for="aiQuestion">–¢–≤–æ–π –≤–æ–ø—Ä–æ—Å –¥–ª—è AI Bayan</label>
            <textarea id="aiQuestion"
              placeholder="–ù–∞–ø–∏—à–∏ –≤–æ–ø—Ä–æ—Å –ø–æ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º—É –∏ –Ω–∞–∂–º–∏ Enter –∏–ª–∏ –∫–Ω–æ–ø–∫—É ¬´–°–ø—Ä–æ—Å–∏—Ç—å¬ª..."></textarea>
          </div>
          <div class="chat-actions">
            <button class="btn btn-primary" id="askBtn">–°–ø—Ä–æ—Å–∏—Ç—å AI Bayan</button>
          </div>
          <p class="chat-note">
            –í –±—É–¥—É—â–µ–º —É—á–∏—Ç–µ–ª—å —É–≤–∏–¥–∏—Ç —Ç–≤–æ–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã –≤ –∂—É—Ä–Ω–∞–ª–µ.
          </p>
        </div>
      </aside>
    </div>
  </section>

  <!-- TEACHER SCREEN -->
  <section id="teacherScreen" class="screen">
    <div class="card">
      <div class="top-bar">
        <div class="info">
          <strong>Teacher Journal ‚Äì Grammar 7</strong>
        </div>
        <div class="stats">
          <button class="btn btn-ghost" id="backToLoginFromTeacher">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <p class="hint">
        –í–∏–¥–Ω–æ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏—è–º, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–≤—ë–∑–¥, –¥–∞—Ç—É –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –≤—Ö–æ–¥–∞ –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–ø—Ä–æ—Å–æ–≤ –∫ AI Bayan.
      </p>

      <table class="teacher-table">
        <thead>
          <tr>
            <th>–£—á–µ–Ω–∏–∫</th>
            <th>–ó–≤—ë–∑–¥—ã</th>
            <th>–£–ø—Ä.</th>
            <th>–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤—Ö–æ–¥</th>
            <th>–í–æ–ø—Ä–æ—Å–æ–≤ –∫ AI</th>
          </tr>
        </thead>
        <tbody id="teacherTableBody"></tbody>
      </table>
    </div>
  </section>

</main>

<script>
  /* ---------- CONFIG: PINS & STUDENTS ---------- */

  const TEACHER_PIN = "3244";
  const STUDENT_PIN = "2844";

  const studentDisplayNames = [
    "–°—ã—Ä—ã–º7–°",
    "–°–∞–º–∏—Ä7–ë",
    "–û—Ä–¥–∞7–û",
    "–†—É—Å–ª–∞–Ω7–í",
    "–†—É—Å–ª–∞–Ω7–ò",
    "–ú–∞–∫—Å—É—Ç7–°",
    "–ê–¥–µ–ª–∏–Ω–∞7–ú",
    "–≠–ª—å–Ω–æ—Ä–∞7–ê",
    "–õ—É–Ω–∞—Ä–∞7–ê",
    "–ú–∞–∫—Å–∏–º7–ú",
    "–†–∏–Ω–∞—Ç7–¶",
    "–ê—Ä—Ç–µ–º7–ê",
    "–ë7–ê"
  ];

  const studentKeys = studentDisplayNames.map(n => normalizeName(n));

  /* ---------- TOPICS DATA (–ü–†–ò–ú–ï–†–´) ---------- */

  const topics = [
    {
      id: 1,
      title: "Present Simple vs Present Continuous",
      sb: "Student‚Äôs Book: –≥—Ä–∞–º–º–∞—Ç–∏–∫–∞ –ø–æ –Ω–∞—Å—Ç–æ—è—â–µ–º—É –≤—Ä–µ–º–µ–Ω–∏.",
      theoryHtml: `
        <p><b>Present Simple</b> ‚Äì —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è, —Ñ–∞–∫—Ç—ã, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è.</p>
        <ul>
          <li>I <b>play</b> football every Sunday.</li>
          <li>He <b>doesn't like</b> coffee.</li>
        </ul>
        <p><b>Present Continuous</b> ‚Äì –¥–µ–π—Å—Ç–≤–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç <b>—Å–µ–π—á–∞—Å, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç</b>.</p>
        <ul>
          <li>She <b>is doing</b> her homework now.</li>
          <li>We <b>are not watching</b> TV at the moment.</li>
        </ul>
        <p><b>–°–∏–≥–Ω–∞–ª—ã:</b> always, usually, every day (–¥–ª—è Present Simple) –∏ now, at the moment (–¥–ª—è Present Continuous).</p>
      `,
      workbookTasks: [
        "WB p.10 ex.1 ‚Äì –í—ã–±–µ—Ä–∏: Present Simple –∏–ª–∏ Present Continuous.",
        "WB p.10 ex.2 ‚Äì –ü–æ—Å—Ç–∞–≤—å –≥–ª–∞–≥–æ–ª—ã –≤ –Ω—É–∂–Ω—É—é —Ñ–æ—Ä–º—É.",
        "WB p.11 ex.3 ‚Äì –ò—Å–ø—Ä–∞–≤—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –Ω–µ–≤–µ—Ä–Ω–∞—è."
      ]
    },
    {
      id: 2,
      title: "Past Simple (Regular & Irregular Verbs)",
      sb: "Student‚Äôs Book: —Ä–∞—Å—Å–∫–∞–∑ –æ –ø—Ä–æ—à–µ–¥—à–∏—Ö —Å–æ–±—ã—Ç–∏—è—Ö.",
      theoryHtml: `
        <p><b>Past Simple</b> ‚Äì –¥–µ–π—Å—Ç–≤–∏–µ –∑–∞–∫–æ–Ω—á–∏–ª–æ—Å—å –≤ –ø—Ä–æ—à–ª–æ–º, –µ—Å—Ç—å —Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è.</p>
        <ul>
          <li>Yesterday, I <b>watched</b> a film.</li>
          <li>They <b>went</b> to the park last Sunday.</li>
        </ul>
        <p><b>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã</b> ‚Üí <b>-ed</b> (play ‚Üí played), <b>–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ</b> (go ‚Üí went, see ‚Üí saw).</p>
        <p>–û—Ç—Ä–∏—Ü–∞–Ω–∏–µ: did not (didn't) + V1. –í–æ–ø—Ä–æ—Å: Did + –ø–æ–¥–ª–µ–∂–∞—â–µ–µ + V1?</p>
      `,
      workbookTasks: [
        "WB p.18 ex.1 ‚Äì –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–æ–ø—É—Å–∫–∏ –≥–ª–∞–≥–æ–ª–∞–º–∏ –≤ Past Simple.",
        "WB p.18 ex.2 ‚Äì –°–æ—Å—Ç–∞–≤—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ Past Simple.",
        "WB p.19 ex.3 ‚Äì –ü—Ä–µ–æ–±—Ä–∞–∑—É–π —É—Ç–≤–µ—Ä–¥–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –≤ –≤–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç—Ä–∏—Ü–∞–Ω–∏—è."
      ]
    },
    {
      id: 3,
      title: "Future with will / be going to",
      sb: "Student‚Äôs Book: –ø–ª–∞–Ω—ã –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã.",
      theoryHtml: `
        <p><b>Will</b> ‚Äì —Ä–µ—à–µ–Ω–∏—è –≤ –º–æ–º–µ–Ω—Ç —Ä–µ—á–∏, –æ–±–µ—â–∞–Ω–∏—è, –ø—Ä–æ–≥–Ω–æ–∑—ã –±–µ–∑ –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤.</p>
        <ul>
          <li>I'll help you with your homework.</li>
          <li>It will rain tomorrow. (—è —Ç–∞–∫ –¥—É–º–∞—é)</li>
        </ul>
        <p><b>Be going to</b> ‚Äì –ø–ª–∞–Ω—ã (–µ—Å—Ç—å –Ω–∞–º–µ—Ä–µ–Ω–∏–µ) –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã —Å –¥–æ–∫–∞–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞–º–∏.</p>
        <ul>
          <li>I'm going to visit my grandparents this weekend.</li>
          <li>Look at the clouds! It's going to rain.</li>
        </ul>
      `,
      workbookTasks: [
        "WB p.24 ex.1 ‚Äì –í—ã–±–µ—Ä–∏: will –∏–ª–∏ be going to.",
        "WB p.24 ex.2 ‚Äì –ó–∞–ø–æ–ª–Ω–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å–≤–æ–∏–º–∏ –ø–ª–∞–Ω–∞–º–∏.",
        "WB p.25 ex.3 ‚Äì –°–æ–µ–¥–∏–Ω–∏ —á–∞—Å—Ç–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π."
      ]
    }
  ];

  /* ---------- GLOBAL STATE ---------- */

  let currentUser = null; // { role: "student" | "teacher", name?, key? }

  const STORAGE_PROGRESS_PREFIX = "bayan7_progress_";
  const STORAGE_STATS_PREFIX    = "bayan7_stats_";

  /* ---------- HELPERS ---------- */

  function normalizeName(str){
    return (str || "").trim().toLowerCase();
  }

  function showScreen(id){
    document.querySelectorAll(".screen").forEach(s => s.style.display = "none");
    const el = document.getElementById(id);
    if(el) el.style.display = "block";
  }

  function setLoginMessage(text, type="error"){
    const box = document.getElementById("loginMessage");
    if(!text){
      box.style.display = "none";
      box.textContent = "";
      return;
    }
    box.style.display = "block";
    box.textContent = text;
    box.className = type === "success" ? "success" : "error";
  }

  function loadProgress(studentKey){
    const raw = localStorage.getItem(STORAGE_PROGRESS_PREFIX + studentKey);
    if(!raw) return {};
    try{
      return JSON.parse(raw);
    }catch{
      return {};
    }
  }

  function saveProgress(studentKey, data){
    localStorage.setItem(STORAGE_PROGRESS_PREFIX + studentKey, JSON.stringify(data));
  }

  function loadStats(studentKey){
    const raw = localStorage.getItem(STORAGE_STATS_PREFIX + studentKey);
    if(!raw) return { lastLogin:null, aiQuestionCount:0, lastAiQuestionAt:null };
    try{
      const data = JSON.parse(raw);
      if(typeof data.aiQuestionCount === "undefined") data.aiQuestionCount = 0;
      return data;
    }catch{
      return { lastLogin:null, aiQuestionCount:0, lastAiQuestionAt:null };
    }
  }

  function saveStats(studentKey, stats){
    localStorage.setItem(STORAGE_STATS_PREFIX + studentKey, JSON.stringify(stats));
  }

  function countCompleted(progressObj){
    return Object.values(progressObj).filter(Boolean).length;
  }

  function formatDateTime(dateStr){
    if(!dateStr) return "-";
    const d = new Date(dateStr);
    if(isNaN(d.getTime())) return "-";
    const day = String(d.getDate()).padStart(2,"0");
    const month = String(d.getMonth()+1).padStart(2,"0");
    const year = d.getFullYear();
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    return `${day}.${month}.${year} ${hh}:${mm}`;
  }

  /* ---------- LOGIN LOGIC ---------- */

  function handleLogin(){
    const nameInput = document.getElementById("studentName").value;
    const pin       = document.getElementById("pinInput").value.trim();

    setLoginMessage("");

    // Teacher
    if(pin === TEACHER_PIN){
      currentUser = { role:"teacher" };
      document.getElementById("studentName").value = "";
      document.getElementById("pinInput").value = "";
      renderTeacherTable();
      showScreen("teacherScreen");
      return;
    }

    // Student
    if(pin === STUDENT_PIN){
      const normalized = normalizeName(nameInput);
      const idx = studentKeys.indexOf(normalized);
      if(idx === -1){
        setLoginMessage("–≠—Ç–æ –∏–º—è –Ω–µ –≤—Ö–æ–¥–∏—Ç –≤ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö. –û–±—Ä–∞—Ç–∏—Å—å –∫ —É—á–∏—Ç–µ–ª—é.");
        return;
      }

      const displayName = studentDisplayNames[idx];
      const studentKey  = normalized;

      currentUser = { role:"student", name:displayName, key:studentKey };

      // update stats: lastLogin
      const stats = loadStats(studentKey);
      stats.lastLogin = new Date().toISOString();
      saveStats(studentKey, stats);

      document.getElementById("currentStudentName").textContent = displayName;
      document.getElementById("studentName").value = "";
      document.getElementById("pinInput").value = "";

      refreshStudentProgressUI();
      updateAiLimitInfo();

      showScreen("studentScreen");
      return;
    }

    // Invalid PIN
    setLoginMessage("–ù–µ–≤–µ—Ä–Ω—ã–π –ü–ò–ù-–∫–æ–¥. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ —É—á–∏—Ç–µ–ª—é.");
  }

  function handleLogout(){
    currentUser = null;
    document.getElementById("currentStudentName").textContent = "";
    document.getElementById("studentStars").textContent = "0";
    document.getElementById("studentTasksDone").textContent = "0";
    document.getElementById("chatBox").innerHTML = "";
    document.getElementById("aiLimitInfo").textContent = "";
    showScreen("loginScreen");
  }

  /* ---------- TOPICS UI ---------- */

  function buildTopicsList(){
    const container = document.getElementById("topicsList");
    container.innerHTML = "";

    topics.forEach(topic => {
      const card = document.createElement("div");
      card.className = "topic-card";

      const progressBarId = `topicProgress_${topic.id}`;

      card.innerHTML = `
        <div class="topic-tag">Grammar ‚Ä¢ Topic ${topic.id}</div>
        <div class="topic-title">${topic.title}</div>
        <div class="topic-meta">${topic.sb}</div>
        <div class="topic-footer">
          <div class="topic-progress-bar">
            <div id="${progressBarId}" class="topic-progress-fill"></div>
          </div>
          <button class="btn btn-ghost" data-topic-id="${topic.id}">–û—Ç–∫—Ä—ã—Ç—å —Ç–µ–º—É</button>
        </div>
      `;

      container.appendChild(card);
    });

    container.addEventListener("click", e => {
      const btn = e.target.closest("button[data-topic-id]");
      if(!btn) return;
      const topicId = parseInt(btn.getAttribute("data-topic-id"), 10);
      openTopic(topicId);
    });
  }

  function openTopic(topicId){
    const topic = topics.find(t => t.id === topicId);
    if(!topic) return;

    const detail = document.getElementById("topicDetail");
    detail.style.display = "block";

    document.getElementById("topicNumberCircle").textContent = topic.id;
    document.getElementById("topicDetailTitle").textContent  = topic.title;
    document.getElementById("topicDetailTheory").innerHTML   = topic.theoryHtml;

    const tasksContainer = document.getElementById("tasksContainer");
    tasksContainer.innerHTML = "";

    const studentKey = currentUser && currentUser.role === "student" ? currentUser.key : null;
    const progress   = studentKey ? loadProgress(studentKey) : {};

    topic.workbookTasks.forEach((taskText, index) => {
      const key = `${topic.id}_${index}`;
      const checked = !!progress[key];

      const item = document.createElement("div");
      item.className = "task-item";

      const checkboxId = `task_${topic.id}_${index}`;

      item.innerHTML = `
        <input type="checkbox" id="${checkboxId}" data-topic-id="${topic.id}" data-task-index="${index}" ${checked ? "checked" : ""} />
        <label for="${checkboxId}">${taskText}</label>
      `;

      tasksContainer.appendChild(item);
    });

    // add listener for tasks (once)
    tasksContainer.onclick = function(e){
      const cb = e.target.closest('input[type="checkbox"][data-topic-id]');
      if(!cb) return;
      handleTaskToggle(cb);
    };

    refreshStudentProgressUI();
  }

  function handleTaskToggle(checkbox){
    if(!currentUser || currentUser.role !== "student") return;
    const studentKey = currentUser.key;

    const topicId    = parseInt(checkbox.getAttribute("data-topic-id"), 10);
    const taskIndex  = parseInt(checkbox.getAttribute("data-task-index"), 10);
    const progress   = loadProgress(studentKey);

    const key = `${topicId}_${taskIndex}`;
    progress[key] = checkbox.checked;

    saveProgress(studentKey, progress);
    refreshStudentProgressUI();
  }

  function refreshStudentProgressUI(){
    if(!currentUser || currentUser.role !== "student") return;

    const studentKey = currentUser.key;
    const progress   = loadProgress(studentKey);
    const completed  = countCompleted(progress);

    // 1 –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ = 1 –∑–≤–µ–∑–¥–∞
    const stars = completed;

    document.getElementById("studentTasksDone").textContent = String(completed);
    document.getElementById("studentStars").textContent     = String(stars);

    topics.forEach(topic => {
      const totalTasks = topic.workbookTasks.length;
      let doneForTopic = 0;
      for(let i=0;i<totalTasks;i++){
        const key = `${topic.id}_${i}`;
        if(progress[key]) doneForTopic++;
      }

      const fillEl = document.getElementById(`topicProgress_${topic.id}`);
      if(fillEl){
        const percent = totalTasks > 0 ? Math.round(doneForTopic / totalTasks * 100) : 0;
        fillEl.style.width = percent + "%";
      }
    });
  }

  /* ---------- AI BAYAN CHAT ---------- */

  function updateAiLimitInfo(){
    const el = document.getElementById("aiLimitInfo");
    if(!currentUser || currentUser.role !== "student"){
      el.textContent = "";
      return;
    }

    const studentKey = currentUser.key;
    const stats      = loadStats(studentKey);

    if(!stats.lastAiQuestionAt){
      el.textContent = "–î–æ—Å—Ç—É–ø–Ω–æ: 1 –≤–æ–ø—Ä–æ—Å —Å–µ–≥–æ–¥–Ω—è";
      return;
    }

    const now   = Date.now();
    const last  = new Date(stats.lastAiQuestionAt).getTime();
    const diffH = (now - last) / 36e5;

    if(diffH >= 24){
      el.textContent = "–î–æ—Å—Ç—É–ø–Ω–æ: 1 –≤–æ–ø—Ä–æ—Å —Å–µ–≥–æ–¥–Ω—è";
    }else{
      el.textContent = "–°–µ–≥–æ–¥–Ω—è –ª–∏–º–∏—Ç —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω";
    }
  }

  function appendChatMessage(role, text){
    const box = document.getElementById("chatBox");
    const div = document.createElement("div");
    div.className = "chat-message " + (role === "me" ? "me" : "ai");
    const who = role === "me" ? "–¢—ã" : "AI Bayan";
    div.innerHTML = `
      <span class="bubble"><b>${who}:</b> ${text}</span>
    `;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
  }

  function sendToAiBayan(){
    if(!currentUser || currentUser.role !== "student"){
      alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏ –∫–∞–∫ —É—á–µ–Ω–∏–∫.");
      return;
    }

    const studentKey = currentUser.key;
    const stats      = loadStats(studentKey);

    const now   = Date.now();
    if(stats.lastAiQuestionAt){
      const last  = new Date(stats.lastAiQuestionAt).getTime();
      const diffH = (now - last) / 36e5;
      if(diffH < 24){
        appendChatMessage("ai","–°–µ–≥–æ–¥–Ω—è —Ç—ã —É–∂–µ –∑–∞–¥–∞–ª(–∞) –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å. –ü–æ–ø—Ä–æ–±—É–π –∑–∞–≤—Ç—Ä–∞ üòä");
        updateAiLimitInfo();
        return;
      }
    }

    const textarea = document.getElementById("aiQuestion");
    const question = (textarea.value || "").trim();
    if(!question){
      return;
    }

    appendChatMessage("me", question);
    textarea.value = "";

    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–∏–º–∏—Ç (—Å—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤–æ–ø—Ä–æ—Å —É—à—ë–ª)
    stats.lastAiQuestionAt = new Date().toISOString();
    stats.aiQuestionCount  = (stats.aiQuestionCount || 0) + 1;
    saveStats(studentKey, stats);
    updateAiLimitInfo();

    // –ü—Å–µ–≤–¥–æ-–æ—Ç–≤–µ—Ç
    setTimeout(() => {
      appendChatMessage(
        "ai",
        "–ó–¥–µ—Å—å –±—É–¥–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç–≤–µ—Ç AI Bayan. " +
        "–°–µ–π—á–∞—Å –æ—Ñ–ª–∞–π–Ω-–≤–µ—Ä—Å–∏—è: —Å—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π –ø—Ä–∞–≤–∏–ª–æ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–æ–º, –ø—Ä–∏–≤–µ–¥–∏ —Å–≤–æ–∏ –ø—Ä–∏–º–µ—Ä—ã, " +
        "–∞ –∑–∞—Ç–µ–º –æ–±—Å—É–¥–∏ –∏—Ö —Å —É—á–∏—Ç–µ–ª–µ–º."
      );
    }, 600);
  }

  /* ---------- TEACHER JOURNAL ---------- */

  function renderTeacherTable(){
    const tbody = document.getElementById("teacherTableBody");
    tbody.innerHTML = "";

    studentDisplayNames.forEach((displayName, idx) => {
      const key   = studentKeys[idx];
      const prog  = loadProgress(key);
      const stats = loadStats(key);

      const completed = countCompleted(prog);
      const stars     = completed; // 1 —É–ø—Ä. = 1 –∑–≤–µ–∑–¥–∞

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="name-col">${displayName}</td>
        <td>${stars}</td>
        <td>${completed}</td>
        <td>${formatDateTime(stats.lastLogin)}</td>
        <td>${stats.aiQuestionCount || 0}</td>
      `;

      tbody.appendChild(tr);
    });
  }

  /* ---------- INIT ---------- */

  document.addEventListener("DOMContentLoaded", () => {
    showScreen("loginScreen");
    buildTopicsList();

    document.getElementById("loginBtn").addEventListener("click", handleLogin);
    document.getElementById("printAllBtn").addEventListener("click", () => window.print());

    document.getElementById("pinInput").addEventListener("keydown", e => {
      if(e.key === "Enter"){
        e.preventDefault();
        handleLogin();
      }
    });

    document.getElementById("studentName").addEventListener("keydown", e => {
      if(e.key === "Enter"){
        e.preventDefault();
        document.getElementById("pinInput").focus();
      }
    });

    document.getElementById("logoutFromStudent").addEventListener("click", handleLogout);
    document.getElementById("backToLoginFromTeacher").addEventListener("click", handleLogout);

    document.getElementById("askBtn").addEventListener("click", sendToAiBayan);
    document.getElementById("aiQuestion").addEventListener("keydown", e => {
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendToAiBayan();
      }
    });

    document.getElementById("printTopicBtn").addEventListener("click", () => {
      // –ü–µ—á–∞—Ç–∞–µ–º —Ç–æ–ª—å–∫–æ –æ—Ç–∫—Ä—ã—Ç—É—é —Ç–µ–º—É + –ø–∞–Ω–µ–ª—å —É—á–µ–Ω–∏–∫–∞
      window.print();
    });
  });
</script>

</body>
</html>
