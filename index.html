<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì Beginner SPEAKING</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --blue-main:#008b8b;   /* –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –±–∏—Ä—é–∑–æ–≤—ã–π */
      --blue-soft:#00b8b8;
      --gold:#ffd54f;
      --bg:#f1fbfd;
      --danger:#c62828;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      background:var(--bg);
      color:#033244;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    /* ====== SIMPLE REUSABLE ====== */
    button{
      border:none;
      border-radius:999px;
      padding:7px 15px;
      font-size:.85rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.15s;
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .btn-primary{
      background:var(--blue-main);
      color:#fff;
    }
    .btn-primary:hover:not(:disabled){
      background:#006d6d;
    }
    .btn-ghost{
      background:#ffffff;
      border:1px solid rgba(0,0,0,.1);
    }
    .btn-ghost:hover:not(:disabled){
      background:#f1f5f9;
    }

    /* ====== LOGIN SCREEN ====== */
    #loginScreen{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 12px;
    }

    .login-card{
      background:#fff;
      border-radius:18px;
      box-shadow:0 3px 10px rgba(0,0,0,.15);
      max-width:420px;
      width:100%;
      padding:18px 18px 20px;
    }

    .login-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }

    .logo-circle{
      width:54px;
      height:54px;
      border-radius:50%;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex-shrink:0;
      box-shadow:0 0 0 3px rgba(0,139,139,.25);
    }
    .logo-circle img{
      width:100%;
      height:100%;
      object-fit:cover;
    }

    .login-title-main{
      font-size:1rem;
      font-weight:700;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#005b5b;
    }
    .login-title-sub{
      font-size:.85rem;
      color:#007070;
    }

    .login-body{
      margin-top:10px;
      font-size:.88rem;
    }

    .login-body label{
      display:block;
      margin-bottom:6px;
      color:#004545;
      font-weight:600;
    }

    .login-body input{
      width:100%;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.2);
      font-size:.9rem;
      margin-bottom:8px;
      outline:none;
    }
    .login-body input:focus{
      border-color:var(--blue-main);
      box-shadow:0 0 0 2px rgba(0,139,139,.18);
    }

    .login-footer{
      margin-top:8px;
      font-size:.78rem;
      color:#607d8b;
      line-height:1.4;
    }

    .login-error{
      margin-top:6px;
      font-size:.8rem;
      color:#b71c1c;
    }

    .login-class-info{
      margin-top:4px;
      font-size:.8rem;
      color:#00695c;
    }

    /* ====== APP HEADER ====== */
    header{
      display:none; /* —Å–∫—Ä—ã—Ç, –ø–æ–∫–∞ –Ω–µ –∑–∞–ª–æ–≥–∏–Ω—è—Ç—Å—è */
      background:linear-gradient(90deg,#008b8b,#00b8b8);
      color:#fff;
      padding:10px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
      gap:12px;
    }

    .header-left{
      display:flex;
      align-items:center;
      gap:10px;
    }

    .header-text-main{
      font-weight:700;
      font-size:.98rem;
      letter-spacing:.12em;
      text-transform:uppercase;
    }

    .header-text-sub{
      font-size:.8rem;
      opacity:.95;
    }

    .header-badge{
      background:rgba(255,255,255,.15);
      color:#e0ffff;
      padding:6px 10px;
      border-radius:999px;
      font-size:.78rem;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }

    .header-badge span.icon{
      font-size:1rem;
    }

    .user-chip{
      margin-top:2px;
      font-size:.76rem;
      background:rgba(0,0,0,.15);
      padding:3px 9px;
      border-radius:999px;
      display:inline-block;
    }

    /* ====== MAIN LAYOUT ====== */
    #appScreen{
      display:none;
      flex:1;
      padding:0;
      flex-direction:column;
    }

    main{
      flex:1;
      max-width:1180px;
      width:100%;
      margin:0 auto;
      padding:14px 12px 26px;
      display:grid;
      gap:14px;
    }

    @media(min-width:900px){
      main{
        grid-template-columns:1.8fr 1.2fr;
        align-items:flex-start;
      }
    }

    .panel{
      background:#fff;
      border-radius:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.06);
      padding:14px 16px 18px;
    }

    .panel h2{
      font-size:1.02rem;
      margin-bottom:8px;
      color:#004545;
      display:flex;
      align-items:center;
      gap:8px;
    }

    .panel h2 span.icon{
      width:22px;
      height:22px;
      border-radius:999px;
      background:var(--blue-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:.9rem;
    }

    .small-label{
      font-size:.8rem;
      color:#607d8b;
      margin-top:4px;
      margin-bottom:4px;
    }

    /* TOPIC CHIPS */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:6px;
      max-height:160px;
      overflow:auto;
      padding-right:2px;
    }

    .chip{
      border-radius:999px;
      padding:6px 11px;
      border:1px solid rgba(0,0,0,.08);
      font-size:.78rem;
      background:#f7ffff;
      cursor:pointer;
      transition:.15s;
      white-space:nowrap;
    }

    .chip:hover{
      background:#e0fbff;
    }

    .chip.active{
      background:var(--blue-main);
      color:#fff;
      border-color:var(--blue-main);
    }

    /* TIMER */
    .timer-row{
      margin-top:4px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:.82rem;
    }

    select{
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.18);
      font-size:.8rem;
      background:#fff;
    }

    #timerDisplay{
      font-weight:700;
      padding:4px 10px;
      border-radius:999px;
      background:#e0f2f1;
      color:#004d40;
      min-width:60px;
      text-align:center;
      font-size:.8rem;
    }

    /* PROMPT CARD */
    .prompt-card{
      margin-top:8px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.05);
      padding:14px 14px 16px;
      background:linear-gradient(135deg,#ffffff,#e1f8ff);
      position:relative;
      overflow:hidden;
    }

    .prompt-topic{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:#006064;
      margin-bottom:4px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
    }

    .badge-level{
      padding:2px 9px;
      border-radius:999px;
      font-size:.7rem;
      background:#fff7e0;
      color:#8d5b00;
    }

    .prompt-index{
      font-size:.82rem;
      margin-bottom:2px;
      color:#607d8b;
    }

    .prompt-type{
      font-size:.78rem;
      color:#00796b;
      margin-bottom:6px;
    }

    .prompt-text{
      font-size:.98rem;
      line-height:1.5;
      margin-bottom:6px;
    }

    .prompt-hint{
      font-size:.8rem;
      color:#78909c;
      margin-bottom:4px;
    }

    .prompt-actions{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:6px;
    }

    .progress-info{
      margin-top:6px;
      font-size:.78rem;
      color:#455a64;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .progress-bar{
      flex:1;
      height:6px;
      border-radius:999px;
      background:#e0f2f1;
      overflow:hidden;
      min-width:80px;
    }

    .progress-bar-inner{
      height:100%;
      width:0%;
      background:var(--blue-main);
      transition:width .2s;
    }

    .done-badge{
      font-size:.75rem;
      padding:3px 9px;
      border-radius:999px;
      background:#e8f5e9;
      color:#1b5e20;
    }

    .done-badge.off{
      background:#ffebee;
      color:#b71c1c;
    }

    /* ====== RIGHT PANEL: AI + JOURNAL ====== */
    .chat-note{
      font-size:.78rem;
      color:#607d8b;
      margin-bottom:6px;
    }

    .chat-note b{
      color:#004d40;
    }

    #aiLimit{
      font-weight:600;
      color:#004d40;
    }

    .chat-box{
      border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      padding:8px 10px;
      background:#f8feff;
      max-height:210px;
      overflow:auto;
      font-size:.8rem;
      margin-bottom:8px;
    }

    .chat-msg{
      margin-bottom:6px;
      padding:6px 8px;
      border-radius:10px;
    }

    .chat-msg.user{
      background:#e0f7fa;
      align-self:flex-end;
    }

    .chat-msg.ai{
      background:#e8f5e9;
    }

    .chat-msg small{
      display:block;
      font-size:.7rem;
      color:#546e7a;
      margin-bottom:2px;
    }

    #aiQuestion{
      width:100%;
      min-height:60px;
      max-height:100px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.18);
      resize:vertical;
      font-size:.84rem;
      outline:none;
    }
    #aiQuestion:focus{
      border-color:var(--blue-main);
      box-shadow:0 0 0 2px rgba(0,139,139,.14);
    }

    .chat-actions{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      font-size:.78rem;
      color:#607d8b;
    }

    .danger-text{
      color:var(--danger);
      font-size:.78rem;
      margin-top:4px;
    }

    /* JOURNAL */
    .journal-header{
      margin-top:10px;
      font-size:.84rem;
      font-weight:600;
      color:#004545;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }

    .journal-box{
      margin-top:6px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.08);
      padding:6px 8px;
      max-height:160px;
      overflow:auto;
      font-size:.78rem;
      background:#fafafa;
    }

    .journal-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:3px 0;
      border-bottom:1px dashed rgba(0,0,0,.07);
    }

    .journal-row:last-child{
      border-bottom:none;
    }

    .journal-row span.pin{
      font-weight:600;
      color:#004d40;
    }

    .journal-row span.info{
      color:#455a64;
    }

    @media(max-width:700px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      .header-badge{
        align-self:flex-start;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN SCREEN -->
  <div id="loginScreen">
    <div class="login-card">
      <div class="login-header">
        <div class="logo-circle">
          <img src="logo.png" alt="AI Bayan logo" onerror="this.style.display='none';">
        </div>
        <div>
          <div class="login-title-main">ENGLISH WITH AI BAYAN</div>
          <div class="login-title-sub">BEGINNER ‚Äì SPEAKING with AI Bayan</div>
        </div>
      </div>

      <div class="login-body">
        <label for="pinInput">Enter your PIN code</label>
        <input id="pinInput" type="number" placeholder="For example: 301" />
        <button id="loginBtn" class="btn-primary">Login</button>
        <div id="loginError" class="login-error"></div>
        <div id="loginClassInfo" class="login-class-info"></div>
      </div>

      <div class="login-footer">
        PIN ranges (like Beginner app):<br>
        3E: 101‚Äì115, 4G: 201‚Äì215, 5G: 301‚Äì315, 5Zh: 401‚Äì415,<br>
        6G: 501‚Äì515, 7B: 601‚Äì615, 7V: 701‚Äì715, 8E: 801‚Äì815, 9Zh: 901‚Äì915.
      </div>
    </div>
  </div>

  <!-- APP SCREEN -->
  <div id="appScreen">
    <header>
      <div class="header-left">
        <div class="logo-circle">
          <img src="logo.png" alt="AI Bayan logo" onerror="this.style.display='none';">
        </div>
        <div>
          <div class="header-text-main">ENGLISH WITH AI BAYAN</div>
          <div class="header-text-sub">
            Beginner ‚Äì SPEAKING ‚Ä¢ AI Bayan help (1 question per day)
          </div>
          <div id="userChip" class="user-chip"></div>
        </div>
      </div>
      <div class="header-badge">
        <span class="icon">üé§</span>
        <span>Talk 30‚Äì60 sec for each question</span>
      </div>
    </header>

    <main>
      <!-- LEFT: SPEAKING CARD -->
      <section class="panel">
        <h2><span class="icon">üí¨</span> Speaking practice ‚Äì Beginner</h2>

        <p class="small-label">Choose a topic:</p>
        <div id="topicChips" class="chips"></div>

        <div class="timer-row">
          <span>Timer:</span>
          <select id="timerSelect">
            <option value="0">No timer</option>
            <option value="30">30 sec</option>
            <option value="60">1 min</option>
            <option value="90">1.5 min</option>
          </select>
          <button id="startTimerBtn" class="btn-ghost">Start ‚è±</button>
          <span id="timerDisplay">‚Äì</span>
        </div>

        <div id="promptCard" class="prompt-card">
          <div class="prompt-topic">
            <span id="topicName">Choose a topic above</span>
            <span id="topicLevel" class="badge-level"></span>
          </div>
          <div id="promptIndex" class="prompt-index"></div>
          <div id="promptType" class="prompt-type"></div>
          <div id="promptText" class="prompt-text">
            Click on a topic and start speaking.
          </div>
          <div id="promptHint" class="prompt-hint"></div>

          <div class="prompt-actions">
            <button id="prevBtn" class="btn-ghost">‚Üê Previous</button>
            <button id="nextBtn" class="btn-primary">Next ‚Üí</button>
            <button id="randomBtn" class="btn-ghost">üé≤ Random</button>
            <button id="printBtn" class="btn-ghost">üñ® Print worksheet</button>
            <button id="toggleDoneBtn" class="btn-ghost">‚úî Mark as done</button>
          </div>

          <div class="progress-info">
            <div id="doneStatus" class="done-badge off">Not done</div>
            <div class="progress-bar">
              <div id="progressInner" class="progress-bar-inner"></div>
            </div>
            <div id="progressText">0 / 0 done</div>
          </div>
        </div>

        <p class="small-label">
          Teacher idea: Student A answers 1,3,5; Student B answers 2,4,6 ‚Äì then swap.
        </p>
      </section>

      <!-- RIGHT: AI BAYAN + TEACHER JOURNAL -->
      <aside class="panel">
        <h2><span class="icon">ü§ñ</span> AI Bayan ‚Äì help for speaking</h2>
        <p class="chat-note">
          Ask AI Bayan about <b>grammar, words or translation</b> for your speaking topic.<br>
          Limit: <b>1 question per day</b> for each PIN.<br>
          <span id="aiLimit"></span>
        </p>

        <div id="chatBox" class="chat-box"></div>

        <textarea id="aiQuestion"
          placeholder="Write your question for AI Bayan (English or Russian)..."></textarea>

        <div class="chat-actions">
          <button id="askBtn" class="btn-primary">Ask AI Bayan</button>
          <span>AI answers will be saved only on this device.</span>
        </div>
        <div id="aiError" class="danger-text"></div>

        <div class="journal-header">
          <span>Teacher journal (this device)</span>
          <button id="refreshJournalBtn" class="btn-ghost">Refresh</button>
        </div>
        <div id="journalBox" class="journal-box">
          <div style="font-size:.78rem;color:#78909c;">
            Journal shows how many questions are marked ‚Äúdone‚Äù for each PIN on this device.
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    /* ---------- CLASS RANGES (same as Beginner) ---------- */
    const classRanges = [
      { cls: "3E",  from: 101, to: 115 },
      { cls: "4G",  from: 201, to: 215 },
      { cls: "5G",  from: 301, to: 315 },
      { cls: "5Zh", from: 401, to: 415 },
      { cls: "6G",  from: 501, to: 515 },
      { cls: "7B",  from: 601, to: 615 },
      { cls: "7V", from: 701, to: 715 },
      { cls: "8E",  from: 801, to: 815 },
      { cls: "9Zh", from: 901, to: 915 }
    ];

    function getClassByPin(pin){
      for(const r of classRanges){
        if(pin >= r.from && pin <= r.to) return r.cls;
      }
      return null;
    }

    /* ---------- SPEAKING TOPICS DATA (20 √ó 6) ---------- */
    const topics = [
      {
        id: 1,
        name: "My Family",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Talk about your family. How many people are there?", taskType: "Solo talk", hint: "Say who they are and how old they are." },
          { text: "Describe one family member. What is he or she like?", taskType: "Solo talk", hint: "Describe appearance and character." },
          { text: "Student A: Ask 3 questions about Student B‚Äôs family. Student B: Answer.", taskType: "Pair role-play A/B", hint: "Use: How many‚Ä¶? What does‚Ä¶ do? How old is‚Ä¶?" },
          { text: "Tell about a family tradition you have.", taskType: "Solo talk", hint: "For example: New Year, Nauryz, birthdays." },
          { text: "Who do you spend the most time with in your family? Why?", taskType: "Solo talk", hint: "Explain what you do together." },
          { text: "Describe a perfect family day for you.", taskType: "Solo talk", hint: "Morning, afternoon, evening ‚Äì step by step." }
        ]
      },
      {
        id: 2,
        name: "My Home",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe your home. How many rooms are there?", taskType: "Solo talk", hint: "Living room, kitchen, bedroom, bathroom‚Ä¶" },
          { text: "Talk about your favourite room at home.", taskType: "Solo talk", hint: "Say what is in the room and what you do there." },
          { text: "Student A: Ask about Student B‚Äôs home. Student B: Answer.", taskType: "Pair Q&A", hint: "Ask: Where do you live? Is it a flat or a house?" },
          { text: "What do you usually do at home in the evening?", taskType: "Solo talk", hint: "Use present simple: I watch‚Ä¶, I do‚Ä¶, I play‚Ä¶" },
          { text: "Describe your dream room.", taskType: "Solo talk", hint: "Talk about colours, furniture, and things." },
          { text: "Tell 3 rules in your home.", taskType: "Solo talk", hint: "Use must / mustn‚Äôt if possible." }
        ]
      },
      {
        id: 3,
        name: "Daily Routine",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe your morning routine.", taskType: "Solo talk", hint: "Wake up, wash, have breakfast, go to school‚Ä¶" },
          { text: "Talk about your school day.", taskType: "Solo talk", hint: "What time do you start? What do you do after school?" },
          { text: "Student A: Ask 5 questions about Student B‚Äôs daily routine.", taskType: "Pair Q&A", hint: "Use: What time do you‚Ä¶? How often do you‚Ä¶?" },
          { text: "Compare your weekend routine and your school-day routine.", taskType: "Solo talk", hint: "Use: On weekdays‚Ä¶, At the weekend‚Ä¶" },
          { text: "What is the most difficult part of your day? Why?", taskType: "Solo talk", hint: "Talk about homework, getting up, tests, etc." },
          { text: "Describe your ideal day with no school.", taskType: "Solo talk", hint: "From morning to night." }
        ]
      },
      {
        id: 4,
        name: "School Life",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe your school.", taskType: "Solo talk", hint: "Talk about the building, students, teachers." },
          { text: "Talk about your favourite subject at school.", taskType: "Solo talk", hint: "Explain why you like it." },
          { text: "Student A: You are the teacher. Student B: You are the student. Make a short dialogue in class.", taskType: "Pair role-play A/B", hint: "Use: Stand up, open your books, please." },
          { text: "Talk about one school rule. Do you like it or not?", taskType: "Solo talk", hint: "Use: We must / We mustn‚Äôt‚Ä¶" },
          { text: "Describe your classroom.", taskType: "Solo talk", hint: "What can you see? Where do you sit?" },
          { text: "Tell about your best school day.", taskType: "Solo talk", hint: "What happened? Why was it special?" }
        ]
      },
      {
        id: 5,
        name: "Free Time",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe your hobbies.", taskType: "Solo talk", hint: "Use: I like / I love / I enjoy + V-ing." },
          { text: "What do you usually do after school?", taskType: "Solo talk", hint: "Talk about 2‚Äì3 activities." },
          { text: "Student A: Ask about Student B‚Äôs free time. Student B: Answer.", taskType: "Pair Q&A", hint: "Ask: What do you do in the evening? At the weekend?" },
          { text: "Describe a hobby you want to try in the future.", taskType: "Solo talk", hint: "Explain why you want this hobby." },
          { text: "Talk about weekend fun in your city or village.", taskType: "Solo talk", hint: "Where do children go? What do they do?" },
          { text: "Tell about one hobby you had when you were younger.", taskType: "Solo talk", hint: "Use: When I was younger, I‚Ä¶" }
        ]
      },
      {
        id: 6,
        name: "Food & Drinks",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Talk about your favourite food.", taskType: "Solo talk", hint: "Describe the taste and when you eat it." },
          { text: "Describe what you ate yesterday for breakfast, lunch and dinner.", taskType: "Solo talk", hint: "Use past simple: I ate‚Ä¶, I drank‚Ä¶" },
          { text: "Student A: You are in a caf√©. Student B: You are the waiter. Order food and drinks.", taskType: "Pair role-play A/B", hint: "Use: Could I have‚Ä¶? Here you are." },
          { text: "Compare healthy and unhealthy food.", taskType: "Solo talk", hint: "Give examples of each group." },
          { text: "Describe your fridge today. What food is inside?", taskType: "Solo talk", hint: "Name different products." },
          { text: "Tell 3 things you can cook.", taskType: "Solo talk", hint: "Even simple things like eggs, tea, sandwiches." }
        ]
      },
      {
        id: 7,
        name: "Clothes & Style",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe what you are wearing today.", taskType: "Solo talk", hint: "Name colours and types of clothes." },
          { text: "Talk about your favourite clothes.", taskType: "Solo talk", hint: "When do you wear them?" },
          { text: "Student A: You are in a clothes shop. Student B: You are the shop assistant.", taskType: "Pair role-play A/B", hint: "Ask for size, colour, price." },
          { text: "Describe your school uniform (or what students wear at school).", taskType: "Solo talk", hint: "Say if you like it or not." },
          { text: "What clothes do you wear in winter and in summer?", taskType: "Solo talk", hint: "Compare seasons." },
          { text: "Tell a funny or strange story about clothes.", taskType: "Solo talk", hint: "Maybe something that happened to you or your friend." }
        ]
      },
      {
        id: 8,
        name: "Weather & Seasons",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe the weather today.", taskType: "Solo talk", hint: "Is it hot, cold, windy, cloudy‚Ä¶?" },
          { text: "Talk about your favourite season and why you like it.", taskType: "Solo talk", hint: "Mention activities and clothes." },
          { text: "Student A: You are a TV weather presenter. Student B: Ask questions about the weather.", taskType: "Pair role-play A/B", hint: "Use: Today it will be‚Ä¶, The temperature will be‚Ä¶" },
          { text: "What do people do in winter and in summer?", taskType: "Solo talk", hint: "Name different activities for each season." },
          { text: "Describe the weather in your city or region.", taskType: "Solo talk", hint: "Talk about temperature and seasons." },
          { text: "What is the best weather for you? Why?", taskType: "Solo talk", hint: "Explain what you can do in this weather." }
        ]
      },
      {
        id: 9,
        name: "Animals & Pets",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe your favourite animal.", taskType: "Solo talk", hint: "Say what it looks like and what it eats." },
          { text: "Talk about animals that live in Kazakhstan.", taskType: "Solo talk", hint: "Name wild animals and farm animals." },
          { text: "Student A: Ask about Student B‚Äôs pet. Student B: Answer.", taskType: "Pair Q&A", hint: "Ask: Have you got a pet? What is its name?" },
          { text: "Describe an animal‚Äôs daily routine.", taskType: "Solo talk", hint: "For example: a dog, a cat, a horse‚Ä¶" },
          { text: "Compare zoo animals and wild animals.", taskType: "Solo talk", hint: "Where do they live? How do they live?" },
          { text: "Tell about a funny animal moment.", taskType: "Solo talk", hint: "Something you saw or watched in a video." }
        ]
      },
      {
        id: 10,
        name: "My City / Town",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe your city or town.", taskType: "Solo talk", hint: "Is it big or small? What places are there?" },
          { text: "Talk about your neighbourhood.", taskType: "Solo talk", hint: "What can you see near your home?" },
          { text: "Student A: You are a tourist. Student B: Give directions to a place.", taskType: "Pair role-play A/B", hint: "Use: Go straight, turn left, next to‚Ä¶" },
          { text: "Describe a place you like in your city.", taskType: "Solo talk", hint: "Park, square, beach, shopping centre‚Ä¶" },
          { text: "What problems does your city or town have?", taskType: "Solo talk", hint: "Traffic, rubbish, noise, etc." },
          { text: "Describe your dream city.", taskType: "Solo talk", hint: "What would it have? What would it look like?" }
        ]
      },
      {
        id: 11,
        name: "Sport",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Talk about your favourite sport.", taskType: "Solo talk", hint: "How often do you play it or watch it?" },
          { text: "Describe a sportsman or sportswoman you like.", taskType: "Solo talk", hint: "What sport? Why do you like them?" },
          { text: "Student A: You want to join a sports club. Student B: Give information.", taskType: "Pair role-play A/B", hint: "Talk about days, time, price." },
          { text: "What sport would you like to try? Why?", taskType: "Solo talk", hint: "Explain your choice." },
          { text: "Compare indoor and outdoor sports.", taskType: "Solo talk", hint: "Give advantages of each." },
          { text: "Describe a sports event you watched.", taskType: "Solo talk", hint: "On TV or in real life." }
        ]
      },
      {
        id: 12,
        name: "Holidays & Festivals",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe your favourite holiday.", taskType: "Solo talk", hint: "What do you do? What do you eat?" },
          { text: "Talk about how your family celebrates this holiday.", taskType: "Solo talk", hint: "Mention traditions and activities." },
          { text: "Student A & B: Make a plan for a holiday party.", taskType: "Pair discussion", hint: "Talk about food, music, guests, games." },
          { text: "Describe a traditional Kazakh celebration.", taskType: "Solo talk", hint: "For example: Nauryz." },
          { text: "What gift did you last receive? Who gave it to you?", taskType: "Solo talk", hint: "Say when and why." },
          { text: "Describe the best holiday memory in your life.", taskType: "Solo talk", hint: "Explain why it was so special." }
        ]
      },
      {
        id: 13,
        name: "Health & Body",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Name 5 parts of the body and describe one part.", taskType: "Solo talk", hint: "Head, arm, leg, etc." },
          { text: "Talk about healthy habits.", taskType: "Solo talk", hint: "Sleep, food, sport, water‚Ä¶" },
          { text: "Student A: You are a doctor. Student B: You are a patient. Make a short dialogue.", taskType: "Pair role-play A/B", hint: "Use: What‚Äôs the matter? You should‚Ä¶" },
          { text: "Describe your morning health routine.", taskType: "Solo talk", hint: "Teeth, face, exercises, breakfast." },
          { text: "What food is healthy for children?", taskType: "Solo talk", hint: "Give examples of good food." },
          { text: "Tell about a time you were sick.", taskType: "Solo talk", hint: "What did you have? What did you do?" }
        ]
      },
      {
        id: 14,
        name: "Shopping",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Talk about your favourite shop.", taskType: "Solo talk", hint: "What do you buy there?" },
          { text: "Describe what people buy every day.", taskType: "Solo talk", hint: "Food, drinks, basic things." },
          { text: "Student A: You are buying items. Student B: You are the shop assistant.", taskType: "Pair role-play A/B", hint: "Use: How much is it? I‚Äôd like‚Ä¶" },
          { text: "Cash vs card ‚Äì what do people use more in your family?", taskType: "Solo talk", hint: "Explain why." },
          { text: "What do you want to buy for yourself now?", taskType: "Solo talk", hint: "Describe your wish." },
          { text: "Describe your last purchase.", taskType: "Solo talk", hint: "Where? When? What? How much?" }
        ]
      },
      {
        id: 15,
        name: "Traveling",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Talk about a place you visited.", taskType: "Solo talk", hint: "When did you go? With whom?" },
          { text: "Describe how you travelled there.", taskType: "Solo talk", hint: "By car, bus, train, plane‚Ä¶" },
          { text: "Student A: Ask for travel advice. Student B: Answer.", taskType: "Pair Q&A", hint: "Use: Where should I go? What can I see there?" },
          { text: "Describe your dream trip.", taskType: "Solo talk", hint: "Country, city, activities." },
          { text: "Beach vs mountains ‚Äì which do you prefer?", taskType: "Solo talk", hint: "Explain reasons." },
          { text: "Tell about a travel problem you had or imagine one.", taskType: "Solo talk", hint: "For example: lost ticket, late bus‚Ä¶" }
        ]
      },
      {
        id: 16,
        name: "Nature",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe a place in nature you like.", taskType: "Solo talk", hint: "Lake, forest, steppe, sea, etc." },
          { text: "Talk about trees, plants and flowers in your area.", taskType: "Solo talk", hint: "Name 2‚Äì3 examples." },
          { text: "Student A: Your friend wants to plant a tree. Give advice.", taskType: "Pair role-play A/B", hint: "Talk about when, where and how." },
          { text: "Why is nature important for people?", taskType: "Solo talk", hint: "Give at least 3 reasons." },
          { text: "Describe the most beautiful natural place you have seen.", taskType: "Solo talk", hint: "Say what you could see, hear and feel." },
          { text: "Tell 3 things people should do to protect nature.", taskType: "Solo talk", hint: "Use: should / shouldn‚Äôt." }
        ]
      },
      {
        id: 17,
        name: "Technology",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Talk about your phone or tablet.", taskType: "Solo talk", hint: "How often do you use it? What for?" },
          { text: "Describe one app you use very often.", taskType: "Solo talk", hint: "What can you do with it?" },
          { text: "Student A: Ask about Student B‚Äôs screen time. Student B: Answer.", taskType: "Pair Q&A", hint: "How many hours per day? Is it good or bad?" },
          { text: "Describe a day without technology.", taskType: "Solo talk", hint: "What would you do? Would it be easy or difficult?" },
          { text: "Talk about good and bad sides of phones.", taskType: "Solo talk", hint: "Give 2 good and 2 bad sides." },
          { text: "What gadget do you want in the future?", taskType: "Solo talk", hint: "Describe your dream gadget." }
        ]
      },
      {
        id: 18,
        name: "Transportation",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Talk about how you go to school.", taskType: "Solo talk", hint: "On foot, by bus, by car, etc." },
          { text: "Describe your favourite type of transport.", taskType: "Solo talk", hint: "Why do you like it?" },
          { text: "Student A: Ask for directions. Student B: Give directions.", taskType: "Pair role-play A/B", hint: "To the school, shop, bus stop, etc." },
          { text: "Compare car and bus.", taskType: "Solo talk", hint: "Talk about speed, price, comfort." },
          { text: "Describe transport in your city or town.", taskType: "Solo talk", hint: "What transport is popular?" },
          { text: "Tell a funny or strange transport moment.", taskType: "Solo talk", hint: "Something that happened on the road or in a bus." }
        ]
      },
      {
        id: 19,
        name: "Friends",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Describe your best friend.", taskType: "Solo talk", hint: "Appearance, character and hobbies." },
          { text: "Talk about what you do together.", taskType: "Solo talk", hint: "Give 2‚Äì3 activities." },
          { text: "Student A: Ask about Student B‚Äôs friends. Student B: Answer.", taskType: "Pair Q&A", hint: "Use: How long have you been friends? What do you do together?" },
          { text: "What makes a good friend?", taskType: "Solo talk", hint: "Give 3 qualities." },
          { text: "Describe a fun moment with your friend.", taskType: "Solo talk", hint: "Where were you? What happened?" },
          { text: "Talk about a small friendship problem and how to solve it.", taskType: "Solo talk", hint: "For example: argument, jealousy, etc." }
        ]
      },
      {
        id: 20,
        name: "My Future",
        level: "Beginner",
        type: "solo/pair",
        prompts: [
          { text: "Talk about your future job.", taskType: "Solo talk", hint: "Why do you want this job?" },
          { text: "Describe your dream life at 20 years old.", taskType: "Solo talk", hint: "Where will you live? What will you do?" },
          { text: "Student A: Ask about Student B‚Äôs future plans. Student B: Answer.", taskType: "Pair Q&A", hint: "Use: What will you‚Ä¶? Do you want to‚Ä¶?" },
          { text: "What do you want to learn next year?", taskType: "Solo talk", hint: "School subjects, skills, hobbies." },
          { text: "Where would you like to live in the future?", taskType: "Solo talk", hint: "City, village, country ‚Äì explain why." },
          { text: "Tell about one big dream you have.", taskType: "Solo talk", hint: "How can you make it real?" }
        ]
      }
    ];

    /* ---------- STATE ---------- */
    let currentUser = null;  // { pin, cls }
    let currentTopic = null;
    let currentIndex = 0;
    let timerId = null;
    let timeLeft = 0;

    // progress[pin][topicId] = [true/false,...]
    const PROGRESS_KEY = "aiBayanSpeakingProgress";
    let progress = loadProgress();

    // AI usage by day: usage[pin] = { date, count }
    const AI_USAGE_KEY = "aiBayanSpeakingAiUsage";
    let aiUsage = loadAiUsage();

    /* ---------- DOM ---------- */
    const loginScreen = document.getElementById("loginScreen");
    const appScreen = document.getElementById("appScreen");
    const loginBtn = document.getElementById("loginBtn");
    const pinInput = document.getElementById("pinInput");
    const loginError = document.getElementById("loginError");
    const loginClassInfo = document.getElementById("loginClassInfo");
    const userChip = document.getElementById("userChip");

    const topicChips = document.getElementById("topicChips");
    const timerSelect = document.getElementById("timerSelect");
    const startTimerBtn = document.getElementById("startTimerBtn");
    const timerDisplay = document.getElementById("timerDisplay");

    const topicNameEl = document.getElementById("topicName");
    const topicLevelEl = document.getElementById("topicLevel");
    const promptIndexEl = document.getElementById("promptIndex");
    const promptTypeEl = document.getElementById("promptType");
    const promptTextEl = document.getElementById("promptText");
    const promptHintEl = document.getElementById("promptHint");

    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const randomBtn = document.getElementById("randomBtn");
    const printBtn = document.getElementById("printBtn");
    const toggleDoneBtn = document.getElementById("toggleDoneBtn");
    const doneStatus = document.getElementById("doneStatus");
    const progressInner = document.getElementById("progressInner");
    const progressText = document.getElementById("progressText");

    const chatBox = document.getElementById("chatBox");
    const aiQuestion = document.getElementById("aiQuestion");
    const askBtn = document.getElementById("askBtn");
    const aiLimitEl = document.getElementById("aiLimit");
    const aiError = document.getElementById("aiError");

    const journalBox = document.getElementById("journalBox");
    const refreshJournalBtn = document.getElementById("refreshJournalBtn");

    /* ---------- LOCALSTORAGE HELPERS ---------- */
    function loadProgress(){
      try{
        const raw = localStorage.getItem(PROGRESS_KEY);
        return raw ? JSON.parse(raw) : {};
      }catch(e){
        return {};
      }
    }

    function saveProgress(){
      try{
        localStorage.setItem(PROGRESS_KEY, JSON.stringify(progress));
      }catch(e){}
    }

    function loadAiUsage(){
      try{
        const raw = localStorage.getItem(AI_USAGE_KEY);
        return raw ? JSON.parse(raw) : {};
      }catch(e){
        return {};
      }
    }

    function saveAiUsage(){
      try{
        localStorage.setItem(AI_USAGE_KEY, JSON.stringify(aiUsage));
      }catch(e){}
    }

    function todayStr(){
      return new Date().toISOString().slice(0,10); // YYYY-MM-DD
    }

    /* ---------- LOGIN ---------- */
    loginBtn.addEventListener("click",handleLogin);
    pinInput.addEventListener("keydown",e=>{
      if(e.key==="Enter") handleLogin();
    });

    function handleLogin(){
      const pin = Number(pinInput.value.trim());
      loginError.textContent = "";
      loginClassInfo.textContent = "";

      if(!pin || isNaN(pin)){
        loginError.textContent = "Please enter your PIN code.";
        return;
      }
      const cls = getClassByPin(pin);
      if(!cls){
        loginError.textContent = "PIN not found. Ask your teacher.";
        return;
      }

      currentUser = { pin, cls };
      userChip.textContent = "Class " + cls + " ‚Ä¢ PIN " + pin;
      loginClassInfo.textContent = "Welcome! Class " + cls + ". You can start speaking practice.";
      // show app
      loginScreen.style.display = "none";
      appScreen.style.display = "flex";
      document.querySelector("header").style.display = "flex";

      updateAiLimitInfo();
      renderTopics();
      renderPrompt();
      renderJournal();
    }

    /* ---------- TOPIC RENDERING ---------- */
    function renderTopics(){
      topicChips.innerHTML = "";
      topics.forEach(t => {
        const chip = document.createElement("button");
        chip.className = "chip";
        chip.textContent = t.id + ". " + t.name;
        chip.dataset.id = t.id;
        chip.addEventListener("click",()=>selectTopic(t.id));
        topicChips.appendChild(chip);
      });
      updateActiveChip();
    }

    function updateActiveChip(){
      const chips = document.querySelectorAll(".chip");
      chips.forEach(ch=>{
        const id = Number(ch.dataset.id);
        ch.classList.toggle("active",currentTopic && currentTopic.id===id);
      });
    }

    function selectTopic(id){
      const t = topics.find(x=>x.id===id);
      if(!t) return;
      currentTopic = t;
      currentIndex = 0;
      updateActiveChip();
      renderPrompt();
      resetTimerDisplay();
    }

    /* ---------- PROMPT RENDER ---------- */
    function renderPrompt(){
      if(!currentTopic){
        topicNameEl.textContent = "Choose a topic above";
        topicLevelEl.textContent = "";
        promptIndexEl.textContent = "";
        promptTypeEl.textContent = "";
        promptTextEl.textContent = "Click on a topic and start speaking.";
        promptHintEl.textContent = "";
        updateProgressUI();
        return;
      }
      const total = currentTopic.prompts.length;
      const item = currentTopic.prompts[currentIndex];

      topicNameEl.textContent = currentTopic.name;
      topicLevelEl.textContent = currentTopic.level;
      promptIndexEl.textContent = "Question " + (currentIndex+1) + " of " + total;
      promptTypeEl.textContent = item.taskType || "";
      promptTextEl.textContent = item.text;
      promptHintEl.textContent = item.hint ? "Hint: " + item.hint : "";

      updateProgressUI();
    }

    /* ---------- PROGRESS / DONE ---------- */
    function getUserProgress(){
      if(!currentUser) return null;
      if(!progress[currentUser.pin]) progress[currentUser.pin] = {};
      return progress[currentUser.pin];
    }

    function isCurrentDone(){
      if(!currentUser || !currentTopic) return false;
      const userProg = getUserProgress();
      if(!userProg[currentTopic.id]) userProg[currentTopic.id] = new Array(currentTopic.prompts.length).fill(false);
      return !!userProg[currentTopic.id][currentIndex];
    }

    function toggleCurrentDone(){
      if(!currentUser || !currentTopic) return;
      const userProg = getUserProgress();
      if(!userProg[currentTopic.id]) userProg[currentTopic.id] = new Array(currentTopic.prompts.length).fill(false);
      userProg[currentTopic.id][currentIndex] = !userProg[currentTopic.id][currentIndex];
      saveProgress();
      updateProgressUI();
      renderJournal();
    }

    function updateProgressUI(){
      if(!currentTopic){
        doneStatus.textContent = "Not done";
        doneStatus.classList.add("off");
        progressInner.style.width = "0%";
        progressText.textContent = "0 / 0 done";
        toggleDoneBtn.disabled = true;
        return;
      }
      toggleDoneBtn.disabled = false;

      const userProg = getUserProgress();
      if(!userProg[currentTopic.id]) userProg[currentTopic.id] = new Array(currentTopic.prompts.length).fill(false);
      const arr = userProg[currentTopic.id];
      const total = currentTopic.prompts.length;
      const doneCount = arr.filter(Boolean).length;

      const isDone = arr[currentIndex];
      if(isDone){
        doneStatus.textContent = "Done ‚úî";
        doneStatus.classList.remove("off");
        toggleDoneBtn.textContent = "‚úñ Unmark done";
      }else{
        doneStatus.textContent = "Not done";
        doneStatus.classList.add("off");
        toggleDoneBtn.textContent = "‚úî Mark as done";
      }

      const percent = total ? (doneCount/total)*100 : 0;
      progressInner.style.width = percent + "%";
      progressText.textContent = doneCount + " / " + total + " done";
    }

    toggleDoneBtn.addEventListener("click",toggleCurrentDone);

    /* ---------- TIMER ---------- */
    function resetTimerDisplay(){
      if(timerId){
        clearInterval(timerId);
        timerId = null;
      }
      const sec = Number(timerSelect.value);
      timerDisplay.textContent = sec>0 ? (sec + "s") : "‚Äì";
    }

    function startTimer(){
      const seconds = Number(timerSelect.value);
      if(!seconds){
        timerDisplay.textContent = "‚Äì";
        return;
      }
      if(timerId) clearInterval(timerId);

      timeLeft = seconds;
      timerDisplay.textContent = timeLeft + "s";

      timerId = setInterval(()=>{
        timeLeft--;
        if(timeLeft<=0){
          clearInterval(timerId);
          timerId = null;
          timerDisplay.textContent = "‚è∞ time!";
          return;
        }
        timerDisplay.textContent = timeLeft + "s";
      },1000);
    }

    startTimerBtn.addEventListener("click",startTimer);
    timerSelect.addEventListener("change",resetTimerDisplay);

    /* ---------- NAV BUTTONS ---------- */
    prevBtn.addEventListener("click",()=>{
      if(!currentTopic) return;
      currentIndex = (currentIndex - 1 + currentTopic.prompts.length) % currentTopic.prompts.length;
      renderPrompt();
      resetTimerDisplay();
    });

    nextBtn.addEventListener("click",()=>{
      if(!currentTopic) return;
      currentIndex = (currentIndex + 1) % currentTopic.prompts.length;
      renderPrompt();
      resetTimerDisplay();
    });

    randomBtn.addEventListener("click",()=>{
      if(!currentTopic) return;
      const max = currentTopic.prompts.length;
      if(max<=1) return;
      let newIndex;
      do{
        newIndex = Math.floor(Math.random()*max);
      }while(newIndex===currentIndex);
      currentIndex = newIndex;
      renderPrompt();
      resetTimerDisplay();
    });

    /* ---------- PRINT WORKSHEET ---------- */
    printBtn.addEventListener("click",()=>{
      if(!currentTopic) return;
      const w = window.open("","_blank");
      if(!w) return;

      const title = currentTopic.name + " ‚Äì Speaking worksheet";
      const html = `
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>${title}</title>
<style>
  body{
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    margin:24px;
  }
  h1{
    font-size:1.4rem;
    margin-bottom:4px;
  }
  h2{
    font-size:1rem;
    margin-top:4px;
    color:#455a64;
  }
  ol{
    margin-top:12px;
  }
  li{
    margin-bottom:10px;
    line-height:1.4;
  }
  .type{
    font-size:.85rem;
    color:#546e7a;
  }
  .hint{
    font-size:.8rem;
    color:#78909c;
  }
</style>
</head>
<body>
  <h1>${currentTopic.name} ‚Äì Speaking questions</h1>
  <h2>Level: ${currentTopic.level}</h2>
  <ol>
    ${currentTopic.prompts.map(p=>`
      <li>
        <div>${p.text}</div>
        ${p.taskType ? `<div class="type">${p.taskType}</div>` : ""}
        ${p.hint ? `<div class="hint">Hint: ${p.hint}</div>` : ""}
      </li>`).join("")}
  </ol>
</body>
</html>
      `;
      w.document.open();
      w.document.write(html);
      w.document.close();
    });

    /* ---------- AI BAYAN INTEGRATION ---------- */
    const AI_ENDPOINT = "https://shiny-tree-f78c.aiko030500.workers.dev/";

    function getRemainingQuestionsToday(){
      if(!currentUser) return 0;
      const pin = currentUser.pin;
      const today = todayStr();
      const rec = aiUsage[pin];
      if(!rec || rec.date!==today) return 1; // limit = 1
      const used = rec.count || 0;
      return Math.max(0,1-used);
    }

    function updateAiLimitInfo(){
      if(!currentUser){
        aiLimitEl.textContent = "";
        askBtn.disabled = true;
        return;
      }
      const left = getRemainingQuestionsToday();
      if(left<=0){
        aiLimitEl.textContent = "Today you have used your 1 question. Come back tomorrow.";
        askBtn.disabled = true;
      }else{
        aiLimitEl.textContent = "You can ask " + left + " question today.";
        askBtn.disabled = false;
      }
    }

    function appendChatMessage(role,text){
      const div = document.createElement("div");
      div.className = "chat-msg " + (role==="user" ? "user" : "ai");
      const small = document.createElement("small");
      small.textContent = role==="user" ? "You" : "AI Bayan";
      const p = document.createElement("div");
      p.textContent = text;
      div.appendChild(small);
      div.appendChild(p);
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    askBtn.addEventListener("click",sendToAiBayan);
    aiQuestion.addEventListener("keydown",e=>{
      if(e.key==="Enter" && (e.ctrlKey || e.metaKey)){
        e.preventDefault();
        sendToAiBayan();
      }
    });

    function sendToAiBayan(){
      aiError.textContent = "";
      if(!currentUser){
        aiError.textContent = "Please login with your PIN.";
        return;
      }
      const left = getRemainingQuestionsToday();
      if(left<=0){
        aiError.textContent = "Limit reached: 1 AI question per day for this PIN.";
        updateAiLimitInfo();
        return;
      }
      const q = aiQuestion.value.trim();
      if(!q){
        aiError.textContent = "Write a question for AI Bayan.";
        return;
      }

      appendChatMessage("user",q);
      aiQuestion.value = "";
      askBtn.disabled = true;
      askBtn.textContent = "Asking...";

      const payload = {
        question:q,
        pin:currentUser.pin,
        cls:currentUser.cls,
        section:"speaking_beginner",
        topic: currentTopic ? currentTopic.name : null,
        ts: new Date().toISOString()
      };

      fetch(AI_ENDPOINT,{
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify(payload)
      })
      .then(res=>res.text())
      .then(text=>{
        let answer = text;
        try{
          const obj = JSON.parse(text);
          answer = obj.answer || obj.response || obj.result || text;
        }catch(e){}
        appendChatMessage("ai",answer || "AI Bayan sent an empty answer.");
        // update usage
        const pin = currentUser.pin;
        const today = todayStr();
        const rec = aiUsage[pin];
        if(!rec || rec.date!==today){
          aiUsage[pin] = { date:today, count:1 };
        }else{
          aiUsage[pin].count = (aiUsage[pin].count||0)+1;
        }
        saveAiUsage();
        updateAiLimitInfo();
      })
      .catch(err=>{
        console.error(err);
        aiError.textContent = "Error: cannot connect to AI Bayan now.";
      })
      .finally(()=>{
        askBtn.disabled = getRemainingQuestionsToday()<=0;
        askBtn.textContent = "Ask AI Bayan";
      });
    }

    /* ---------- TEACHER JOURNAL ---------- */
    function renderJournal(){
      journalBox.innerHTML = "";
      const info = document.createElement("div");
      info.style.fontSize=".78rem";
      info.style.color="#78909c";
      info.textContent = "Journal shows how many tasks are marked 'done' for each PIN on this device.";
      journalBox.appendChild(info);

      const pins = Object.keys(progress).map(p=>Number(p)).sort((a,b)=>a-b);
      if(pins.length===0){
        const empty = document.createElement("div");
        empty.style.fontSize=".8rem";
        empty.style.marginTop = "6px";
        empty.textContent = "No data yet. When students mark questions as done, you will see it here.";
        journalBox.appendChild(empty);
        return;
      }

      pins.forEach(pin=>{
        const cls = getClassByPin(pin) || "?";
        const userProg = progress[pin] || {};
        let totalDone = 0;
        let totalTasks = 0;
        for(const topicId in userProg){
          const arr = userProg[topicId];
          if(Array.isArray(arr)){
            totalTasks += arr.length;
            totalDone += arr.filter(Boolean).length;
          }
        }
        const row = document.createElement("div");
        row.className = "journal-row";

        const left = document.createElement("span");
        left.className = "pin";
        left.textContent = "PIN " + pin + " (class " + cls + ")";

        const right = document.createElement("span");
        right.className = "info";
        right.textContent = totalDone + " / " + totalTasks + " done";

        row.appendChild(left);
        row.appendChild(right);
        journalBox.appendChild(row);
      });
    }

    refreshJournalBtn.addEventListener("click",renderJournal);

    /* ---------- INIT (NO AUTO-LOGIN, –¢–û–õ–¨–ö–û –ü–ò–ù) ---------- */
    renderTopics();
    renderPrompt();
  </script>
</body>
</html>
