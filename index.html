<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ENGLISH WITH AI BAYAN ‚Äì Beginner READING</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root{
      --brown-main:#7B4F27;   /* –Ω–∞—Å—ã—â–µ–Ω–Ω—ã–π –∫–æ—Ä–∏—á–Ω–µ–≤—ã–π */
      --brown-soft:#A36E3A;
      --gold:#E8C46C;
      --bg:#F3F7FA;           /* —Ñ–æ–Ω –∫–∞–∫ –≤ –≥—Ä–∞–º–º–∞—Ç–∏–∫–µ */
      --danger:#C62828;
      --correct:#1B5E20;
      --wrong:#B71C1C;
      --text-main:#3A2412;
    }

    *{
      box-sizing:border-box;
      margin:0;
      padding:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    }

    body{
      background:var(--bg);
      color:var(--text-main);
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    button{
      border:none;
      border-radius:999px;
      padding:7px 15px;
      font-size:.85rem;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.15s;
    }
    button:disabled{
      opacity:.5;
      cursor:not-allowed;
    }
    .btn-primary{
      background:var(--brown-main);
      color:#fff;
    }
    .btn-primary:hover:not(:disabled){
      background:#5d3b1d;
    }
    .btn-ghost{
      background:#ffffff;
      border:1px solid rgba(0,0,0,.12);
    }
    .btn-ghost:hover:not(:disabled){
      background:#f2e5d7;
    }

    /* ===== HEADER ===== */
    header{
      display:flex;
      background:linear-gradient(90deg,#7B4F27,#A36E3A);
      color:#fff;
      padding:10px 18px;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
      gap:12px;
    }
    .header-left{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logo-circle{
      width:54px;
      height:54px;
      border-radius:50%;
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      flex-shrink:0;
      box-shadow:0 0 0 3px rgba(123,79,39,.35);
    }
    .logo-circle img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .header-text-main{
      font-weight:700;
      font-size:.98rem;
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    .header-text-sub{
      font-size:.8rem;
      opacity:.95;
    }
    .user-chip{
      margin-top:2px;
      font-size:.76rem;
      background:rgba(0,0,0,.18);
      padding:3px 9px;
      border-radius:999px;
      display:inline-block;
    }
    .header-badge{
      background:rgba(255,255,255,.15);
      color:#fff8e1;
      padding:6px 10px;
      border-radius:999px;
      font-size:.78rem;
      display:flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .header-badge span.icon{
      font-size:1rem;
    }
    @media(max-width:700px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      .header-badge{
        align-self:flex-start;
      }
    }

    /* ===== LOGIN ===== */
    #loginScreen{
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px 12px;
    }
    .login-card{
      background:#fff;
      border-radius:18px;
      box-shadow:0 3px 10px rgba(0,0,0,.18);
      max-width:420px;
      width:100%;
      padding:18px 18px 20px;
    }
    .login-header{
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom:12px;
    }
    .login-title-main{
      font-size:1rem;
      font-weight:700;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:#4c2f16;
    }
    .login-title-sub{
      font-size:.85rem;
      color:#7B4F27;
    }
    .login-body{
      margin-top:10px;
      font-size:.88rem;
    }
    .login-body label{
      display:block;
      margin-bottom:6px;
      color:#4c2f16;
      font-weight:600;
    }
    .login-body input{
      width:100%;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.2);
      font-size:.9rem;
      margin-bottom:8px;
      outline:none;
    }
    .login-body input:focus{
      border-color:var(--brown-main);
      box-shadow:0 0 0 2px rgba(123,79,39,.25);
    }
    .login-footer{
      margin-top:8px;
      font-size:.78rem;
      color:#6d5b4a;
      line-height:1.4;
    }
    .login-error{
      margin-top:6px;
      font-size:.8rem;
      color:#b71c1c;
    }
    .login-class-info{
      margin-top:4px;
      font-size:.8rem;
      color:#33691E;
    }

    /* ===== MAIN LAYOUT ===== */
    #appScreen{
      display:none;
      flex:1;
      flex-direction:column;
    }
    main{
      flex:1;
      max-width:1180px;
      width:100%;
      margin:0 auto;
      padding:14px 12px 26px;
      display:grid;
      gap:14px;
    }
    @media(min-width:900px){
      main{
        grid-template-columns:1.8fr 1.2fr;
        align-items:flex-start;
      }
    }

    .panel{
      background:#fff;
      border-radius:16px;
      box-shadow:0 2px 8px rgba(0,0,0,.08);
      padding:14px 16px 18px;
    }
    .panel h2{
      font-size:1.02rem;
      margin-bottom:8px;
      color:#4c2f16;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .panel h2 span.icon{
      width:22px;
      height:22px;
      border-radius:999px;
      background:var(--brown-soft);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:.9rem;
    }
    .small-label{
      font-size:.8rem;
      color:#6d5b4a;
      margin-top:4px;
      margin-bottom:4px;
    }

    /* ----- TOP MENU: BACK / MAIN / PRINT ----- */
    .top-toolbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-bottom:8px;
      align-items:center;
    }

    /* topics menu */
    .topics-list{
      display:grid;
      gap:8px;
      margin-bottom:10px;
    }
    @media(min-width:900px){
      .topics-list{
        grid-template-columns:repeat(2,minmax(0,1fr));
      }
    }
    .topic-card{
      background:#ffffff;
      border-radius:12px;
      border:1px solid rgba(0,0,0,.06);
      box-shadow:0 1px 2px rgba(0,0,0,.05);
      padding:8px 10px;
      cursor:pointer;
      transition:.15s;
    }
    .topic-card:hover{
      box-shadow:0 3px 6px rgba(0,0,0,.12);
      transform:translateY(-1px);
      border-color:rgba(123,79,39,.35);
    }
    .topic-card.active{
      border-color:var(--brown-main);
      box-shadow:0 3px 6px rgba(0,0,0,.16);
    }
    .topic-title-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      margin-bottom:2px;
    }
    .topic-title{
      font-size:.9rem;
      font-weight:600;
      color:#3A2412;
    }
    .topic-level{
      font-size:.7rem;
      padding:2px 8px;
      border-radius:999px;
      background:#fff3cd;
      color:#795548;
    }
    .topic-sub{
      font-size:.78rem;
      color:#6d5b4a;
    }

    /* reading + exercises */
    .reading-layout{
      display:grid;
      gap:10px;
    }
    @media(min-width:800px){
      .reading-layout{
        grid-template-columns:1.2fr 1.1fr;
      }
    }

    .text-card{
      background:linear-gradient(135deg,#ffffff,#faefe1);
      border-radius:14px;
      border:1px solid rgba(0,0,0,.05);
      padding:12px 14px 14px;
    }
    .text-head{
      font-size:.78rem;
      text-transform:uppercase;
      letter-spacing:.09em;
      color:#865531;
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:4px;
    }
    .badge-level{
      padding:2px 9px;
      border-radius:999px;
      font-size:.7rem;
      background:#fff3cd;
      color:#795548;
    }
    .text-title{
      font-size:1rem;
      font-weight:600;
      margin-bottom:4px;
      color:#3A2412;
    }
    .text-body{
      font-size:.9rem;
      line-height:1.5;
      margin-bottom:6px;
    }
    .vocab-box{
      font-size:.78rem;
      color:#5d4037;
      background:#fffaf0;
      border-radius:10px;
      padding:6px 8px;
    }

    .ex-panel{
      background:#fdf7ef;
      border-radius:14px;
      border:1px solid rgba(0,0,0,.05);
      padding:10px 12px 12px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .ex-tabs{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }
    .ex-tab{
      font-size:.78rem;
      padding:5px 10px;
      border-radius:999px;
      border:1px solid transparent;
      background:transparent;
      color:#5d4037;
      cursor:pointer;
    }
    .ex-tab.active{
      background:#ffffff;
      border-color:#d7c2a7;
      box-shadow:0 1px 3px rgba(0,0,0,.12);
    }
    .ex-title{
      font-size:.9rem;
      font-weight:600;
      color:#4c2f16;
      margin-top:2px;
      margin-bottom:2px;
    }
    .ex-desc{
      font-size:.78rem;
      color:#6d5b4a;
      margin-bottom:4px;
    }
    .ex-content{
      font-size:.86rem;
      max-height:220px;
      overflow:auto;
      padding-right:4px;
    }
    .question-block{
      border-radius:10px;
      background:#ffffff;
      border:1px solid rgba(0,0,0,.05);
      padding:6px 8px;
      margin-bottom:6px;
    }
    .question-block.correct{
      border-color:var(--correct);
      background:#e8f5e9;
    }
    .question-block.wrong{
      border-color:var(--wrong);
      background:#ffebee;
    }
    .question-text{
      font-weight:500;
      margin-bottom:4px;
      color:#3A2412;
    }
    .option-label{
      display:block;
      margin-bottom:3px;
      cursor:pointer;
    }
    .small-note{
      font-size:.75rem;
      color:#6d5b4a;
      margin-top:2px;
    }
    .order-row{
      display:flex;
      align-items:flex-start;
      gap:6px;
      margin-bottom:5px;
    }
    .order-row select{
      padding:2px 6px;
      border-radius:6px;
      border:1px solid rgba(0,0,0,.2);
      font-size:.78rem;
      background:#fff;
    }

    .ex-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:4px;
      align-items:center;
    }
    .ex-result{
      font-size:.8rem;
      color:#3A2412;
    }
    .ex-result.good{
      color:var(--correct);
    }
    .ex-result.bad{
      color:var(--wrong);
    }

    .progress-info{
      margin-top:6px;
      font-size:.78rem;
      color:#5d4037;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    .progress-bar{
      flex:1;
      height:6px;
      border-radius:999px;
      background:#e0d3c4;
      overflow:hidden;
      min-width:80px;
    }
    .progress-bar-inner{
      height:100%;
      width:0%;
      background:var(--brown-main);
      transition:width .2s;
    }
    .done-badge{
      font-size:.75rem;
      padding:3px 9px;
      border-radius:999px;
      background:#e8f5e9;
      color:var(--correct);
    }
    .done-badge.off{
      background:#ffebee;
      color:var(--wrong);
    }

    /* ===== RIGHT PANEL (AI + journal) ===== */
    .chat-note{
      font-size:.78rem;
      color:#6d5b4a;
      margin-bottom:6px;
    }
    .chat-note b{
      color:#4c2f16;
    }
    #aiLimit{
      font-weight:600;
    }
    .chat-box{
      border-radius:12px;
      border:1px solid rgba(0,0,0,.08);
      padding:8px 10px;
      background:#fffaf3;
      max-height:210px;
      overflow:auto;
      font-size:.8rem;
      margin-bottom:8px;
    }
    .chat-msg{
      margin-bottom:6px;
      padding:6px 8px;
      border-radius:10px;
    }
    .chat-msg.user{
      background:#ffe0b2;
    }
    .chat-msg.ai{
      background:#e8f5e9;
    }
    .chat-msg small{
      display:block;
      font-size:.7rem;
      color:#5d4037;
      margin-bottom:2px;
    }
    #aiQuestion{
      width:100%;
      min-height:60px;
      max-height:100px;
      padding:6px 8px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.18);
      resize:vertical;
      font-size:.84rem;
      outline:none;
      background:#fffdf7;
    }
    #aiQuestion:focus{
      border-color:var(--brown-main);
      box-shadow:0 0 0 2px rgba(123,79,39,.2);
    }
    .chat-actions{
      margin-top:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
      font-size:.78rem;
      color:#6d5b4a;
    }
    .danger-text{
      color:var(--danger);
      font-size:.78rem;
      margin-top:4px;
    }

    .journal-header{
      margin-top:10px;
      font-size:.84rem;
      font-weight:600;
      color:#4c2f16;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
    }
    .journal-box{
      margin-top:6px;
      border-radius:10px;
      border:1px solid rgba(0,0,0,.08);
      padding:6px 8px;
      max-height:160px;
      overflow:auto;
      font-size:.78rem;
      background:#fdf7ef;
    }
    .journal-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:3px 0;
      border-bottom:1px dashed rgba(0,0,0,.07);
    }
    .journal-row:last-child{
      border-bottom:none;
    }
    .journal-row span.pin{
      font-weight:600;
      color:#3A2412;
    }
    .journal-row span.info{
      color:#6d5b4a;
    }

    @media print{
      header, #loginScreen, .top-toolbar{ display:none !important; }
      body{ background:#fff; }
      .panel{ box-shadow:none; }
    }
  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="header-left">
      <div class="logo-circle">
        <img src="logo.png" alt="AI Bayan logo" onerror="this.style.display='none';">
      </div>
      <div>
        <div class="header-text-main">ENGLISH WITH AI BAYAN</div>
        <div class="header-text-sub">
          Beginner ‚Äì stars ‚Äì reading topics
        </div>
        <div id="userChip" class="user-chip">Not logged in</div>
      </div>
    </div>
    <div class="header-badge">
      <span class="icon">üìñ</span>
      <span>Read ‚Ä¢ Think ‚Ä¢ Answer</span>
    </div>
  </header>

  <!-- LOGIN -->
  <div id="loginScreen">
    <div class="login-card">
      <div class="login-header">
        <div class="logo-circle">
          <img src="logo.png" alt="AI Bayan logo" onerror="this.style.display='none';">
        </div>
        <div>
          <div class="login-title-main">ENGLISH WITH AI BAYAN</div>
          <div class="login-title-sub">BEGINNER ‚Äì READING with AI Bayan</div>
        </div>
      </div>

      <div class="login-body">
        <label for="pinInput">Enter your PIN code</label>
        <input id="pinInput" type="number" placeholder="Ask your teacher for PIN" />
        <button id="loginBtn" class="btn-primary">Login</button>
        <div id="loginError" class="login-error"></div>
        <div id="loginClassInfo" class="login-class-info"></div>
      </div>

      <div class="login-footer">
        PIN codes are the same as in ENGLISH WITH AI BAYAN ‚Äì Beginner (grammar).<br>
        Teacher PIN: 3244 (Tcher).
      </div>
    </div>
  </div>

  <!-- APP -->
  <div id="appScreen">
    <main>
      <!-- LEFT: MENU + TEXT + EXERCISES -->
      <section class="panel">
        <h2><span class="icon">üìö</span> Reading ‚Äì Beginner</h2>

        <div class="top-toolbar">
          <button id="backBtn" class="btn-ghost">‚Üê Back</button>
          <button id="mainMenuBtn" class="btn-ghost">Main menu</button>
          <button id="printBtn" class="btn-ghost">üñ® Print</button>
        </div>

        <p class="small-label">Choose a text:</p>
        <div id="topicsList" class="topics-list"></div>

        <div class="reading-layout">
          <!-- TEXT -->
          <div class="text-card">
            <div class="text-head">
              <span id="topicName">Choose a text above</span>
              <span id="topicLevel" class="badge-level"></span>
            </div>
            <div id="textTitle" class="text-title"></div>
            <div id="textBody" class="text-body">
              Select one of the topics above to start reading.
            </div>
            <div id="vocabBox" class="vocab-box" style="display:none;"></div>
          </div>

          <!-- EXERCISES -->
          <div class="ex-panel">
            <div class="ex-tabs" id="exTabs"></div>
            <div class="ex-title" id="exTitle"></div>
            <div class="ex-desc" id="exDesc"></div>
            <div class="ex-content" id="exContent"></div>
            <div class="ex-buttons">
              <button id="checkBtn" class="btn-primary">Check exercise</button>
              <button id="resetBtn" class="btn-ghost">Reset</button>
              <button id="toggleDoneBtn" class="btn-ghost">‚úî Mark topic as done</button>
              <span id="exResult" class="ex-result"></span>
            </div>
            <div class="progress-info">
              <div id="doneStatus" class="done-badge off">Not done</div>
              <div class="progress-bar">
                <div id="progressInner" class="progress-bar-inner"></div>
              </div>
              <div id="progressText">0 / 0 topics done</div>
            </div>
          </div>
        </div>

        <p class="small-label">
          Teacher idea: Students first read silently, then do tasks 1‚Äì6 step by step. Stronger students can start from task 3 or 4.
        </p>
      </section>

      <!-- RIGHT: AI + JOURNAL -->
      <aside class="panel">
        <h2><span class="icon">ü§ñ</span> AI Bayan ‚Äì help for reading</h2>
        <p class="chat-note">
          Ask AI Bayan about <b>words, grammar or translation</b> from the text.<br>
          Students: limit <b>1 question per day</b> for each PIN.<br>
          Teacher Tcher (PIN 3244): <b>no limit</b>.<br>
          <span id="aiLimit"></span>
        </p>

        <div id="chatBox" class="chat-box"></div>

        <textarea id="aiQuestion"
          placeholder="Write your question for AI Bayan (English or Russian)..."></textarea>

        <div class="chat-actions">
          <button id="askBtn" class="btn-primary">Ask AI Bayan</button>
          <span>AI answers are saved only on this device.</span>
        </div>
        <div id="aiError" class="danger-text"></div>

        <div class="journal-header">
          <span>Teacher journal (this device)</span>
          <button id="refreshJournalBtn" class="btn-ghost">Refresh</button>
        </div>
        <div id="journalBox" class="journal-box">
          <div style="font-size:.78rem;color:#6d5b4a;">
            Journal shows how many reading topics are marked ‚Äúdone‚Äù by each PIN on this device (students only).
          </div>
        </div>
      </aside>
    </main>
  </div>

  <script>
    /* ----- PIN ranges (students) ----- */
    const classRanges = [
      { cls: "3E",  from: 101, to: 115 },
      { cls: "4G",  from: 201, to: 215 },
      { cls: "5G",  from: 301, to: 315 },
      { cls: "5Zh", from: 401, to: 415 },
      { cls: "6G",  from: 501, to: 515 },
      { cls: "7B",  from: 601, to: 615 },
      { cls: "7V",  from: 701, to: 715 },
      { cls: "8E",  from: 801, to: 815 },
      { cls: "9Zh", from: 901, to: 915 }
    ];
    function getClassByPin(pin){
      for(const r of classRanges){
        if(pin>=r.from && pin<=r.to) return r.cls;
      }
      return null;
    }

    /* ----- DATA: READING TOPICS (6 –ø—Ä–∏–º–µ—Ä–æ–≤; –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –¥–æ 20) ----- */
    const topics = [
      {
        id:1,
        name:"My School Day",
        level:"Beginner",
        title:"A Busy School Day",
        text:"My name is Aigerim and I am eleven years old. I usually get up at seven o‚Äôclock. I have breakfast with my family and then I walk to school with my friend Dana. Our lessons start at eight. We have Maths, English and PE in the morning. I like English best because we play games and speak a lot. We usually finish school at one o‚Äôclock. In the afternoon I do my homework, help my mum and then I watch a little TV or chat with my friends online. I always go to bed before ten.",
        vocab:"finish ‚Äì –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å; before ‚Äì –ø–µ—Ä–µ–¥; online ‚Äì –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.",
        exercises:[
          {
            type:"trueFalse",
            title:"Ex 1. True or False",
            desc:"Read the sentences. Are they true (T) or false (F)?",
            items:[
              { text:"Aigerim is eleven years old.", answer:true },
              { text:"She goes to school by bus.", answer:false },
              { text:"She likes English best.", answer:true },
              { text:"She usually finishes school at four o‚Äôclock.", answer:false }
            ]
          },
          {
            type:"mcq",
            title:"Ex 2. Multiple choice",
            desc:"Choose the correct answer (A, B or C).",
            items:[
              {
                q:"Who does Aigerim go to school with?",
                options:["With her brother.","With her friend Dana.","With her neighbour."],
                correct:1
              },
              {
                q:"What lessons does she have in the morning?",
                options:["Maths, English and PE.","Science and History.","Art and Music."],
                correct:0
              },
              {
                q:"What does she like doing in English lessons?",
                options:["Writing long tests.","Listening to the teacher only.","Playing games and speaking."],
                correct:2
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 3. Gap-fill",
            desc:"Choose the best word to complete the sentence.",
            items:[
              {
                q:"She usually gets up ___ seven o‚Äôclock.",
                options:["at","in","on"],
                correct:0
              },
              {
                q:"She walks to school ___ her friend.",
                options:["with","for","from"],
                correct:0
              },
              {
                q:"She goes to bed ___ ten.",
                options:["after","before","between"],
                correct:1
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 4. Main idea",
            desc:"What is the main idea of the text?",
            items:[
              {
                q:"Choose the best title.",
                options:[
                  "Aigerim‚Äôs favourite school subject.",
                  "Aigerim‚Äôs free time at the weekend.",
                  "Aigerim‚Äôs typical school day."
                ],
                correct:2
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 5. Parts of the text",
            desc:"Match the parts of the text with the information.",
            items:[
              {
                q:"The beginning of the text is mostly about‚Ä¶",
                options:["Aigerim‚Äôs evening.","Aigerim‚Äôs morning and school.","A trip to another city."],
                correct:1
              },
              {
                q:"The middle of the text is about‚Ä¶",
                options:["Her favourite subject.","Her pet.","Her grandparents."],
                correct:0
              },
              {
                q:"The end of the text is about‚Ä¶",
                options:["What she does after school.","Her friends‚Äô hobbies.","Her summer holidays."],
                correct:0
              }
            ]
          },
          {
            type:"order",
            title:"Ex 6. Order of events",
            desc:"Put the events in the correct order (1‚Äì4).",
            items:[
              { text:"She does her homework and helps her mum.", order:3 },
              { text:"She has breakfast with her family.", order:1 },
              { text:"She walks to school with Dana.", order:2 },
              { text:"She watches TV or chats online.", order:4 }
            ]
          }
        ]
      },
      {
        id:2,
        name:"My Best Friend",
        level:"Beginner",
        title:"My Best Friend Timur",
        text:"My best friend‚Äôs name is Timur. He is in my class. Timur is tall and slim. He has short dark hair and big brown eyes. He is very friendly and always helps other students. We usually sit together in English lessons. After school we sometimes play football in the yard or go to the park. Timur loves computer games, but he never forgets to do his homework. When I have a problem, I can always talk to him.",
        vocab:"slim ‚Äì —Å—Ç—Ä–æ–π–Ω—ã–π; friendly ‚Äì –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π; yard ‚Äì –¥–≤–æ—Ä.",
        exercises:[
          {
            type:"trueFalse",
            title:"Ex 1. True or False",
            desc:"Are the sentences true (T) or false (F)?",
            items:[
              { text:"Timur is in another school.", answer:false },
              { text:"He is tall and slim.", answer:true },
              { text:"He is unfriendly and rude.", answer:false },
              { text:"He loves computer games.", answer:true }
            ]
          },
          {
            type:"mcq",
            title:"Ex 2. Multiple choice",
            desc:"Choose the correct answer.",
            items:[
              {
                q:"Where do the friends usually sit together?",
                options:["In Maths lessons.","In English lessons.","In PE lessons."],
                correct:1
              },
              {
                q:"What do they sometimes do after school?",
                options:["Play football or go to the park.","Study in the library.","Go shopping."],
                correct:0
              },
              {
                q:"What can the writer do when he has a problem?",
                options:["Ignore it.","Talk to Timur.","Talk only to the teacher."],
                correct:1
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 3. Gap-fill",
            desc:"Choose the word that best completes the sentence.",
            items:[
              {
                q:"Timur always helps ___ students.",
                options:["other","another","others"],
                correct:0
              },
              {
                q:"They sometimes play football ___ the yard.",
                options:["in","on","at"],
                correct:0
              },
              {
                q:"He never forgets ___ his homework.",
                options:["does","doing","to do"],
                correct:2
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 4. Main idea",
            desc:"Choose the best sentence that describes the text.",
            items:[
              {
                q:"The text is mainly about‚Ä¶",
                options:[
                  "Timur‚Äôs favourite computer games.",
                  "Timur‚Äôs appearance and character as a good friend.",
                  "A football match in the park."
                ],
                correct:1
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 5. Parts of the text",
            desc:"Answer about parts of the text.",
            items:[
              {
                q:"The first part of the text describes‚Ä¶",
                options:["what Timur looks like.","where they play.","their school rules."],
                correct:0
              },
              {
                q:"The middle of the text describes‚Ä¶",
                options:["Timur‚Äôs family.","their activities together.","a school trip."],
                correct:1
              },
              {
                q:"The last sentence shows‚Ä¶",
                options:["that Timur is a very important friend.","that they don‚Äôt talk much.","that Timur hates problems."],
                correct:0
              }
            ]
          },
          {
            type:"order",
            title:"Ex 6. Order of events",
            desc:"Put these ideas in the order they appear in the text.",
            items:[
              { text:"Timur‚Äôs appearance is described.", order:2 },
              { text:"The writer explains he can talk to Timur about problems.", order:4 },
              { text:"We learn Timur is in the same class.", order:1 },
              { text:"We read about what they do after school.", order:3 }
            ]
          }
        ]
      },
      {
        id:3,
        name:"Rainy Sunday",
        level:"Beginner",
        title:"A Rainy Sunday at Home",
        text:"On Sunday the weather was terrible. It was cold, rainy and windy, so my family stayed at home. In the morning my mum baked apple pies in the kitchen. They smelled wonderful. My dad read a book in the living room. My sister and I did our homework and then played board games. After lunch we watched a funny film together. In the evening we drank hot tea with pie and talked. It was a quiet but very cosy day.",
        vocab:"terrible ‚Äì —É–∂–∞—Å–Ω—ã–π; smelled ‚Äì –ø–∞—Ö–ª–∏; cosy ‚Äì —É—é—Ç–Ω—ã–π.",
        exercises:[
          {
            type:"trueFalse",
            title:"Ex 1. True or False",
            desc:"Decide if the sentences are true (T) or false (F).",
            items:[
              { text:"The weather was sunny and hot.", answer:false },
              { text:"The family stayed at home.", answer:true },
              { text:"The children played board games.", answer:true },
              { text:"In the evening they went to the cinema.", answer:false }
            ]
          },
          {
            type:"mcq",
            title:"Ex 2. Multiple choice",
            desc:"Choose the correct answer.",
            items:[
              {
                q:"Why did the family stay at home?",
                options:["Because the weather was terrible.","Because the TV was broken.","Because it was a holiday."],
                correct:0
              },
              {
                q:"What did the mum do?",
                options:["She read a book.","She baked apple pies.","She went shopping."],
                correct:1
              },
              {
                q:"What did they do after lunch?",
                options:["Watched a film.","Cleaned the house.","Went for a walk."],
                correct:0
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 3. Gap-fill",
            desc:"Choose the best word.",
            items:[
              {
                q:"The pies ___ wonderful.",
                options:["smelled","looked","sounded"],
                correct:0
              },
              {
                q:"They watched a ___ film.",
                options:["quiet","funny","boring"],
                correct:1
              },
              {
                q:"It was a quiet but very ___ day.",
                options:["cosy","cold","dangerous"],
                correct:0
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 4. Main idea",
            desc:"What is the main idea of the text?",
            items:[
              {
                q:"The text shows that‚Ä¶",
                options:[
                  "a rainy day can still be nice at home.",
                  "rainy days are always boring.",
                  "the family likes travelling."
                ],
                correct:0
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 5. Parts of the text",
            desc:"Answer about different parts of the story.",
            items:[
              {
                q:"The beginning describes‚Ä¶",
                options:["the evening.","the weather and the decision to stay home.","the lunch."],
                correct:1
              },
              {
                q:"The middle part describes‚Ä¶",
                options:["what everyone does at home.","a trip to the city.","a school day."],
                correct:0
              },
              {
                q:"The end of the text describes‚Ä¶",
                options:["the next morning.","the evening with tea and talking.","their neighbours."],
                correct:1
              }
            ]
          },
          {
            type:"order",
            title:"Ex 6. Order of events",
            desc:"Put the events in the correct order.",
            items:[
              { text:"They watched a funny film.", order:3 },
              { text:"Mum baked apple pies.", order:1 },
              { text:"The children did homework and played board games.", order:2 },
              { text:"They drank hot tea and talked.", order:4 }
            ]
          }
        ]
      },
      {
        id:4,
        name:"Visit to Granny",
        level:"Beginner",
        title:"Weekend at Granny‚Äôs House",
        text:"Every month I visit my granny in the village. She lives in a small but beautiful house with a big garden. In the morning we feed the chickens and water the flowers. Sometimes we pick apples and berries. My granny cooks very tasty soup and homemade bread. In the evening we sit on the bench in front of the house and watch the stars. I love these quiet weekends.",
        vocab:"pick ‚Äì —Å–æ–±–∏—Ä–∞—Ç—å; homemade ‚Äì –¥–æ–º–∞—à–Ω–∏–π; bench ‚Äì —Å–∫–∞–º–µ–π–∫–∞.",
        exercises:[
          {
            type:"trueFalse",
            title:"Ex 1. True or False",
            desc:"True (T) or false (F)?",
            items:[
              { text:"The writer visits granny every week.", answer:false },
              { text:"Granny has a big garden.", answer:true },
              { text:"They watch TV every evening.", answer:false },
              { text:"The writer likes these weekends.", answer:true }
            ]
          },
          {
            type:"mcq",
            title:"Ex 2. Multiple choice",
            desc:"Choose the correct answer.",
            items:[
              {
                q:"Where does granny live?",
                options:["In a village.","In the city centre.","Near the sea."],
                correct:0
              },
              {
                q:"What do they do in the morning?",
                options:["Go to school.","Feed chickens and water flowers.","Sleep all day."],
                correct:1
              },
              {
                q:"What do they watch in the evening?",
                options:["The stars.","The river.","Cars."],
                correct:0
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 3. Gap-fill",
            desc:"Choose the best word.",
            items:[
              {
                q:"Granny lives in a small but ___ house.",
                options:["ugly","beautiful","dirty"],
                correct:1
              },
              {
                q:"They sometimes pick apples and ___.",
                options:["trees","books","berries"],
                correct:2
              },
              {
                q:"The bread is ___.",
                options:["homemade","fast","cold"],
                correct:0
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 4. Main idea",
            desc:"Choose the best sentence.",
            items:[
              {
                q:"The text is mostly about‚Ä¶",
                options:[
                  "a noisy weekend in the city.",
                  "quiet and happy weekends at granny‚Äôs house.",
                  "a difficult school day."
                ],
                correct:1
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 5. Parts of the text",
            desc:"Answer about the parts.",
            items:[
              {
                q:"The first part tells us about‚Ä¶",
                options:["how often the writer visits and where granny lives.","what they eat.","who lives next door."],
                correct:0
              },
              {
                q:"The middle part tells us about‚Ä¶",
                options:["school subjects.","their morning work and food.","a TV show."],
                correct:1
              },
              {
                q:"The last sentence shows‚Ä¶",
                options:["the writer doesn‚Äôt like the weekends.","the writer loves these weekends.","the writer wants to move to the city."],
                correct:1
              }
            ]
          },
          {
            type:"order",
            title:"Ex 6. Order of events",
            desc:"Put the ideas in order.",
            items:[
              { text:"They sit on the bench and watch the stars.", order:4 },
              { text:"They feed the chickens.", order:2 },
              { text:"We learn that the writer visits granny every month.", order:1 },
              { text:"They eat tasty soup and bread.", order:3 }
            ]
          }
        ]
      },
      {
        id:5,
        name:"Four Seasons",
        level:"Beginner",
        title:"The Four Seasons",
        text:"There are four seasons in a year: spring, summer, autumn and winter. In spring the weather gets warmer and trees become green. Many people feel happy after a long winter. In summer it is usually hot. Children have holidays and often go to camps, the sea or the village. Autumn is a colourful season with yellow and red leaves. It is time to go back to school. In winter it is cold and snowy. We can play snowballs, skate and drink hot tea at home.",
        vocab:"become ‚Äì —Å—Ç–∞–Ω–æ–≤–∏—Ç—å—Å—è; leaves ‚Äì –ª–∏—Å—Ç—å—è; snowballs ‚Äì —Å–Ω–µ–∂–∫–∏.",
        exercises:[
          {
            type:"trueFalse",
            title:"Ex 1. True or False",
            desc:"Read and mark T/F.",
            items:[
              { text:"In spring the weather gets colder.", answer:false },
              { text:"In summer children often have holidays.", answer:true },
              { text:"Autumn is a colourful season.", answer:true },
              { text:"In winter it is usually very hot.", answer:false }
            ]
          },
          {
            type:"mcq",
            title:"Ex 2. Multiple choice",
            desc:"Choose the correct answer.",
            items:[
              {
                q:"What happens in spring?",
                options:["Trees become green.","Leaves become black.","It starts to snow."],
                correct:0
              },
              {
                q:"Where can children go in summer?",
                options:["Only to school.","To camps or the sea.","Nowhere."],
                correct:1
              },
              {
                q:"What can we do in winter?",
                options:["Swim in the river.","Play snowballs and skate.","Plant flowers."],
                correct:1
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 3. Gap-fill",
            desc:"Choose the correct missing word.",
            items:[
              {
                q:"Autumn is a ___ season.",
                options:["colourful","boring","empty"],
                correct:0
              },
              {
                q:"In winter it is cold and ___.",
                options:["green","snowy","windy only"],
                correct:1
              },
              {
                q:"In summer children often go on ___.",
                options:["homework","holidays","lessons"],
                correct:1
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 4. Main idea",
            desc:"Choose the best title.",
            items:[
              {
                q:"The text is about‚Ä¶",
                options:[
                  "different sports in winter.",
                  "what people eat in summer.",
                  "the four seasons and what people do."
                ],
                correct:2
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 5. Parts of the text",
            desc:"Answer about parts.",
            items:[
              {
                q:"The first part tells us‚Ä¶",
                options:["only about winter.","the names of all seasons and spring.","about a trip."],
                correct:1
              },
              {
                q:"The middle part tells us‚Ä¶",
                options:["about summer and autumn.","about granny‚Äôs village.","about shopping."],
                correct:0
              },
              {
                q:"The last part tells us‚Ä¶",
                options:["about winter activities.","about breakfast.","about tests at school."],
                correct:0
              }
            ]
          },
          {
            type:"order",
            title:"Ex 6. Order of events",
            desc:"Put the seasons in the order they appear in the text.",
            items:[
              { text:"Summer ‚Äì children have holidays.", order:2 },
              { text:"Winter ‚Äì we play snowballs.", order:4 },
              { text:"Autumn ‚Äì colourful leaves.", order:3 },
              { text:"Spring ‚Äì trees become green.", order:1 }
            ]
          }
        ]
      },
      {
        id:6,
        name:"New Student",
        level:"Beginner",
        title:"A New Student in Our Class",
        text:"This year we have a new student in our class. His name is Daniel and he comes from another city. On the first day he was very quiet and a little nervous. Our teacher asked everybody to introduce themselves. After the lesson I showed Daniel the canteen and the gym. Now he has many friends and he often laughs in class. He says our class is friendly and he is happy here.",
        vocab:"quiet ‚Äì —Ç–∏—Ö–∏–π; nervous ‚Äì –Ω–µ—Ä–≤–Ω—ã–π; introduce ‚Äì –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—Ç—å—Å—è.",
        exercises:[
          {
            type:"trueFalse",
            title:"Ex 1. True or False",
            desc:"Are these sentences true (T) or false (F)?",
            items:[
              { text:"Daniel comes from the same city.", answer:false },
              { text:"He was nervous on the first day.", answer:true },
              { text:"The writer showed him the canteen.", answer:true },
              { text:"Now Daniel has no friends.", answer:false }
            ]
          },
          {
            type:"mcq",
            title:"Ex 2. Multiple choice",
            desc:"Choose the correct answer.",
            items:[
              {
                q:"What did the teacher ask the students to do?",
                options:["To introduce themselves.","To write a test.","To clean the classroom."],
                correct:0
              },
              {
                q:"Where did the writer take Daniel after the lesson?",
                options:["To the library and the office.","To the canteen and the gym.","Home."],
                correct:1
              },
              {
                q:"How does Daniel feel now?",
                options:["He is happy in this class.","He is still very nervous.","He wants to leave the school."],
                correct:0
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 3. Gap-fill",
            desc:"Choose the best word.",
            items:[
              {
                q:"Daniel is a new student in ___ class.",
                options:["our","his old","their"],
                correct:0
              },
              {
                q:"On the first day he was very ___ and nervous.",
                options:["noisy","quiet","angry"],
                correct:1
              },
              {
                q:"He says our class is ___.",
                options:["boring","strict","friendly"],
                correct:2
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 4. Main idea",
            desc:"Choose the best sentence.",
            items:[
              {
                q:"The main idea of the text is that‚Ä¶",
                options:[
                  "new students always feel bad.",
                  "a new student can become happy if the class is friendly.",
                  "teachers never help new students."
                ],
                correct:1
              }
            ]
          },
          {
            type:"mcq",
            title:"Ex 5. Parts of the text",
            desc:"Answer about different parts of the story.",
            items:[
              {
                q:"The beginning of the text tells us‚Ä¶",
                options:["Daniel‚Äôs hobbies.","that Daniel is new and from another city.","about summer holidays."],
                correct:1
              },
              {
                q:"The middle of the text tells us‚Ä¶",
                options:["about the first day and the tour of the school.","about tests.","about a football match."],
                correct:0
              },
              {
                q:"The last sentences tell us‚Ä¶",
                options:["that Daniel is unhappy.","that Daniel is happy and has friends.","that Daniel changed school again."],
                correct:1
              }
            ]
          },
          {
            type:"order",
            title:"Ex 6. Order of events",
            desc:"Put the events in the correct order.",
            items:[
              { text:"The teacher asks students to introduce themselves.", order:2 },
              { text:"Daniel was quiet and nervous.", order:1 },
              { text:"The writer shows Daniel the canteen and the gym.", order:3 },
              { text:"Daniel has many friends and feels happy.", order:4 }
            ]
          }
        ]
      }
    ];

    /* ----- STATE & STORAGE ----- */
    let currentUser=null;      // {pin, cls, isTeacher}
    let currentTopic=null;
    let currentExerciseIndex=0;

    const PROGRESS_KEY="aiBayanReadingBrownProgress";
    const AI_USAGE_KEY="aiBayanReadingBrownAi";

    let progress = loadJson(PROGRESS_KEY) || {};
    let aiUsage = loadJson(AI_USAGE_KEY) || {};
    let teacherTempProgress = {}; // –ø—Ä–æ–≥—Ä–µ—Å—Å —É—á–∏—Ç–µ–ª—è ‚Äì —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏

    function loadJson(key){
      try{
        const raw=localStorage.getItem(key);
        return raw?JSON.parse(raw):null;
      }catch(e){return null;}
    }
    function saveJson(key,obj){
      try{localStorage.setItem(key,JSON.stringify(obj));}catch(e){}
    }
    function todayStr(){return new Date().toISOString().slice(0,10);}

    /* ----- DOM ----- */
    const loginScreen=document.getElementById("loginScreen");
    const appScreen=document.getElementById("appScreen");
    const loginBtn=document.getElementById("loginBtn");
    const pinInput=document.getElementById("pinInput");
    const loginError=document.getElementById("loginError");
    const loginClassInfo=document.getElementById("loginClassInfo");
    const userChip=document.getElementById("userChip");

    const topicsList=document.getElementById("topicsList");
    const topicNameEl=document.getElementById("topicName");
    const topicLevelEl=document.getElementById("topicLevel");
    const textTitleEl=document.getElementById("textTitle");
    const textBodyEl=document.getElementById("textBody");
    const vocabBox=document.getElementById("vocabBox");

    const exTabs=document.getElementById("exTabs");
    const exTitle=document.getElementById("exTitle");
    const exDesc=document.getElementById("exDesc");
    const exContent=document.getElementById("exContent");
    const checkBtn=document.getElementById("checkBtn");
    const resetBtn=document.getElementById("resetBtn");
    const toggleDoneBtn=document.getElementById("toggleDoneBtn");
    const exResult=document.getElementById("exResult");
    const doneStatus=document.getElementById("doneStatus");
    const progressInner=document.getElementById("progressInner");
    const progressText=document.getElementById("progressText");

    const backBtn=document.getElementById("backBtn");
    const mainMenuBtn=document.getElementById("mainMenuBtn");
    const printBtn=document.getElementById("printBtn");

    const chatBox=document.getElementById("chatBox");
    const aiQuestion=document.getElementById("aiQuestion");
    const askBtn=document.getElementById("askBtn");
    const aiLimitEl=document.getElementById("aiLimit");
    const aiError=document.getElementById("aiError");

    const journalBox=document.getElementById("journalBox");
    const refreshJournalBtn=document.getElementById("refreshJournalBtn");

    /* ----- LOGIN ----- */
    loginBtn.addEventListener("click",handleLogin);
    pinInput.addEventListener("keydown",e=>{
      if(e.key==="Enter") handleLogin();
    });

    function handleLogin(){
      const pinStr=pinInput.value.trim();
      const pin=Number(pinStr);
      loginError.textContent="";
      loginClassInfo.textContent="";

      if(!pinStr){
        loginError.textContent="Please enter your PIN code.";
        return;
      }

      // TEACHER MODE
      if(pinStr==="3244"){
        currentUser={
          pin:3244,
          cls:"Teacher",
          isTeacher:true,
          name:"Tcher"
        };
        userChip.textContent="Teacher Tcher ‚Ä¢ PIN 3244 (Teacher mode)";
        loginClassInfo.textContent="Teacher mode: progress is not saved to student journal. AI has no limit.";
      }else{
        if(!pin || isNaN(pin)){
          loginError.textContent="PIN not found. Ask your teacher.";
          return;
        }
        const cls=getClassByPin(pin);
        if(!cls){
          loginError.textContent="PIN not found. Ask your teacher.";
          return;
        }
        currentUser={
          pin,
          cls,
          isTeacher:false
        };
        userChip.textContent="Class "+cls+" ‚Ä¢ PIN "+pin;
        loginClassInfo.textContent="Welcome! Class "+cls+". You can start reading practice.";
      }

      loginScreen.style.display="none";
      appScreen.style.display="flex";

      renderTopics();
      if(topics.length>0) selectTopic(topics[0].id);
      updateProgressUI();
      updateAiLimitInfo();
      renderJournal();
    }

    /* ----- TOPICS UI ----- */
    function renderTopics(){
      topicsList.innerHTML="";
      topics.forEach(t=>{
        const card=document.createElement("div");
        card.className="topic-card";
        card.dataset.id=t.id;

        const row=document.createElement("div");
        row.className="topic-title-row";

        const title=document.createElement("div");
        title.className="topic-title";
        title.textContent=t.id+". "+t.name;

        const level=document.createElement("div");
        level.className="topic-level";
        level.textContent=t.level;

        row.appendChild(title);
        row.appendChild(level);

        const sub=document.createElement("div");
        sub.className="topic-sub";
        sub.textContent=t.title;

        card.appendChild(row);
        card.appendChild(sub);

        card.addEventListener("click",()=>selectTopic(t.id));
        topicsList.appendChild(card);
      });
      updateActiveTopicCard();
    }

    function updateActiveTopicCard(){
      const cards=document.querySelectorAll(".topic-card");
      cards.forEach(card=>{
        const id=Number(card.dataset.id);
        card.classList.toggle("active",currentTopic && currentTopic.id===id);
      });
    }

    function selectTopic(id){
      const t=topics.find(x=>x.id===id);
      if(!t) return;
      currentTopic=t;
      currentExerciseIndex=0;
      updateActiveTopicCard();
      renderText();
      renderExerciseTabs();
      renderExercise();
      exResult.textContent="";
      exResult.className="ex-result";
      updateProgressUI();
    }

    function renderText(){
      if(!currentTopic){
        topicNameEl.textContent="Choose a text above";
        topicLevelEl.textContent="";
        textTitleEl.textContent="";
        textBodyEl.textContent="Select one of the topics above to start reading.";
        vocabBox.style.display="none";
        return;
      }
      topicNameEl.textContent=currentTopic.name;
      topicLevelEl.textContent=currentTopic.level;
      textTitleEl.textContent=currentTopic.title;
      textBodyEl.textContent=currentTopic.text;
      if(currentTopic.vocab){
        vocabBox.style.display="block";
        vocabBox.textContent="Vocabulary: "+currentTopic.vocab;
      }else{
        vocabBox.style.display="none";
      }
    }

    /* ----- EXERCISES ----- */
    function renderExerciseTabs(){
      exTabs.innerHTML="";
      if(!currentTopic) return;
      currentTopic.exercises.forEach((ex,idx)=>{
        const btn=document.createElement("button");
        btn.className="ex-tab";
        btn.textContent=(idx+1)+". "+ex.title.replace(/^Ex \\d+\\. /,"");
        btn.dataset.index=idx;
        btn.addEventListener("click",()=>{
          currentExerciseIndex=idx;
          renderExercise();
        });
        exTabs.appendChild(btn);
      });
      updateActiveExTab();
    }

    function updateActiveExTab(){
      const tabs=document.querySelectorAll(".ex-tab");
      tabs.forEach(t=>{
        const idx=Number(t.dataset.index);
        t.classList.toggle("active",idx===currentExerciseIndex);
      });
    }

    function renderExercise(){
      if(!currentTopic) return;
      updateActiveExTab();
      const ex=currentTopic.exercises[currentExerciseIndex];
      exTitle.textContent=ex.title;
      exDesc.textContent=ex.desc;
      exContent.innerHTML="";
      exResult.textContent="";
      exResult.className="ex-result";

      if(ex.type==="trueFalse" || ex.type==="mcq"){
        ex.items.forEach((item,idx)=>{
          const block=document.createElement("div");
          block.className="question-block";
          block.dataset.index=idx;

          const qText=document.createElement("div");
          qText.className="question-text";
          qText.textContent=(ex.type==="trueFalse" ? "" : (idx+1)+". ")+(item.q || item.text);
          block.appendChild(qText);

          if(ex.type==="trueFalse"){
            ["True","False"].forEach((labelVal,i)=>{
              const label=document.createElement("label");
              label.className="option-label";
              const radio=document.createElement("input");
              radio.type="radio";
              radio.name="q"+idx;
              radio.value= i===0 ? "true" : "false";
              label.appendChild(radio);
              label.appendChild(document.createTextNode(" "+labelVal));
              block.appendChild(label);
            });
          }else{
            item.options.forEach((opt,optIndex)=>{
              const label=document.createElement("label");
              label.className="option-label";
              const radio=document.createElement("input");
              radio.type="radio";
              radio.name="q"+idx;
              radio.value=optIndex;
              label.appendChild(radio);
              label.appendChild(document.createTextNode(" "+opt));
              block.appendChild(label);
            });
          }

          const small=document.createElement("div");
          small.className="small-note";
          small.textContent="";
          block.appendChild(small);

          exContent.appendChild(block);
        });
      }else if(ex.type==="order"){
        ex.items.forEach((item,idx)=>{
          const row=document.createElement("div");
          row.className="order-row";
          const select=document.createElement("select");
          select.dataset.correct=item.order;
          for(let n=1;n<=ex.items.length;n++){
            const opt=document.createElement("option");
            opt.value=n;
            opt.textContent=n;
            select.appendChild(opt);
          }
          const text=document.createElement("div");
          text.textContent=item.text;
          row.appendChild(select);
          row.appendChild(text);
          exContent.appendChild(row);
        });
      }
    }

    checkBtn.addEventListener("click",()=>{
      if(!currentTopic) return;
      const ex=currentTopic.exercises[currentExerciseIndex];
      let correct=0;
      let total=0;

      if(ex.type==="trueFalse" || ex.type==="mcq"){
        const blocks=[...exContent.querySelectorAll(".question-block")];
        blocks.forEach((block,idx)=>{
          block.classList.remove("correct","wrong");
          const note=block.querySelector(".small-note");
          note.textContent="";
          const inputs=[...block.querySelectorAll("input[type=radio]")];
          const chosen=inputs.find(r=>r.checked);
          total++;
          if(!chosen){
            note.textContent="Choose an answer.";
            return;
          }
          if(ex.type==="trueFalse"){
            const isTrue = chosen.value==="true";
            const expected = ex.items[idx].answer;
            if(isTrue===expected){
              correct++;
              block.classList.add("correct");
              note.textContent="Correct!";
            }else{
              block.classList.add("wrong");
              note.textContent="Wrong. Try again.";
            }
          }else{
            const value=Number(chosen.value);
            const expected=ex.items[idx].correct;
            if(value===expected){
              correct++;
              block.classList.add("correct");
              note.textContent="Correct!";
            }else{
              block.classList.add("wrong");
              note.textContent="Wrong. Try again.";
            }
          }
        });
      }else if(ex.type==="order"){
        const rows=[...exContent.querySelectorAll(".order-row")];
        rows.forEach(row=>{
          total++;
          const select=row.querySelector("select");
          const chosen=Number(select.value);
          const expected=Number(select.dataset.correct);
          if(chosen===expected){
            correct++;
            select.style.borderColor="green";
          }else{
            select.style.borderColor="red";
          }
        });
      }

      if(total===0) return;
      if(correct===total){
        exResult.textContent="Perfect: "+correct+" / "+total;
        exResult.classList.add("good");
        exResult.classList.remove("bad");
      }else{
        exResult.textContent="You got "+correct+" / "+total+". Check the red parts.";
        exResult.classList.add("bad");
        exResult.classList.remove("good");
      }
    });

    resetBtn.addEventListener("click",()=>{
      renderExercise();
    });

    /* ----- TOPIC DONE + PROGRESS ----- */
    function getUserProgress(){
      if(!currentUser) return null;
      if(currentUser.isTeacher) return teacherTempProgress;
      if(!progress[currentUser.pin]) progress[currentUser.pin]={};
      return progress[currentUser.pin];
    }

    function isTopicDone(){
      if(!currentUser || !currentTopic) return false;
      const userProg=getUserProgress();
      return !!userProg[currentTopic.id];
    }

    function toggleTopicDone(){
      if(!currentUser || !currentTopic) return;
      const userProg=getUserProgress();
      userProg[currentTopic.id]=!userProg[currentTopic.id];
      if(!currentUser.isTeacher){
        saveJson(PROGRESS_KEY,progress);
        renderJournal();
      }
      updateProgressUI();
    }
    toggleDoneBtn.addEventListener("click",toggleTopicDone);

    function updateProgressUI(){
      if(!currentUser){
        doneStatus.textContent="Not done";
        doneStatus.classList.add("off");
        progressInner.style.width="0%";
        progressText.textContent="0 / 0 topics done";
        return;
      }
      const userProg=getUserProgress();
      const total=topics.length;
      let done=0;
      topics.forEach(t=>{
        if(userProg[t.id]) done++;
      });

      if(currentTopic && userProg[currentTopic.id]){
        doneStatus.textContent=currentUser.isTeacher?"Done (Teacher only) ‚úî":"Done ‚úî";
        doneStatus.classList.remove("off");
        toggleDoneBtn.textContent="‚úñ Unmark topic";
      }else{
        doneStatus.textContent="Not done";
        doneStatus.classList.add("off");
        toggleDoneBtn.textContent="‚úî Mark topic as done";
      }
      const percent=total?(done/total)*100:0;
      progressInner.style.width=percent+"%";
      progressText.textContent=done+" / "+total+" topics done";
    }

    /* ----- JOURNAL ----- */
    function renderJournal(){
      journalBox.innerHTML="";
      const info=document.createElement("div");
      info.style.fontSize=".78rem";
      info.style.color="#6d5b4a";
      info.textContent="Journal shows how many reading topics are marked 'done' by each student PIN on this device.";
      journalBox.appendChild(info);

      const pins=Object.keys(progress)
        .map(p=>Number(p))
        .filter(p=>p!==3244) // teacher PIN –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º
        .sort((a,b)=>a-b);

      if(pins.length===0){
        const empty=document.createElement("div");
        empty.style.fontSize=".8rem";
        empty.style.marginTop="6px";
        empty.textContent="No student data yet. When students mark topics as done, you will see it here.";
        journalBox.appendChild(empty);
        return;
      }
      pins.forEach(pin=>{
        const cls=getClassByPin(pin) || "?";
        const userProg=progress[pin] || {};
        let done=0;
        for(const topicId in userProg){
          if(userProg[topicId]) done++;
        }
        const row=document.createElement("div");
        row.className="journal-row";

        const left=document.createElement("span");
        left.className="pin";
        left.textContent="PIN "+pin+" (class "+cls+")";

        const right=document.createElement("span");
        right.className="info";
        right.textContent=done+" / "+topics.length+" topics done";

        row.appendChild(left);
        row.appendChild(right);
        journalBox.appendChild(row);
      });
    }
    refreshJournalBtn.addEventListener("click",renderJournal);

    /* ----- AI BAYAN ----- */
    const AI_ENDPOINT="https://shiny-tree-f78c.aiko030500.workers.dev/";

    function getRemainingQuestionsToday(){
      if(!currentUser) return 0;
      if(currentUser.isTeacher) return 999; // no real limit
      const pin=currentUser.pin;
      const today=todayStr();
      const rec=aiUsage[pin];
      if(!rec || rec.date!==today) return 1; // 1 question per day
      const used=rec.count||0;
      return Math.max(0,1-used);
    }

    function updateAiLimitInfo(){
      if(!currentUser){
        aiLimitEl.textContent="";
        askBtn.disabled=true;
        return;
      }
      if(currentUser.isTeacher){
        aiLimitEl.textContent="Teacher mode: no AI limit today.";
        askBtn.disabled=false;
        return;
      }
      const left=getRemainingQuestionsToday();
      if(left<=0){
        aiLimitEl.textContent="Today you have used your 1 question. Come back tomorrow.";
        askBtn.disabled=true;
      }else{
        aiLimitEl.textContent="You can ask "+left+" question today.";
        askBtn.disabled=false;
      }
    }

    function appendChatMessage(role,text){
      const div=document.createElement("div");
      div.className="chat-msg "+(role==="user"?"user":"ai");
      const small=document.createElement("small");
      small.textContent=role==="user"?"You":(currentUser && currentUser.isTeacher?"AI Bayan (teacher view)":"AI Bayan");
      const p=document.createElement("div");
      p.textContent=text;
      div.appendChild(small);
      div.appendChild(p);
      chatBox.appendChild(div);
      chatBox.scrollTop=chatBox.scrollHeight;
    }

    askBtn.addEventListener("click",sendToAiBayan);
    aiQuestion.addEventListener("keydown",e=>{
      if(e.key==="Enter" && (e.ctrlKey || e.metaKey)){
        e.preventDefault();
        sendToAiBayan();
      }
    });

    function sendToAiBayan(){
      aiError.textContent="";
      if(!currentUser){
        aiError.textContent="Please login with your PIN.";
        return;
      }
      if(!currentUser.isTeacher){
        const left=getRemainingQuestionsToday();
        if(left<=0){
          aiError.textContent="Limit reached: 1 AI question per day for this PIN.";
          updateAiLimitInfo();
          return;
        }
      }
      const q=aiQuestion.value.trim();
      if(!q){
        aiError.textContent="Write a question for AI Bayan.";
        return;
      }

      appendChatMessage("user",q);
      aiQuestion.value="";
      askBtn.disabled=true;
      askBtn.textContent="Asking...";

      const payload={
        question:q,
        pin:currentUser.pin,
        cls:currentUser.cls,
        teacher:!!currentUser.isTeacher,
        section:"reading_beginner_brown",
        topic: currentTopic ? currentTopic.name : null,
        ts:new Date().toISOString()
      };

      fetch(AI_ENDPOINT,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      })
      .then(res=>res.text())
      .then(text=>{
        let answer=text;
        try{
          const obj=JSON.parse(text);
          answer=obj.answer || obj.response || obj.result || text;
        }catch(e){}
        appendChatMessage("ai",answer || "AI Bayan sent an empty answer.");
        if(!currentUser.isTeacher){
          const pin=currentUser.pin;
          const today=todayStr();
          const rec=aiUsage[pin];
          if(!rec || rec.date!==today){
            aiUsage[pin]={date:today,count:1};
          }else{
            aiUsage[pin].count=(aiUsage[pin].count||0)+1;
          }
          saveJson(AI_USAGE_KEY,aiUsage);
        }
        updateAiLimitInfo();
      })
      .catch(err=>{
        console.error(err);
        aiError.textContent="Error: cannot connect to AI Bayan now.";
      })
      .finally(()=>{
        askBtn.disabled = !currentUser ? true :
          (!currentUser.isTeacher && getRemainingQuestionsToday()<=0);
        askBtn.textContent="Ask AI Bayan";
      });
    }

    /* ----- BACK / MAIN MENU / PRINT ----- */
    backBtn.addEventListener("click",()=>{
      if(window.history.length>1){
        window.history.back();
      }else{
        window.scrollTo({top:0,behavior:"smooth"});
      }
    });

    mainMenuBtn.addEventListener("click",()=>{
      topicsList.scrollIntoView({behavior:"smooth"});
    });

    printBtn.addEventListener("click",()=>{
      window.print();
    });

    /* ----- INIT ----- */
    function init(){
      renderTopics();
      // —Ç–µ–∫—Å—Ç –¥–æ –ª–æ–≥–∏–Ω–∞ ‚Äì –∑–∞–≥–ª—É—à–∫–∞, –Ω–∞—Å—Ç–æ—è—â–µ–µ –Ω–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –ø–æ—Å–ª–µ handleLogin
    }
    init();
  </script>
</body>
</html>
